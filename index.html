<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="golangã€javaã€âš½ï¸ã€ğŸ€">
<meta property="og:type" content="website">
<meta property="og:title" content="caleb&#96;s blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="caleb&#96;s blog">
<meta property="og:description" content="golangã€javaã€âš½ï¸ã€ğŸ€">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="caleb">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>caleb`s blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="caleb`s blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">caleb`s blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä½“è‚²è¿·&ç¨‹åºå‘˜ç»¼åˆä½“</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/09/Gotests%E5%89%96%E6%9E%90%E4%B8%8E%E6%89%A9%E5%B1%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caleb">
      <meta itemprop="description" content="golangã€javaã€âš½ï¸ã€ğŸ€">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="caleb`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/09/Gotests%E5%89%96%E6%9E%90%E4%B8%8E%E6%89%A9%E5%B1%95/" class="post-title-link" itemprop="url">Gotestså‰–æä¸æ‰©å±•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-09 21:00:39 / ä¿®æ”¹æ—¶é—´ï¼š21:46:32" itemprop="dateCreated datePublished" datetime="2024-03-09T21:00:39+08:00">2024-03-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>è¯´åˆ°golangé¡¹ç›®çš„å•å…ƒæµ‹è¯•ï¼Œgotestsæ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„å¼€æºæ¡†æ¶ï¼Œå®ƒå¯ä»¥ä¸ºå‡½æ•°ç”Ÿæˆè¡¨é©±åŠ¨æµ‹è¯•ï¼Œåœ¨ç”Ÿæˆä¹‹åå†æ·»åŠ æµ‹è¯•æ•°æ®å³å¯å®Œæˆæµ‹è¯•ä»£ç çš„ç¼–å†™ã€‚æœ¬æ–‡å°±gotestsæ¡†æ¶çš„å®ç°æœºåˆ¶ä»¥åŠåœ¨å•å…ƒæµ‹è¯•ä¸­çš„æ‰©å±•å®è·µå±•å¼€ã€‚</p>
</blockquote>
<h1 id="1ã€gotestsä½¿ç”¨"><a href="#1ã€gotestsä½¿ç”¨" class="headerlink" title="1ã€gotestsä½¿ç”¨"></a>1ã€gotestsä½¿ç”¨</h1><ul>
<li>å®‰è£…ï¼š</li>
</ul>
<p>go install github.com&#x2F;cweill&#x2F;gotests&#x2F;gotests</p>
<ul>
<li>ä»£ç ç”Ÿæˆï¼š</li>
</ul>
<p>ç°æœ‰å¦‚ä¸‹ç®€å•å·¥å…·ä»£ç  swap.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> swap</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Swap exchanges s[i] and s[j].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Swap</span><span class="params">(s []<span class="keyword">interface</span>&#123;&#125;, i, j <span class="type">int</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;slice can&#x27;t be nil&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= <span class="built_in">len</span>(s)) || (j &lt; <span class="number">0</span> || j &gt;= <span class="built_in">len</span>(s)) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;illegal index&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	s[i], s[j] = s[j], s[i]</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å‘½ä»¤ï¼šgotests -all -w â€¦&#x2F;go&#x2F;src&#x2F;swap&#x2F;swap.goÂ å³å¯ç”Ÿæˆå…³äºÂ swap.goÂ æ–‡ä»¶ä¸­æ‰€æœ‰å‡½æ•°çš„è¡¨é©±åŠ¨æµ‹è¯•å½¢å¼çš„å•å…ƒæµ‹è¯•ï¼ŒåŒ…å«åœ¨ä¸Â swap.goÂ åŒç›®å½•ä¸‹çš„Â swap_test.goÂ æ–‡ä»¶ä¸­ï¼Œåœ¨Â TODOÂ ä¸­æ·»åŠ æµ‹è¯•æ•°æ®å³å¯å®Œæˆå‡½æ•°çš„å•å…ƒæµ‹è¯•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> swap</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSwap</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">		s []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">		i <span class="type">int</span></span><br><span class="line">		j <span class="type">int</span></span><br><span class="line">	&#125;</span><br><span class="line">	tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">		name    <span class="type">string</span></span><br><span class="line">		args    args</span><br><span class="line">		wantErr <span class="type">bool</span></span><br><span class="line">	&#125;&#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> Add test cases.</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">		t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := Swap(tt.args.s, tt.args.i, tt.args.j); (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">				t.Errorf(<span class="string">&quot;Swap() error = %v, wantErr %v&quot;</span>, err, tt.wantErr)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå‡½æ•°ä¸­çš„å®ç°éƒ½æ˜¯åŸºäºgoåŸç”Ÿçš„æ–¹æ³•å®ç°ï¼Œä½†æ˜¯åœ¨ä¸šåŠ¡ä»£ç ä¸­å……æ»¡äº†å„ç§å¤–éƒ¨ä¾èµ–ï¼ˆRPCæ¥å£ã€Redisã€DBæŸ¥è¯¢ç­‰ï¼‰ï¼Œæœ€åŸºç¡€çš„ä¸šåŠ¡ä»£ç ç»“æ„ä¸ºï¼šController -&gt; Service -&gt; Dao ï¼Œå¦‚æŸserviceä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> testdata</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">struct</span> &#123;</span><br><span class="line">	PersonService *service.PersonService <span class="string">`wired:&quot;true&quot;`</span></span><br><span class="line">	PersonDao     *dao.PersonDao         <span class="string">`wired:&quot;true&quot;`</span></span><br><span class="line">	Calculator    *Calculator            <span class="string">`wired:&quot;true&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserService)</span></span> GetUserInfo(id <span class="type">int</span>, name <span class="type">string</span>) (*model.UserInfo, <span class="type">error</span>) &#123;</span><br><span class="line">	userInfo := &amp;model.UserInfo&#123;</span><br><span class="line">		Id:  id * <span class="number">100</span>,</span><br><span class="line">		Age: id * <span class="number">10</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	person, err := u.PersonService.GetPersonInfo(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	userInfo.Name = person.FirstName + <span class="string">&quot;-&quot;</span> + name</span><br><span class="line">	<span class="keyword">switch</span> id &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		userInfo.Address = <span class="string">&quot;LAC&quot;</span></span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		userInfo.Address = <span class="string">&quot;LAL&quot;</span></span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		userInfo.Address = <span class="string">&quot;PHX&quot;</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		userInfo.Address = <span class="string">&quot;OKC&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	subInfo := u.getSubInfo(id)</span><br><span class="line">	userInfo.Address = subInfo + <span class="string">&quot;-&quot;</span> + userInfo.Address</span><br><span class="line">	<span class="keyword">return</span> userInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserService)</span></span> getSubInfo(id <span class="type">int</span>) <span class="type">string</span> &#123;</span><br><span class="line">	info := u.PersonDao.GetInfoByCondition(id)</span><br><span class="line">	<span class="keyword">return</span> info + <span class="string">&quot;_subInfo&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ä½¿ç”¨gotestsåŸç”Ÿå‘½ä»¤ä¹Ÿå¯ä»¥ç”Ÿæˆå‡ºå¦‚ä¸‹çš„å•å…ƒæµ‹è¯•å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserService_GetUserInfo</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="keyword">type</span> fields <span class="keyword">struct</span> &#123;</span><br><span class="line">		PersonService *service.PersonService</span><br><span class="line">		PersonDao     *dao.PersonDao</span><br><span class="line">		Calculator    *Calculator</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">		id   <span class="type">int</span></span><br><span class="line">		name <span class="type">string</span></span><br><span class="line">	&#125;</span><br><span class="line">	tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">		name    <span class="type">string</span></span><br><span class="line">		fields  fields</span><br><span class="line">		args    args</span><br><span class="line">		want    *model.UserInfo</span><br><span class="line">		wantErr <span class="type">bool</span></span><br><span class="line">	&#125;&#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> Add test cases.</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">		t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">			u := &amp;UserService&#123;</span><br><span class="line">				PersonService: tt.fields.PersonService,</span><br><span class="line">				PersonDao:     tt.fields.PersonDao,</span><br><span class="line">				Calculator:    tt.fields.Calculator,</span><br><span class="line">			&#125;</span><br><span class="line">			got, err := u.GetUserInfo(tt.args.id, tt.args.name)</span><br><span class="line">			<span class="keyword">if</span> (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">				t.Errorf(<span class="string">&quot;GetUserInfo() error = %v, wantErr %v&quot;</span>, err, tt.wantErr)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !reflect.DeepEqual(got, tt.want) &#123;</span><br><span class="line">				t.Errorf(<span class="string">&quot;GetUserInfo() got = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°gotestsä¾ç„¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠä¾èµ–çš„å¤–éƒ¨ç»“æ„ä½“ç”Ÿæˆå‡ºæ¥ï¼Œå¹¶ä¸”åˆ›å»ºç»Ÿä¸€çš„å¼•ç”¨ã€‚ä½†æ˜¯å½“æˆ‘ä»¬åœ¨å†™ç±»ä¼¼å¦‚ä¸Šçš„ä¸šåŠ¡ä»£ç çš„å‡½æ•°å•å…ƒæµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œå¯¹äºå¤–éƒ¨ä¾èµ–çš„Serviceã€Daoå‡½æ•°ä¸€èˆ¬ä¼šé‡‡ç”¨mockçš„æ–¹å¼å¤„ç†ï¼ˆæ­¤å¤„ä¸è®¨è®ºè¯¥é€‰ç”¨å“ªç§mockæ–¹å¼ï¼Œå› ä¸ºä¸åŒæ–¹å¼å¯¹äºé¡¹ç›®ä»£ç çš„æ•´ä½“ç»“æ„è¦æ±‚ä¸åŒï¼‰ï¼Œæ­¤æ—¶åœ¨ç”Ÿæˆå‡ºæ¥çš„å•æµ‹çš„ TODO ä¸­å°±ä¸å…‰æ˜¯å¡«å……å‚æ•°ä¸è¿”å›å€¼é‚£ä¹ˆç®€å•äº†ï¼Œå¿…é¡»è€ƒè™‘åˆ°å¦‚ä½•è®©åœ¨æ¯ä¸ªç”¨ä¾‹ä¸­æ¤å…¥mockã€‚</p>
<p>è¿™ä¹ˆçœ‹æ¥ï¼Œå¥½åƒgotestså¸®åŠ©æˆ‘ä»¬åšäº†å¾ˆå¤šï¼Œä½†æ˜¯åˆå¥½åƒä¸æ˜¯å¾ˆå¤Ÿï¼Ÿå¸¦ç€è¿™ä¸ªé—®é¢˜å…ˆæ¥çœ‹ä¸‹gotestsçš„å®ç°æœºåˆ¶ï¼Œå¯èƒ½æ…¢æ…¢å°±æœ‰äº†æ€è·¯ã€‚</p>
<h1 id="2ã€ASTæœºåˆ¶"><a href="#2ã€ASTæœºåˆ¶" class="headerlink" title="2ã€ASTæœºåˆ¶"></a>2ã€ASTæœºåˆ¶</h1><p>gotestsçš„æ ¸å¿ƒåŸç†ä¹‹ä¸€æ˜¯åŸºäº <span style="color: red;">ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰</span>è§£æç›®æ ‡goæ–‡ä»¶ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>è¯»å–å‘½ä»¤è¡Œä¸ç¯å¢ƒå˜é‡ä¸­çš„å‚æ•°è®¾ç½®</li>
<li>æ ¹æ®æŒ‡å®šçš„ ç›®å½•&#x2F;æ–‡ä»¶ å¼‚æ­¥åç¨‹é€šè¿‡astè§£æå‡ºåŸå§‹ *ast.File</li>
<li>é€šè¿‡ *ast.File è§£æå‡ºæ–‡ä»¶å…¬å…±éƒ¨åˆ†ï¼šæ³¨é‡Šã€åŒ…è·¯å¾„ã€å¼•ç”¨è·¯å¾„</li>
<li>é€šè¿‡ *ast.File è§£æå‡ºæ–‡ä»¶ä¸­å‡½æ•°éƒ¨åˆ†ï¼šå‡½æ•°åç§°ã€å‚æ•°ã€è¿”å›å€¼ç­‰</li>
<li>è¿”å›æ•´ä½“çš„Resultç»“æ„ä¾›æ¨¡ç‰ˆè§£æ</li>
</ul>
<p>AST ä¸­åŒ…å«å¾ˆå¤šå…ƒç´ ï¼Œåœ¨gotestsä¸­ä¸»è¦å¼•ç”¨åˆ°äº†ä»¥ä¸‹å‡ ä¸ªASTå…ƒç´ ã€‚</p>
<p>(1) TOKEN<br>ç¼–ç¨‹è¯­è¨€ä¸­æœ€å°çš„å…·æœ‰ç‹¬ç«‹å«ä¹‰çš„è¯æ³•å•å…ƒï¼Œä¸ä»…åŒ…å«å…³é”®å­—ï¼Œè¿˜åŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„æ ‡è¯†ç¬¦ã€è¿ç®—ç¬¦ã€åˆ†éš”ç¬¦å’Œæ³¨é‡Šç­‰<br><img src="/../images/32.png" alt="32.png"></p>
<p>(2) åŸºç¡€è¡¨è¾¾å¼<br>æ˜¯å®Œå…¨ç”±æ•°å€¼å‹é¢å€¼å’Œæ ‡è¯†ç¬¦ç»„æˆçš„è¡¨è¾¾å¼ï¼Œä¸»è¦æ˜¯æŒ‡ç”±ä¸€å…ƒå’ŒäºŒå…ƒè¿ç®—ç¬¦ç»„æˆçš„è¡¨è¾¾å¼ï¼Œè¿ç®—çš„ä¸»é¢˜æ˜¯å„ç§é¢å€¼æˆ–æ ‡è¯†ç¬¦ï¼ŒåŸºç¡€è¡¨è¾¾å¼è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Expression = UnaryExpr | Expression binary_op Expression .</span><br><span class="line">UnaryExpr  = Operand | unary_op UnaryExpr .</span><br><span class="line">Operand    = Literal | identifier | <span class="string">&quot;(&quot;</span> Expression <span class="string">&quot;)&quot;</span> .</span><br><span class="line"></span><br><span class="line">binary_op  = <span class="string">&quot;||&quot;</span> | <span class="string">&quot;&amp;&amp;&quot;</span> | rel_op | add_op | mul_op .</span><br><span class="line">rel_op     = <span class="string">&quot;==&quot;</span> | <span class="string">&quot;!=&quot;</span> | <span class="string">&quot;&lt;&quot;</span> | <span class="string">&quot;&lt;=&quot;</span> | <span class="string">&quot;&gt;&quot;</span> | <span class="string">&quot;&gt;=&quot;</span> .</span><br><span class="line">add_op     = <span class="string">&quot;+&quot;</span> | <span class="string">&quot;-&quot;</span> | <span class="string">&quot;|&quot;</span> | <span class="string">&quot;^&quot;</span> .</span><br><span class="line">mul_op     = <span class="string">&quot;*&quot;</span> | <span class="string">&quot;/&quot;</span> | <span class="string">&quot;%&quot;</span> | <span class="string">&quot;&lt;&lt;&quot;</span> | <span class="string">&quot;&gt;&gt;&quot;</span> | <span class="string">&quot;&amp;&quot;</span> | <span class="string">&quot;&amp;^&quot;</span> .</span><br><span class="line"></span><br><span class="line">unary_op   = <span class="string">&quot;+&quot;</span> | <span class="string">&quot;-&quot;</span> | <span class="string">&quot;!&quot;</span> | <span class="string">&quot;^&quot;</span> | <span class="string">&quot;*&quot;</span> | <span class="string">&quot;&amp;&quot;</span> | <span class="string">&quot;&lt;-&quot;</span> .</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åˆ†æ go&#x2F;ast åŒ…çš„æ–‡æ¡£ï¼Œå¯ä»¥å‘ç°å¾ˆå¤šç±»å‹ä»¥ Expr ä¸ºåç¼€åçš„ç»“æ„ä½“ï¼Œè¿™æ˜¯astä¸­çš„è¡¨è¾¾å¼æ‰¿è½½å½¢å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BadExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> BinaryExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> CallExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> Expr <span class="keyword">interface</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> ExprStmt <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> IndexExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> KeyValueExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> ParenExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> SelectorExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> SliceExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> StarExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> TypeAssertExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> UnaryExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>(3) ä»£ç ç»“æ„<br>ä¸€ä¸ªgoæ–‡ä»¶ä¸­ï¼Œé¡¶çº§çš„è¯­æ³•å…ƒç´ æœ‰ï¼špackageã€importã€typeã€constã€varå’Œfuncè¿™å‡ ç§ï¼Œå¯¹åº”çš„ç»“æ„å¦‚ä¸‹ï¼š<br><img src="/../images/33.png" alt="33.png"></p>
<p>(4) å‡½æ•°å£°æ˜<br>å‡½æ•°çš„å£°æ˜å¯¹åº” *ast.FuncDecl ç±»å‹ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FuncDecl <span class="keyword">struct</span> &#123;</span><br><span class="line">	Doc  *CommentGroup <span class="comment">// associated documentation; or nil</span></span><br><span class="line">	Recv *FieldList    <span class="comment">// receiver (methods); or nil (functions)</span></span><br><span class="line">	Name *Ident        <span class="comment">// function/method name</span></span><br><span class="line">	Type *FuncType     <span class="comment">// function signature: parameters, results, and position of &quot;func&quot; keyword</span></span><br><span class="line">	Body *BlockStmt    <span class="comment">// function body; or nil for external (non-Go) function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ç°åœ¨æœ‰å¦‚ä¸‹å‡½æ•°å£°æ˜ï¼Œå¯¹åº”astè§£æçš„ç»“æ„ä¸ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *xType)</span></span> Hello(arg1, arg2 <span class="type">int</span>) (<span class="type">bool</span>, <span class="type">error</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/../images/34.png" alt="34.png"></p>
<p>(5) è¯­å¥å’Œè¯­å¥å—<br>è¯­å¥å—å’Œè¯­å¥æ—¶åœ¨å‡½æ•°ä½“éƒ¨åˆ†å®šä¹‰ï¼Œå‡½æ•°ä½“å°±æ˜¯ä¸€ä¸ªè¯­å¥å—ï¼ˆå¦‚ä¸Šè¿°å‡½æ•°å£°æ˜ä¸­çš„ <span style="color: red;">ast.BlockStmt</span>ï¼‰ã€‚ä¸»è¦åŒ…æ‹¬ï¼šè¡¨è¾¾å¼è¯­å¥ã€è¿”å›è¯­å¥ã€å£°æ˜è¯­å¥ã€åˆ†æ”¯è¯­å¥ã€ç±»å‹æ–­è¨€ç­‰ã€‚è¯­å¥å—çš„è¯­æ³•è§„èŒƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FunctionBody  = Block .</span><br><span class="line"></span><br><span class="line">Block         = <span class="string">&quot;&#123;&quot;</span> StatementList <span class="string">&quot;&#125;&quot;</span> .</span><br><span class="line">StatementList = &#123; Statement <span class="string">&quot;;&quot;</span> &#125; .</span><br><span class="line"></span><br><span class="line">Statement     = Declaration | LabeledStmt | SimpleStmt</span><br><span class="line">              | GoStmt | ReturnStmt | BreakStmt | ContinueStmt | GotoStmt</span><br><span class="line">              | FallthroughStmt | Block | IfStmt | SwitchStmt | SelectStmt | ForStmt</span><br><span class="line">              | DeferStmt</span><br><span class="line">              .</span><br></pre></td></tr></table></figure>
<p>ä»‹ç»å®Œä¸Šé¢çš„æŠ½è±¡çš„æ¦‚å¿µä¹‹åï¼Œçœ‹ä¸€ä¸‹å¦‚æœå°† 1 ä¸­çš„ service é€šè¿‡astè§£æä¹‹ååº”è¯¥æ˜¯åŒ…å«å“ªäº›å†…å®¹ï¼ˆæ–‡ä»¶å†…å®¹è¿‡é•¿ï¼Œæ­¤å¤„ç›´æ¥æŒ‚æ–‡ä»¶ï¼‰ï¼š<br><img src="/../images/ast%E8%A7%A3%E6%9E%90%E6%96%87%E4%BB%B6.docx" alt="ast.docx"></p>
<p>ä¸ä¸Šè¿°astå…ƒç´ å…³è”å¯ä»¥é‡ç‚¹å…³æ³¨æ–‡æ¡£ä¸­çº¢è‰²æ ‡è¯†éƒ¨åˆ†æˆ–ä»¥ä¸‹å…³é”®å­—éƒ¨åˆ†ï¼š</p>
<p>ç»“æ„ä½“å®šä¹‰ï¼ˆ*ast.GenDecl ï¼‰- 39è¡Œ</p>
<p>å‡½æ•°å®šä¹‰ï¼ˆ*ast.FuncDecl ï¼‰-156è¡Œ</p>
<p>å‡½æ•°ä½“è¯­å¥å—ï¼ˆBody: *ast.BlockStmt ï¼‰- 258è¡Œ</p>
<p>ä¾èµ–å‡½æ•°å¼•ç”¨ï¼ˆ*ast.CallExpr ï¼‰- 365è¡Œ</p>
<p>ç§æœ‰å‡½æ•°å¼•ç”¨ï¼ˆ*ast.CallExpr ï¼‰-650è¡Œ</p>
<p>è¿”å›è¯­å¥å—ï¼ˆ*ast.ReturnStmt ï¼‰-723è¡Œ</p>
<p>åœ¨gotestsä¸­ä¾¿æ˜¯é€šè¿‡astè§£æå‡ºgoæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶é€šè¿‡ä¸€ç³»åˆ—çš„è¯æ³•å’Œè¯­æ³•åˆ†æå°†æŠ½å–å‡ºç”Ÿæˆå•å…ƒæµ‹è¯•ç”¨ä¾‹æ‰€éœ€çš„å„ç§å…ƒç´ ã€‚</p>
<h1 id="3ã€æ¨¡ç‰ˆæ¸²æŸ“"><a href="#3ã€æ¨¡ç‰ˆæ¸²æŸ“" class="headerlink" title="3ã€æ¨¡ç‰ˆæ¸²æŸ“"></a>3ã€æ¨¡ç‰ˆæ¸²æŸ“</h1><p>golang çš„ text&#x2F;template åŒ…æ˜¯ä¸€ä¸ªæ•°æ®é©±åŠ¨çš„æ¨¡ç‰ˆæ¸²æŸ“å·¥å…·ã€‚æä¾›æ¡ä»¶åˆ¤æ–­ã€æ•°ç»„æˆ–mapéå†ã€å‚æ•°èµ‹å€¼ã€å‡½æ•°æˆ–æ–¹æ³•è°ƒç”¨ã€è‡ªå®šä¹‰å‡½æ•°æ‰©å±•ã€æ¨¡ç‰ˆåµŒå¥—åŠé‡ç”¨ç­‰åŠŸèƒ½ã€‚åŸºäºè¯¥å·¥å…·ï¼Œå¯ä»¥è½»æ¾å®ç°å„ç§å¤æ‚åœºæ™¯çš„æ–‡æœ¬æ¸²æŸ“å’Œæ–‡ä»¶åˆ›å»ºã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œæ¨¡ç‰ˆä½¿ç”¨æµç¨‹åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šå®šä¹‰æ¨¡ç‰ˆã€è§£ææ¨¡ç‰ˆã€æ•°æ®æ¸²æŸ“æ¨¡ç‰ˆã€‚ç®€å•æ¥è®²ï¼Œä¸»è¦æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li><p>template.New</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(name <span class="type">string</span>)</span></span> *Template</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºåä¸ºï¼šnameçš„æ¨¡ç‰ˆ</p>
</li>
<li><p>template.Parse</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Template)</span></span> Parse(text <span class="type">string</span>) (*Template, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>
<p>å°†å­—ç¬¦ä¸²testå†…å®¹è§£æä¸ºæ¨¡ç‰ˆï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//æ¨¡æ¿å˜é‡</span></span><br><span class="line">    <span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">        Id   <span class="type">int</span></span><br><span class="line">        Name <span class="type">string</span></span><br><span class="line">    &#125;</span><br><span class="line">    user := User&#123;<span class="number">100</span>, <span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºæ¨¡æ¿</span></span><br><span class="line">    tplname := <span class="string">&quot;user&quot;</span></span><br><span class="line">    tmpl := template.New(tplname)</span><br><span class="line">    <span class="comment">//è§£ææ¨¡æ¿</span></span><br><span class="line">    text := <span class="string">&quot;id = &#123;&#123;.Id&#125;&#125; name = &#123;&#123;.Name&#125;&#125;&quot;</span></span><br><span class="line">    tpl, err := tmpl.Parse(text)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ¸²æŸ“è¾“å‡º</span></span><br><span class="line">    err = tpl.Execute(os.Stdout, user)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">==========================================</span><br><span class="line">id = <span class="number">100</span> name = admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>template.ParseFiles<br>æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²çš„å†…å®¹æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆæ–‡ä»¶çš„è·¯å¾„ï¼Œå¹¶è§£æè¯¥æ¨¡ç‰ˆæ–‡ä»¶</p>
</li>
<li><p>template.Execute</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Template)</span></span> Execute(wr io.Writer, data <span class="keyword">interface</span>&#123;&#125;) (err <span class="type">error</span>)</span><br></pre></td></tr></table></figure>
<p>å°†è§£æå¥½çš„æ¨¡ç‰ˆåº”ç”¨åˆ°dataï¼Œå¹¶å°†è¾“å‡ºå†™å…¥wrã€‚æ¨¡ç‰ˆå¯ä»¥å®‰å…¨çš„å¹¶å‘æ‰§è¡Œã€‚<br>åœ¨gotestsæ¡†æ¶ä¸­ä¾¿æ˜¯å…ˆå°†å·²å®šä¹‰å¥½çš„æ¨¡ç‰ˆæ–‡ä»¶å†…å®¹å‹ç¼©ï¼ˆæå‡åˆ›å»ºæ–‡ä»¶çš„æ•ˆç‡ï¼‰ï¼Œç„¶åå°†é€šè¿‡astè§£æåçš„ç»“æœï¼Œè¾“å‡ºåˆ°å·²å®šä¹‰å¥½çš„æ¨¡ç‰ˆå†…å®¹ä¸­ï¼Œé€šè¿‡æ¨¡ç‰ˆå¼•æ“åˆ›å»ºå‡ºä¸åŒgoæ–‡ä»¶å¯¹åº”çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚<br><img src="/../images/35.png" alt="35.png"><br>æ ¸å¿ƒçš„æ¨¡ç‰ˆæ–‡ä»¶function.tmpl æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;define <span class="string">&quot;function&quot;</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- $f := .&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span></span> &#123;&#123;.TestName&#125;&#125;(t *testing.T) &#123;</span><br><span class="line">	&#123;&#123;- with .Receiver&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> .IsStruct&#125;&#125;</span><br><span class="line">			&#123;&#123;- <span class="keyword">if</span> .Fields&#125;&#125;</span><br><span class="line">				<span class="keyword">type</span> fields <span class="keyword">struct</span> &#123;</span><br><span class="line">				&#123;&#123;- <span class="keyword">range</span> .Fields&#125;&#125;</span><br><span class="line">					&#123;&#123;Field .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">				&#123;&#123;- end&#125;&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">	&#123;&#123;- end&#125;&#125;</span><br><span class="line">	&#123;&#123;- <span class="keyword">if</span> .TestParameters&#125;&#125;</span><br><span class="line">	<span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">		&#123;&#123;- <span class="keyword">range</span> .TestParameters&#125;&#125;</span><br><span class="line">				&#123;&#123;Param .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	&#123;&#123;- end&#125;&#125;</span><br><span class="line">	tests := &#123;&#123; <span class="keyword">if</span> .Named&#125;&#125;<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">struct</span>&#123;&#123;<span class="keyword">else</span>&#125;&#125;[]<span class="keyword">struct</span>&#123;&#123;end&#125;&#125; &#123;</span><br><span class="line">		&#123;&#123; <span class="keyword">if</span> (not .Named)&#125;&#125;name <span class="type">string</span>&#123;&#123;end&#125;&#125;</span><br><span class="line">		&#123;&#123;- with .Receiver&#125;&#125;</span><br><span class="line">			&#123;&#123;- <span class="keyword">if</span> and .IsStruct .Fields&#125;&#125;</span><br><span class="line">				fields fields</span><br><span class="line">			&#123;&#123;- <span class="keyword">else</span>&#125;&#125;</span><br><span class="line">				&#123;&#123;Receiver .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> .TestParameters&#125;&#125;</span><br><span class="line">			args args</span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">range</span> .TestResults&#125;&#125;</span><br><span class="line">			&#123;&#123;Want .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> .ReturnsError&#125;&#125;</span><br><span class="line">			wantErr <span class="type">bool</span></span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">	&#125;&#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> Add test cases.  base</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;&#123;<span class="keyword">if</span> (or .Subtests (not .IsNaked))&#125;&#125; &#123;&#123;<span class="keyword">if</span> .Named&#125;&#125;name&#123;&#123;<span class="keyword">else</span>&#125;&#125;_&#123;&#123;end&#125;&#125;, tt := &#123;&#123;end&#125;&#125; <span class="keyword">range</span> tests &#123;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> .Subtests&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> .Parallel&#125;&#125;tt := tt;&#123;&#123;end&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> and .Parallel .Named&#125;&#125;name := name;&#123;&#123; end &#125;&#125;</span><br><span class="line">		t.Run(&#123;&#123;<span class="keyword">if</span> .Named&#125;&#125;name&#123;&#123;<span class="keyword">else</span>&#125;&#125;tt.name&#123;&#123;end&#125;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">			&#123;&#123;- <span class="keyword">if</span> .Parallel&#125;&#125;t.Parallel()&#123;&#123;end&#125;&#125;</span><br><span class="line">		&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- with .Receiver&#125;&#125;</span><br><span class="line">				&#123;&#123;- <span class="keyword">if</span> .IsStruct&#125;&#125;</span><br><span class="line">					&#123;&#123;Receiver .&#125;&#125; := &#123;&#123;<span class="keyword">if</span> .Type.IsStar&#125;&#125;&amp;&#123;&#123;end&#125;&#125;&#123;&#123;.Type.Value&#125;&#125;&#123;</span><br><span class="line">					&#123;&#123;- <span class="keyword">range</span> .Fields&#125;&#125;</span><br><span class="line">						&#123;&#123;.Name&#125;&#125;: tt.fields.&#123;&#123;Field .&#125;&#125;,</span><br><span class="line">					&#123;&#123;- end&#125;&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- <span class="keyword">range</span> .Parameters&#125;&#125;</span><br><span class="line">				&#123;&#123;- <span class="keyword">if</span> .IsWriter&#125;&#125;</span><br><span class="line">					&#123;&#123;Param .&#125;&#125; := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">				&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- <span class="keyword">if</span> and (not .OnlyReturnsError) (not .OnlyReturnsOneValue) &#125;&#125;</span><br><span class="line">				&#123;&#123;template <span class="string">&quot;results&quot;</span> $f&#125;&#125; &#123;&#123;template <span class="string">&quot;call&quot;</span> $f&#125;&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- <span class="keyword">if</span> .ReturnsError&#125;&#125;</span><br><span class="line">				<span class="keyword">if</span> &#123;&#123;<span class="keyword">if</span> .OnlyReturnsError&#125;&#125; err := &#123;&#123;template <span class="string">&quot;call&quot;</span> $f&#125;&#125;; &#123;&#123;end&#125;&#125; (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">					t.Errorf(<span class="string">&quot;&#123;&#123;template &quot;</span>message<span class="string">&quot; $f&#125;&#125; error = %v, wantErr %v&quot;</span>, &#123;&#123;template <span class="string">&quot;inputs&quot;</span> $f&#125;&#125; err, tt.wantErr)</span><br><span class="line">					&#123;&#123;- <span class="keyword">if</span> .TestResults&#125;&#125;</span><br><span class="line">						&#123;&#123;<span class="keyword">if</span> .Subtests &#125;&#125;<span class="keyword">return</span>&#123;&#123;<span class="keyword">else</span>&#125;&#125;<span class="keyword">continue</span>&#123;&#123;end&#125;&#125;</span><br><span class="line">					&#123;&#123;- end&#125;&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">			&#123;&#123;- <span class="keyword">range</span> .TestResults&#125;&#125;</span><br><span class="line">				&#123;&#123;- <span class="keyword">if</span> .IsWriter&#125;&#125;</span><br><span class="line">					<span class="keyword">if</span> &#123;&#123;Got .&#125;&#125; := &#123;&#123;Param .&#125;&#125;.String(); &#123;&#123;Got .&#125;&#125; != tt.&#123;&#123;Want .&#125;&#125; &#123;</span><br><span class="line">				&#123;&#123;- <span class="keyword">else</span> <span class="keyword">if</span> .IsBasicType&#125;&#125;</span><br><span class="line">					<span class="keyword">if</span> &#123;&#123;<span class="keyword">if</span> $f.OnlyReturnsOneValue&#125;&#125;&#123;&#123;Got .&#125;&#125; := &#123;&#123;template <span class="string">&quot;inline&quot;</span> $f&#125;&#125;; &#123;&#123;end&#125;&#125; &#123;&#123;Got .&#125;&#125; != tt.&#123;&#123;Want .&#125;&#125; &#123;</span><br><span class="line">				&#123;&#123;- <span class="keyword">else</span>&#125;&#125;</span><br><span class="line">					<span class="keyword">if</span> &#123;&#123;<span class="keyword">if</span> $f.OnlyReturnsOneValue&#125;&#125;&#123;&#123;Got .&#125;&#125; := &#123;&#123;template <span class="string">&quot;inline&quot;</span> $f&#125;&#125;; &#123;&#123;end&#125;&#125; !reflect.DeepEqual(&#123;&#123;Got .&#125;&#125;, tt.&#123;&#123;Want .&#125;&#125;) &#123;</span><br><span class="line">				&#123;&#123;- end&#125;&#125;</span><br><span class="line">				t.Errorf(<span class="string">&quot;&#123;&#123;template &quot;</span>message<span class="string">&quot; $f&#125;&#125; &#123;&#123;if $f.ReturnsMultiple&#125;&#125;&#123;&#123;Got .&#125;&#125; &#123;&#123;end&#125;&#125;= %v, want %v&quot;</span>, &#123;&#123;template <span class="string">&quot;inputs&quot;</span> $f&#125;&#125; &#123;&#123;Got .&#125;&#125;, tt.&#123;&#123;Want .&#125;&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#123;&#123;- end&#125;&#125;</span><br><span class="line">		&#123;&#123;- <span class="keyword">if</span> .Subtests &#125;&#125; &#125;) &#123;&#123;- end -&#125;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>äº†è§£å®Œgotestsä¸­ä»¥ä¸Šä¸¤ä¸ªæ ¸å¿ƒå†…å®¹ä¹‹åå¯ä»¥ç®€å•æ¦‚æ‹¬å‡ºï¼Œè¯¥æ¡†æ¶çš„æ•´ä½“çš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š<br><img src="/../images/36.png" alt="36.png"><br>æ¥ä¸‹æ¥å›åˆ°ä¸Šé¢æŠ›å‡ºçš„é—®é¢˜ï¼Œåœ¨è¿™ä¸ªæµç¨‹ä¹‹ä¸­å…¶å®æˆ‘ä»¬å¯ä»¥ç®€å•æ‰©å±•ä¸€ä¸‹ã€‚</p>
</li>
</ul>
<h1 id="4ã€æ‰©å±•"><a href="#4ã€æ‰©å±•" class="headerlink" title="4ã€æ‰©å±•"></a>4ã€æ‰©å±•</h1><p>gotestsæœ¬èº«å…¶å®å¯æ‰©å±•æ€§è¿˜æ˜¯æŒºé«˜çš„ï¼Œå®ƒè‡ªèº«æä¾›å¾ˆå¤šåˆå§‹åŒ–å‘½ä»¤å¯ä»¥ç»™æˆ‘ä»¬ä¸åŒåœºæ™¯ä¸‹çš„å•æµ‹æä¾›è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶æºç ä¸­ä¹Ÿæ‰©å±•äº†åŸºäºtestifyçš„å•æµ‹æ¨¡ç‰ˆï¼Œåªéœ€è¦é€šè¿‡åˆå§‹åŒ–å‘½ä»¤ template æŒ‡å®šå³å¯ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">-all                  generate tests <span class="keyword">for</span> all functions and methods</span><br><span class="line"></span><br><span class="line">-excl                 regexp. generate tests <span class="keyword">for</span> functions and methods that don<span class="string">&#x27;t</span></span><br><span class="line"><span class="string">                       match. Takes precedence over -only, -exported, and -all</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-exported             generate tests for exported functions and methods. Takes</span></span><br><span class="line"><span class="string">                       precedence over -only and -all</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-i                    print test inputs in error messages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-only                 regexp. generate tests for functions and methods that match only.</span></span><br><span class="line"><span class="string">                       Takes precedence over -all</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-nosubtests           disable subtest generation when &gt;= Go 1.7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-parallel             enable parallel subtest generation when &gt;= Go 1.7.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-w                    write output to (test) files instead of stdout</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template_dir         Path to a directory containing custom test code templates. Takes</span></span><br><span class="line"><span class="string">                       precedence over -template. This can also be set via environment</span></span><br><span class="line"><span class="string">                       variable GOTESTS_TEMPLATE_DIR</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template             Specify custom test code templates, e.g. testify. This can also</span></span><br><span class="line"><span class="string">                       be set via environment variable GOTESTS_TEMPLATE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template_params_file read external parameters to template by json with file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template_params      read external parameters to template by json with stdin</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ template_dir ä¾¿æ˜¯å¯ä»¥è‡ªå®šä¹‰æŒ‡å®šæ¨¡ç‰ˆçš„è·¯å¾„ï¼Œtemplate_params å¯ä»¥å‘æ¨¡ç‰ˆæ–‡ä»¶ä¸­è¾“å…¥è‡ªå®šä¹‰çš„å†…å®¹ã€‚è¿™ä¹ˆä¸€çœ‹æ˜¯ä¸æ˜¯æ¸æ¸æœ‰æ€è·¯äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®åŸå§‹çš„æ¨¡ç‰ˆæ–‡ä»¶åšä¸€äº›ä¿®æ”¹ï¼Œæ»¡è¶³ä¸åŒé¡¹ç›®ä¸­çš„ä»£ç ç‰¹æ€§æ¥ç”Ÿæˆå•å…ƒæµ‹è¯•æ–‡ä»¶ã€‚</p>
<ul>
<li>å‡½æ•°ä½“è§£æ<br>é€šè¿‡å¯¹gotestsæ¡†æ¶çš„äº†è§£å‘ç°ï¼Œå®ƒå¹¶æ²¡æœ‰å¯¹å‡½æ•°ä½“å†…éƒ¨çš„å†…å®¹è¿›è¡Œè§£æï¼Œè¿™ä¾¿æ˜¯ä¸Šè¿°é—®é¢˜è¯´çš„å½“ä¸šåŠ¡ä»£ç é‡åˆ°çš„å¤–éƒ¨ä¾èµ–çš„å‡½æ•°è°ƒç”¨æ—¶å¦‚ä½•è¿›è¡Œmockã€‚è¦çŸ¥é“å¦‚ä½•mockè‚¯å®šéœ€è¦é¦–å…ˆçŸ¥é“å“ªäº›éƒ¨åˆ†éœ€è¦è¿›è¡Œmockï¼Œå¹¶ä¸”mockçš„å†…å®¹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</li>
</ul>
<p>ä¸Šè¿°æµç¨‹è¯´åˆ°gotestsæœ‰ä¸€éƒ¨åˆ†å‡½æ•°è§£æçš„æ­¥éª¤ï¼Œåœ¨è¿™ä¸ªç¯èŠ‚ä¸­å¯ä»¥åŠ å…¥å¯¹å‡½æ•°ä½“çš„è§£æï¼Œåˆ†æå‡ºå¤–éƒ¨è°ƒç”¨ã€‚åœ¨ go&#x2F;ast ä¸­æä¾› Inspect å‡½æ•°å¯å¯¹æŒ‡å®šç±»å‹ä¸­çš„å†…å®¹æŒ‰ç…§æ·±åº¦ä¼˜å…ˆæ£€ç´¢æ–¹æ³•ï¼ˆdepth-first orderï¼‰éå†è¯­æ³•æ ‘ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤–éƒ¨è°ƒç”¨å³å¯ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inspect traverses an AST in depth-first order: It starts by calling</span></span><br><span class="line"><span class="comment">// f(node); node must not be nil. If f returns true, Inspect invokes f</span></span><br><span class="line"><span class="comment">// recursively for each of the non-nil children of node, followed by a</span></span><br><span class="line"><span class="comment">// call of f(nil).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Inspect</span><span class="params">(node Node, f <span class="keyword">func</span>(Node)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">	Walk(inspector(f), node)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å¯¹astä¸­çš„å…ƒç´ å®šä¹‰äº†è§£åˆ°ï¼Œ*ast.CallExpr ä¸ºå‡½æ•°è°ƒç”¨çš„èŠ‚ç‚¹å…ƒç´ ï¼Œæ‰€ä»¥è§£æå‡½æ•°ä½“çš„ä¸»ä½“é€»è¾‘å¯ä»¥å¦‚ä¸‹ï¼š<br><img src="/../images/37.png" alt="37.png"><br>ä»£ç å—å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·±åº¦éå†è§£æ</span></span><br><span class="line">	ast.Inspect(funcDecl.Body, <span class="function"><span class="keyword">func</span><span class="params">(n ast.Node)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// Find assign Statements</span></span><br><span class="line">		retAssign, okAssign := n.(*ast.AssignStmt)</span><br><span class="line">		<span class="keyword">if</span> okAssign &#123;</span><br><span class="line">			<span class="comment">// Find CallExpr Statement</span></span><br><span class="line">			ast.Inspect(retAssign, <span class="function"><span class="keyword">func</span><span class="params">(a ast.Node)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">				retCall, okCall := a.(*ast.CallExpr)</span><br><span class="line">				<span class="keyword">if</span> okCall &#123;</span><br><span class="line">					resultCount := <span class="built_in">len</span>(retAssign.Lhs)</span><br><span class="line">					<span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºä¸šåŠ¡å‡½æ•°è°ƒç”¨</span></span><br><span class="line">					subFunctions = parseFuncCallExpr(retCall, resultCount, functionList, subFunctions, relFunctionMap,</span><br><span class="line">						functionDecls)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>å…¬å…±gomonkeyå•æµ‹æ–‡ä»¶Â <br>é€šè¿‡ä»¥ä¸Šé€»è¾‘ä¾¿å¯ä»¥è§£æå‡ºå‡½æ•°ä½“å†…çš„å¤–éƒ¨å‡½æ•°è°ƒç”¨çš„ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥åªéœ€è¦è€ƒè™‘å¦‚ä½•åŸºäºè¿™äº›ä¿¡æ¯æ„å»ºä¸šåŠ¡æ‰€éœ€çš„mockè°ƒç”¨å³å¯ã€‚åœ¨ç›®å‰å›¢é˜Ÿä¸šåŠ¡ä¸­åº•å±‚é‡‡ç”¨çš„æ˜¯ gomonkey çš„mockæ¨¡å¼ï¼Œå¹¶å°†é€šç”¨çš„æ–­è¨€åˆ¤æ–­ã€mockç›®æ ‡å‡½æ•°å†™åˆ°åŒç›®å½•ä¸‹çš„å…¬å…±æ–‡ä»¶base_test.go ä¸­ï¼Œå°½é‡å‡å°‘é‡å¤ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Hook <span class="keyword">struct</span> &#123;</span><br><span class="line">	target   <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	returns  []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	function <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HookList</span><span class="params">(f ...Hook)</span></span> []Hook &#123;</span><br><span class="line">	<span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HookReturn</span><span class="params">(target <span class="keyword">interface</span>&#123;&#125;, returns ...<span class="keyword">interface</span>&#123;&#125;)</span></span> Hook &#123;</span><br><span class="line">	<span class="keyword">return</span> Hook&#123;target: target, returns: returns&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HookFunc</span><span class="params">(target <span class="keyword">interface</span>&#123;&#125;, function <span class="keyword">interface</span>&#123;&#125;)</span></span> Hook &#123;</span><br><span class="line">	<span class="keyword">return</span> Hook&#123;target: target, function: function&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hook</span><span class="params">(h Hook)</span></span> &#123;</span><br><span class="line">	val := reflect.ValueOf(h.target)</span><br><span class="line">	<span class="keyword">if</span> h.function != <span class="literal">nil</span> &#123;</span><br><span class="line">		gomonkey.NewPatches().ApplyCore(val, reflect.ValueOf(h.function))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	gomonkey.NewPatches().ApplyCore(val, reflect.MakeFunc(val.Type(), <span class="function"><span class="keyword">func</span><span class="params">(args []reflect.Value)</span></span> (results []reflect.Value) &#123;</span><br><span class="line">		<span class="keyword">var</span> res []reflect.Value</span><br><span class="line">		<span class="keyword">for</span> k, v := <span class="keyword">range</span> h.returns &#123;</span><br><span class="line">			<span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">				res = <span class="built_in">append</span>(res, reflect.Zero(val.Type().Out(k)))</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			res = <span class="built_in">append</span>(res, reflect.ValueOf(v))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line">	&#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunTest</span><span class="params">(f <span class="keyword">interface</span>&#123;&#125;, tt <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		args := reflect.ValueOf(tt).FieldByName(<span class="string">&quot;Args&quot;</span>)</span><br><span class="line">		hooks := reflect.ValueOf(tt).FieldByName(<span class="string">&quot;Hook&quot;</span>)</span><br><span class="line">		want := reflect.ValueOf(tt).FieldByName(<span class="string">&quot;Want&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; hooks.Len(); i++ &#123;</span><br><span class="line">			hook(hooks.Index(i).Interface().(Hook))</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> param []reflect.Value</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; args.NumField(); i++ &#123;</span><br><span class="line">			param = <span class="built_in">append</span>(param, args.Field(i))</span><br><span class="line">		&#125;</span><br><span class="line">		ret := reflect.ValueOf(f).Call(param)</span><br><span class="line">		<span class="keyword">for</span> k, v := <span class="keyword">range</span> ret &#123;</span><br><span class="line">			<span class="keyword">if</span> !reflect.DeepEqual(v.Interface(), want.Field(k).Interface()) &#123;</span><br><span class="line">				t.Errorf(<span class="string">&quot;get = %v, want = %v&quot;</span>, v.Interface(), want.Field(k).Interface())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è‡ªå®šä¹‰æ¨¡ç‰ˆ</p>
</li>
</ul>
<p>é€šè¿‡ä»¥ä¸Šåˆ†æå¯ä»¥çœ‹å‡ºï¼Œè§£æå‡ºå‡½æ•°ä½“ä¸­çš„å¤–éƒ¨è°ƒç”¨ã€åˆ›å»ºå…¬å…±mockæ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥åªéœ€è¦åŸºäºåŸç”Ÿçš„gotestsæ¨¡ç‰ˆåšä¿®æ”¹å³å¯ã€‚ä¿®æ”¹çš„é‡ç‚¹åœ¨ï¼š</p>
<p>(1) tests ç»“æ„ä½“å¯¹è±¡æ„å»ºï¼šåŒ…å«Hookå¯¹è±¡ã€å‚æ•°å¯¹è±¡ã€è¿”å›å€¼å¯¹è±¡<br>(2) åœ¨åŸç”Ÿçš„ TODO ä¸­å¡«å……è¿›å¤–éƒ¨å‡½æ•°çš„mockè°ƒç”¨å†…å®¹<br>(3) å•å…ƒæµ‹è¯•çš„æœ€ç»ˆæ‰§è¡Œï¼ˆè°ƒç”¨base_test.go ä¸­æ–­è¨€åˆ¤æ–­ï¼‰</p>
<p><img src="/../images/38.png" alt="38.png"></p>
<p>ç»è¿‡ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤çš„æ‰©å±•ï¼Œgotestsçš„å·¥ä½œæµç¨‹ç°å¦‚ä¸‹ï¼š</p>
<p><img src="/../images/39.png" alt="39.png"></p>
<p>æ³¨ï¼šæ˜¯å¦å±è”½ç§æœ‰å‡½æ•°çš„è®¾è®¡æœ‰å¾…å•†æ¦·ï¼Œåœ¨ä»¥ä¸Šçš„æµç¨‹ä¸­ä¼šä»¥å…¬æœ‰å‡½æ•°ä¸ºå•å…ƒæµ‹è¯•ç”¨ä¾‹çš„å…¥å£ï¼Œé‡åˆ°ç§æœ‰å‡½æ•°è°ƒç”¨æ—¶ä¼šæ¥ç€è§£æè¯¥ç§æœ‰å‡½æ•°ä¸­çš„å¤–éƒ¨ä¾èµ–å‡½æ•°å¹¶ç»Ÿä¸€ç”Ÿæˆmockè°ƒç”¨ä¿¡æ¯ã€‚</p>
<p>æ‰©å±•ä¹‹åï¼Œä½¿ç”¨gotestsåŸç”Ÿå‘½ä»¤å¹¶æŒ‡å®šè‡ªå®šä¹‰çš„templateï¼ˆéœ€å‹ç¼©æ‰€æœ‰æ¨¡ç‰ˆå¹¶é›†æˆåˆ°gotestsæºç ä¸­ï¼‰åˆ›å»ºçš„å•æµ‹ç”¨ä¾‹å¦‚ä¸‹ï¼š</p>
<p>gotests -all -w -template iteaÂ user_service.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserService_GetUserInfo</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">                <span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">                        Id   <span class="type">int</span></span><br><span class="line">                        Name <span class="type">string</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">type</span> ret <span class="keyword">struct</span> &#123;</span><br><span class="line">                        Want *model.UserInfo</span><br><span class="line">                        Err  <span class="type">error</span></span><br><span class="line">                &#125;</span><br><span class="line">                tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">                        Name <span class="type">string</span></span><br><span class="line">                        Hook []Hook</span><br><span class="line">                        Args args</span><br><span class="line">                        Want ret</span><br><span class="line">                &#125;&#123;</span><br><span class="line">                        &#123;<span class="string">&quot;test1&quot;</span>, HookList(</span><br><span class="line">                              HookReturn((*service.PersonService).GetPersonInfo, <span class="literal">nil</span>, <span class="literal">nil</span>),</span><br><span class="line">                              HookReturn((*dao.PersonDao).GetInfoByCondition, <span class="literal">nil</span>),</span><br><span class="line">                        ), args&#123;&#125;, ret&#123;&#125;&#125;,</span><br><span class="line">                &#125;</span><br><span class="line">                U := &amp;UserService&#123;</span><br><span class="line">                        PersonService: &amp;service.PersonService&#123;&#125;,</span><br><span class="line">                        PersonDao: &amp;dao.PersonDao&#123;&#125;,</span><br><span class="line">                        Calculator: &amp;Calculator&#123;&#125;,</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">                        t.Run(tt.Name, RunTest(U.GetUserInfo, tt))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶éœ€è¦å®Œå–„ç”¨ä¾‹å†…å®¹éœ€è¦ï¼š<span style="color: red;">è¡¥å……mockå‡½æ•°çš„è¿”å›å€¼ã€å•æµ‹ç›®æ ‡å‡½æ•°çš„å‚æ•°ä¸è¿”å›å€¼</span>å³å¯</p>
<h1 id="5ã€æ€»ç»“"><a href="#5ã€æ€»ç»“" class="headerlink" title="5ã€æ€»ç»“"></a>5ã€æ€»ç»“</h1><p>(1) ä»¥ä¸ŠåŸºäºgotestsæºç çš„æ‰©å±•ä¾ç„¶æœ‰å¾…å®Œå–„çš„åœ°æ–¹ï¼šå¯¹äºå¤–éƒ¨ä¾èµ–çš„mockè°ƒç”¨ï¼Œæš‚æ—¶è¿˜æœªèƒ½è§£æå‡ºå¯¹åº”çš„è¿”å›å€¼ç±»å‹ï¼Œéœ€è¦æ‰‹åŠ¨å»å¡«å……ã€‚å› ä¸ºastè§£æçš„é€»è¾‘å…³æ³¨çš„å½“å‰æ–‡ä»¶ï¼Œå¯¹äºimportçš„å†…å®¹åªæ˜¯åšå±•ç¤ºï¼Œåç»­çš„è§£å†³æ€è·¯å¯ä»¥æ ¹æ®importçš„å†…å®¹ï¼Œè§£æé¡¹ç›®è·¯å¾„ä¸­çš„ç»“æ„ä½“ç±»å‹å¹¶è·å–åˆ°mockå‡½æ•°çš„è¿”å›å€¼ç±»å‹ç”¨ä½œæ„å»ºå®Œæ•´çš„mockè°ƒç”¨</p>
<p>(2) å¦‚ä½•å¹³è¡¡äººå·¥å†™å•æµ‹å¸¦æ¥çš„äººåŠ›æŸè€—å’Œè‡ªåŠ¨åŒ–çš„å•å…ƒæµ‹è¯•çš„ä¼˜åŠ£ä¸€ç›´æ˜¯å¼€å‘äººå‘˜äº‰è®ºä¸æ–­çš„è¯é¢˜ï¼Œä¸¥æ ¼æ¥è¯´è¶Šæ˜¯çœæ—¶çœåŠ›çš„è‡ªåŠ¨åŒ–ç”Ÿæˆå¼çš„å•æµ‹ï¼ŒåŒæ ·ä¹ŸæŸå¤±äº†å¾ˆå¤šå…¶ä»–çš„æ”¶ç›Šï¼Œå¦‚ï¼šå¼€å‘äººå‘˜å¯¹ä»£ç ç»“æ„çš„è®¾è®¡æ€è€ƒã€é‡æ„æ˜¯å¦å‹å¥½ç­‰ã€‚æ€»è€Œè¨€ä¹‹ï¼Œä¸ªäººè®¤ä¸ºå•å…ƒæµ‹è¯•ä¸€å®šæ˜¯ä¸€ä¸ªæœ‰ä»·å€¼çš„äº‹æƒ…ï¼Œä¸åŒä¸šåŠ¡ç‰¹æ€§ä¸åŒã€å†å²åŒ…è¢±ä¸ä¸€æ ·ï¼Œå¯¹äºå•æµ‹è½åœ°çš„æ–¹å¼ä¹Ÿä¸åŒã€‚ä½†æ˜¯ä¹Ÿä¸èƒ½åªä¸ºäº†å•æµ‹è€Œå»å†™å•æµ‹ç”¨ä¾‹ï¼Œæ›´å¤šçš„å¯èƒ½æ˜¯ä¸ºäº†æ•´ä½“çš„ä»£ç ç»“æ„è®¾è®¡ã€è¾¹ç•Œæƒ…å†µè€ƒè™‘ã€ç»´æŠ¤æ€§è€ƒè™‘ç­‰ã€‚</p>
<p><span style="color: red;">è¡¥å……ï¼šä»¥ä¸Šæ˜¯æœ¬äººåŸºäºä½¿ç”¨gotestsçš„ä¸€ç‚¹æ€è€ƒä¸æ‰©å±•ï¼Œå¦‚æœ‰ç†è§£ä¸åˆ°ä½çš„æƒ…å†µï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£æˆ–ä¸€èµ·è®¨è®ºå…³äºå•å…ƒæµ‹è¯•è½åœ°çš„æ›´å¤šå¯è¡Œæ–¹æ¡ˆã€‚</span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/07/gorm%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caleb">
      <meta itemprop="description" content="golangã€javaã€âš½ï¸ã€ğŸ€">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="caleb`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/07/gorm%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">gormå‰–æä¸å®è·µ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-07 20:02:14" itemprop="dateCreated datePublished" datetime="2024-03-07T20:02:14+08:00">2024-03-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-03-08 18:07:40" itemprop="dateModified" datetime="2024-03-08T18:07:40+08:00">2024-03-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>ä½œä¸ºgolangä¸­ä»£è¡¨æ€§çš„ormæ¡†æ¶ï¼Œå®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿå¦‚ä½•åˆ©ç”¨å®ƒæå‡å¼€å‘æ•ˆç‡ï¼Ÿ</p>
</blockquote>
<h1 id="1ã€GORMæ¦‚è¿°"><a href="#1ã€GORMæ¦‚è¿°" class="headerlink" title="1ã€GORMæ¦‚è¿°"></a>1ã€GORMæ¦‚è¿°</h1><p>ä¹‹å‰å·¥ä½œç»å†ä¸­ä½¿ç”¨javaæ¯”è¾ƒå¤šï¼Œåœ¨ORMæ–¹é¢ä¸»è¦ä½¿ç”¨Mybatisï¼Œå¹¶åšè¿‡ä¸€äº›æ‰©å±•ï¼Œå¦‚ï¼šåŸºäºæ‹¦æˆªå™¨å®ç°åŠ¨æ€æ•°æ®æƒé™ã€‚è¿™é‡Œç®€å•è®°å½•ä¸‹å­¦ä¹ gormåŸç†çš„è¿‡ç¨‹ã€‚</p>
<p>ä»€ä¹ˆæ˜¯ORMï¼Ÿ</p>
<p>ORMï¼šå¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆObject Relational Mappingï¼‰æ˜¯é€šè¿‡ä½¿ç”¨æè¿°å¯¹è±¡å’Œæ•°æ®åº“ä¹‹é—´æ˜ å°„çš„å…ƒæ•°æ®ï¼Œå°†é¢å‘å¯¹è±¡è¯­è¨€ç¨‹åºä¸­çš„å¯¹è±¡è‡ªåŠ¨æŒä¹…åŒ–åˆ°å…³ç³»æ•°æ®åº“ä¸­ã€‚å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š<br><img src="/../images/6.png" alt="6.png"></p>
<p>ORM æ¡†æ¶ç›¸å½“äºå¯¹è±¡å’Œæ•°æ®åº“ä¸­é—´çš„ä¸€ä¸ªæ¡¥æ¢ï¼Œå€ŸåŠ© ORM å¯ä»¥é¿å…å†™é‡å¤è€Œç¹ççš„ SQL è¯­å¥ï¼Œä»…ä»…é€šè¿‡æ“ä½œæŸä¸ªå…·ä½“çš„å¯¹è±¡ï¼Œå°±èƒ½å¤Ÿå®Œæˆå¯¹å…³ç³»å‹æ•°æ®åº“çš„åŸºç¡€æ€§æ“ä½œã€‚</p>
<p>ä»€ä¹ˆæ˜¯gormï¼Ÿ</p>
<p>GORMï¼šThe fantastic ORM library for Golang aims to be developer friendly.</p>
<p>åœ¨gormå®˜ç½‘ä¸­è¿™æ ·æè¿°è¯¥æ¡†æ¶ï¼šä¸€æ¬¾å‡ºè‰²ä¸”å¯¹å¼€å‘äººå‘˜å‹å¥½çš„golang ormåº“ã€‚åŒæ—¶å…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>å…¨åŠŸèƒ½ ORM</li>
<li>å…³è” (Has Oneï¼ŒHas Manyï¼ŒBelongs Toï¼ŒMany To Many)</li>
<li>Createï¼ŒSaveï¼ŒUpdateï¼ŒDeleteï¼ŒFind ä¸­é’©å­æ–¹æ³•</li>
<li>æ”¯æŒÂ Preloadã€JoinsÂ çš„é¢„åŠ è½½</li>
<li>äº‹åŠ¡ï¼ŒåµŒå¥—äº‹åŠ¡ï¼ŒSave Pointï¼ŒRollback To Saved Point</li>
<li>Contextï¼Œé¢„ç¼–è¯‘æ¨¡å¼ï¼ŒDryRun æ¨¡å¼</li>
<li>æ‰¹é‡æ’å…¥ï¼ŒFindInBatchesï¼ŒFind&#x2F;Create with Mapï¼Œä½¿ç”¨ SQL è¡¨è¾¾å¼ã€Context Valuer è¿›è¡Œ CRUD</li>
<li>SQL æ„å»ºå™¨ï¼ŒUpsertï¼Œæ•°æ®åº“é”ï¼ŒOptimizer&#x2F;Index&#x2F;Comment Hintï¼Œå‘½åå‚æ•°ï¼Œå­æŸ¥è¯¢</li>
<li>å¤åˆä¸»é”®ï¼Œç´¢å¼•ï¼Œçº¦æŸ</li>
<li>çµæ´»çš„å¯æ‰©å±•æ’ä»¶ APIï¼šDatabase Resolverï¼ˆå¤šæ•°æ®åº“ï¼Œè¯»å†™åˆ†ç¦»ï¼‰ã€Prometheusâ€¦</li>
<li>å¼€å‘è€…å‹å¥½</li>
</ul>
<p>åŸºäºæ­¤æˆ‘ä»¬æ¥çœ‹çœ‹gormçš„ä¸€äº›åŸºç¡€ä½¿ç”¨å’Œå®ç°åŸç†ï¼ŒåŒæ—¶å¦‚ä½•åˆ©ç”¨è¯¥æ¡†æ¶çš„ç‰¹æ€§æå‡åº”ç”¨å¼€å‘æ•ˆç‡ã€‚</p>
<h1 id="2ã€æ ¸å¿ƒå¯¹è±¡"><a href="#2ã€æ ¸å¿ƒå¯¹è±¡" class="headerlink" title="2ã€æ ¸å¿ƒå¯¹è±¡"></a>2ã€æ ¸å¿ƒå¯¹è±¡</h1><p>é€šè¿‡ç”Ÿæˆgormçš„ç±»å›¾å…³ç³»ä¸éš¾çœ‹å‡ºï¼Œé¦–å…ˆæœ‰å¦‚ä¸‹å‡ ä¸ªæ ¸å¿ƒå¯¹è±¡æ”¯æ’‘gormå†daoå±‚ä¸æ•°æ®åº“ä¹‹é—´çš„ä»£ç è¿è¡Œã€‚<br><img src="/../images/7.png" alt="7.png"></p>
<p>DBï¼šgormå…¨å±€å¯¹è±¡</p>
<p>Configï¼šå…¨å±€é…ç½®ï¼Œå¦‚ï¼šäº‹åŠ¡å¼€å…³ã€è‡ªå®šä¹‰å‘½åç­–ç•¥ã€é¢„ç¼–è¯‘å¼€å…³ã€å¥åº·æ£€æŸ¥ç­‰é…ç½®</p>
<p>Statementï¼šSQLæè¿°å¯¹è±¡</p>
<h1 id="3ã€ä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢å‘ç”Ÿäº†ä»€ä¹ˆ"><a href="#3ã€ä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢å‘ç”Ÿäº†ä»€ä¹ˆ" class="headerlink" title="3ã€ä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢å‘ç”Ÿäº†ä»€ä¹ˆ"></a>3ã€ä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢å‘ç”Ÿäº†ä»€ä¹ˆ</h1><p><img src="/../images/8.png" alt="8.png"></p>
<p>åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­é¦–å…ˆåº”å½“å®šä¹‰ä¸æ•°æ®è¡¨ç›¸æ˜ å°„çš„ä¸šåŠ¡å¯¹è±¡ï¼Œå¦‚ä¸Šå›¾çš„Userå¯¹è±¡ï¼Œå…³äºå¯¹è±¡çš„å®šä¹‰ä¸è§„åˆ™ä¸åšè¿‡å¤šé˜è¿°ï¼Œä¸»è¦æè¿°gormåœ¨å®Œæˆæ•°æ®åº“DMLè¿‡ç¨‹ä¸­çš„ç»†èŠ‚ã€‚</p>
<h2 id="3-1-åˆå§‹åŒ–"><a href="#3-1-åˆå§‹åŒ–" class="headerlink" title="3.1 åˆå§‹åŒ–"></a>3.1 åˆå§‹åŒ–</h2><p>æ­¤è¿‡ç¨‹å³å®Œæˆä»¥ä¸Šæ ¸å¿ƒå¯¹è±¡çš„åˆå§‹åŒ–åŠ¨ä½œï¼Œgormé€šè¿‡å¯¹å¤–æš´éœ²çš„openæ–¹æ³•è¿›è¡ŒDBå’ŒStatementå¯¹è±¡åˆå§‹åŒ–ï¼ŒåŒæ—¶åœ¨è¯¥æ–¹æ³•ä¸­å¯é€šè¿‡å‚æ•°è®¾ç½®Configä¸­çš„å…¬å¼€ç‰¹æ€§ã€‚<br><img src="/../images/9.png" alt="9.png"></p>
<p>åœ¨Openæ–¹æ³•ä¸­æœ‰ä¸¤ä¸ªæ“ä½œæ¯”è¾ƒé‡è¦ï¼š</p>
<p>(1) <span style="color: red;">åˆå§‹åŒ–DBå¯¹è±¡</span>ï¼šæœ‰cloneå±æ€§çš„å®šä¹‰ï¼Œåœ¨åç»­é“¾å¼æ“ä½œä¸­èµ·åˆ°æ¯”è¾ƒé‡è¦çš„ä½œç”¨ã€‚clone:åˆå§‹åˆ›å»ºçš„DBä¸º1ï¼Œåˆ†è£‚åˆ›å»ºSessionä¹‹åSessionæ˜¯1 ï¼Œå¦‚æœä¼šè¯ä¸ºDEBUGæ¨¡å¼åˆ™ä¸º2ã€‚</p>
<p>(2) <span style="color: red;">åˆå§‹åŒ–callback </span>ï¼šcallbackä¸ºgormçš„æ ¸å¿ƒï¼Œåç»­æ‰€æœ‰çš„crudæ“ä½œéƒ½æ˜¯åŸºäºcallbackå®ç°ï¼Œé»˜è®¤åˆå§‹åŒ–ï¼šcreateã€queryã€updateã€deleteã€rowã€rawåŸºç¡€å®ç°ã€‚</p>
<h2 id="3-2-é“¾å¼è°ƒç”¨"><a href="#3-2-é“¾å¼è°ƒç”¨" class="headerlink" title="3.2 é“¾å¼è°ƒç”¨"></a>3.2 é“¾å¼è°ƒç”¨</h2><p>åœ¨gormä¸­é€šè¿‡builderè®¾è®¡æ¨¡å¼ï¼ˆé€‚ç”¨å¤šä¸ªç®€å•å¯¹è±¡åˆ†æ­¥éª¤æ„å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼‰å®Œæˆæ ¸å¿ƒå¯¹è±¡ä¸­Statementå±æ€§ç”Ÿæˆã€‚ä¸»è¦åŸºäºå¦‚ä¸‹ä¸¤ä¸ªapiï¼š</p>
<p>(1) <span style="color: red;">chainable_api.go</span> ï¼šé€šè¿‡é€‚é…æ•°æ®åº“å…³é”®å­—çš„å‡½æ•°ç”Ÿæˆsqlå…ƒæ•°æ®ï¼Œå¦‚ï¼šselectã€whereã€joinã€groupç­‰sqlå­å¥å…³é”®å­—<br><img src="/../images/10.png" alt="10.png"><br>ä¾‹å¦‚åœ¨ä¸Šè¿°Selectçš„å‡½æ•°ä¸­å¯è®¾ç½®æŸ¥è¯¢åˆ—å€¼ï¼Œä¸è°ƒç”¨Selectåˆ™é»˜è®¤æŸ¥è¯¢è¡¨æ‰€æœ‰åˆ—</p>
<p>(2) <span style="color: red;">finisher_api.go</span>ï¼šé€šè¿‡æ‰§è¡Œæœ€ç»ˆç»„è£…å¥½çš„Sqlå¤„ç†å“åº”ç»“æœï¼Œå¦‚ï¼šFindã€Updateã€Saveç­‰ç±»ä¼¼DMLè¯­å¥çš„å…³é”®å­—<br><img src="/../images/11.png" alt="11.png"><br>åœ¨Findå‡½æ•°ä¸­å¤„ç†æŸ¥è¯¢ç»“æœæ˜ å°„çš„ç»“æ„ä½“æ•°æ®ã€‚</p>
<p>åœ¨å­¦ä¹ æºç è¿‡ç¨‹ä¸­ä¼šå‘ç°ï¼Œæ— è®ºæ˜¯chainable è¿˜æ˜¯ finisher ä¸­å‡ ä¹æ‰€æœ‰å‡½æ•°éƒ½ä¼šåŒ…å«è¿™æ ·ä¸€è¡Œä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tx = db.getInstance()</span><br></pre></td></tr></table></figure>
<p>æ¥çœ‹çœ‹é‡Œé¢çš„å®ç°ç»†èŠ‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> getInstance() *DB &#123;</span><br><span class="line"><span class="keyword">if</span> db.clone &gt; <span class="number">0</span> &#123;</span><br><span class="line">tx := &amp;DB&#123;Config: db.Config, Error: db.Error&#125;</span><br><span class="line"><span class="keyword">if</span> db.clone == <span class="number">1</span> &#123;</span><br><span class="line"><span class="comment">// clone with new statement</span></span><br><span class="line">tx.Statement = &amp;Statement&#123;</span><br><span class="line">DB:       tx,</span><br><span class="line">ConnPool: db.Statement.ConnPool,</span><br><span class="line">Context:  db.Statement.Context,</span><br><span class="line">Clauses:  <span class="keyword">map</span>[<span class="type">string</span>]clause.Clause&#123;&#125;,</span><br><span class="line">Vars:     <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="number">8</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// with clone statement</span></span><br><span class="line">tx.Statement = db.Statement.clone()</span><br><span class="line">tx.Statement.DB = tx</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°åœ¨è¯¥å‡½æ•°ä¸­ä¾¿åˆ©ç”¨åˆ°äº†åˆå§‹åŒ–æ—¶è®¾ç½®çš„cloneå±æ€§ï¼Œç®€å•æ¥è¯´è¯¥å‡½æ•°æ˜¯ä¸ºäº†åœ¨é“¾å¼è°ƒç”¨è¿‡ç¨‹ä¸­è·å–å½“å‰çš„gormå®ä¾‹å¯¹è±¡ä»è€Œä¿è¯åœ¨é“¾å¼æ“ä½œä¸­çš„ä¸€è‡´æ€§ã€‚</p>
<h2 id="3-3-æ•°æ®è§£æ"><a href="#3-3-æ•°æ®è§£æ" class="headerlink" title="3.3 æ•°æ®è§£æ"></a>3.3 æ•°æ®è§£æ</h2><p>é€šè¿‡é“¾å¼è°ƒç”¨ç”Ÿæˆsqlå…ƒæ•°æ®åï¼Œå¦‚ä½•å°†æ•°æ®åº“çš„æ‰§è¡Œç»“æœæ˜ å°„åˆ°ç»“æ„ä½“ä¸­ï¼Ÿ</p>
<p>å›åˆ°åˆšåˆš finisher ä¸­çš„ Find å‡½æ•°æœ€åçš„Executeçš„è°ƒç”¨ä¼šåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š<br><img src="/../images/12.png" alt="12.png"></p>
<p>gormåœ¨é€šè¿‡åå°„æ–¹æ³•è§£æç»“æ„ä½“ï¼ˆUserå¯¹è±¡ï¼‰è¿‡ç¨‹ä¸­ä¸»è¦ç”Ÿæˆçš„æ˜¯Â Schema å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­ä¸»è¦åŒ…å«ç»“æ„ä½“ä¸æ•°æ®åº“è¡¨çš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠå¦‚ï¼šå…³è”çº¦æŸã€è‡ªå®šä¹‰è¡¨åã€å›è°ƒå¼€å…³ç­‰ã€‚<br><img src="/../images/13.png" alt="13.png"></p>
<h2 id="3-4-callbackæ‰§è¡Œ"><a href="#3-4-callbackæ‰§è¡Œ" class="headerlink" title="3.4 callbackæ‰§è¡Œ"></a>3.4 callbackæ‰§è¡Œ</h2><p>(1) åœ¨ Execute ä¸­å¯ä»¥å‘ç°å®Œæˆç»“æ„ä½“è§£æåï¼Œä¼šæœ‰å¦‚ä¸‹ä¸€æ®µçœ‹ä¸Šå»éå¸¸ç®€å•çš„ä»£ç ï¼š<br><img src="/../images/14.png" alt="14.png"></p>
<p>æ­¤å¤„å…¶å®æ˜¯ä¸åˆå§‹åŒ–callbackä¸­è”ç³»èµ·æ¥ï¼Œä¼šå°†å‰ç½®æ‰€ç”Ÿæˆçš„Statementå¯¹è±¡ä¸­çš„sqlå…ƒæ•°æ®æä¾›ç»™å…·ä½“çš„callbackç”Ÿæˆæœ€ç»ˆæ•°æ®åº“è®¤å¯çš„sqlè¯­å¥ï¼Œå®Œæˆæ‰§è¡Œå¹¶æ‰«æå“åº”ç»“æœã€‚</p>
<p>ä¹‹æ‰€ä»¥æ˜¯forå¾ªç¯æ‰§è¡Œæ˜¯å› ä¸ºåœ¨ä¸šåŠ¡å¼€å‘ä¸­æˆ‘ä»¬å¯è‡ªè¡Œæ‰©å±•ä¾‹å¦‚ï¼š<span style="color: red;">BeforeCreateã€BeforeDeleteã€AfterCreate </span>ç­‰è‡ªå®šä¹‰çš„callbackï¼Œgormä¼šå°†å½“å‰DMLç±»å‹ä¸­çš„callbackæ’å¥½é¡ºåºä¾æ¬¡è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>(2) callbackç»“æ„ï¼š<br><img src="/../images/15.png" alt="15.png"></p>
<p><span style="color: red;">db.callbacks</span>ï¼šgormå…¨å±€å¯¹è±¡dbçš„callbackçš„mapé›†åˆï¼ŒåŒ…å«CRUDåŸºç¡€åœºæ™¯å’Œè‡ªå®šä¹‰çš„callbackã€‚</p>
<p><span style="color: red;">processor.callbacks</span>ï¼šåªåŒ…å«æŸä¸€åœºæ™¯çš„å¤šä¸ªcallbackå®ç°ï¼Œä¾‹å¦‚ï¼šQueryåœºæ™¯åŒ…å«ï¼šqueryã€preloadã€after_query</p>
<p>(3) åœ¨é»˜è®¤æ³¨å†ŒCallbackså‡½æ•°ä¸­ï¼Œé™¤æŸ¥è¯¢å¤–çš„Createã€Updateã€Deleteç›¸å…³çš„æ“ä½œå‡ä¼šé»˜è®¤æ³¨å†Œäº‹åŠ¡ç›¸å…³callbackã€‚æ‰€ä»¥å½“ä¸šåŠ¡ä¸­é»˜è®¤å®ç°äº†å¦‚ï¼šBeforeCreateã€BeforeDeleteã€AfterCreateç­‰callbackæ—¶ï¼Œé»˜è®¤æ˜¯å­˜åœ¨åŒä¸€äº‹åŠ¡å½“ä¸­ã€‚ä¹Ÿå¯é€šè¿‡Configä¸­çš„ <span style="color: red;">SkipDefaultTransaction&#x3D;false</span>  å…³é—­<br><img src="/../images/16.png" alt="16.png"></p>
<h2 id="3-4-ç»“æœæ˜ å°„"><a href="#3-4-ç»“æœæ˜ å°„" class="headerlink" title="3.4 ç»“æœæ˜ å°„"></a>3.4 ç»“æœæ˜ å°„</h2><p>query.go ä¸­æ˜¯å…·ä½“æŸ¥è¯¢çš„å®ç°ï¼ŒåŒ…æ‹¬</p>
<p>(1) æ ¹æ®Statemntå’Œç›®æ ‡ç»“æ„ä½“è§£æçš„Schemaå¯¹è±¡æ„å»ºSql</p>
<p>(2) æ‰§è¡ŒSql</p>
<p>(3) æ ¹æ®Schemaçš„æ˜ å°„å…³ç³»å°†sqlç»“æœScanåˆ°ç›®æ ‡å¯¹è±¡ä¸­ã€‚<br><img src="/../images/17.png" alt="17.png"><br>è‡³æ­¤é€šè¿‡gormå®Œæˆäº†ä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢ï¼Œå…¶ä¸­å¦‚æœæœ‰æ›´åŠ å¤æ‚çš„sqlä¹Ÿå¯ä»¥ä½¿ç”¨chaniable ä¸­æä¾›çš„å‡½æ•°å®ç°è¿›è¡Œsqlçš„ç»„è£…ã€‚</p>
<h1 id="4ã€å¦‚ä½•å®ç°åŠ¨æ€è¡¨å"><a href="#4ã€å¦‚ä½•å®ç°åŠ¨æ€è¡¨å" class="headerlink" title="4ã€å¦‚ä½•å®ç°åŠ¨æ€è¡¨å"></a>4ã€å¦‚ä½•å®ç°åŠ¨æ€è¡¨å</h1><p>åœ¨è‡ªå·±å†™ä¸€äº›ç®€å•æ¡ˆä¾‹åŒæ—¶å…·æœ‰åˆ†è¡¨çš„åœºæ™¯ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªæ•°æ®è¡¨æ˜ å°„åŒä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œå¦‚ä½•åšåˆ°åŠ¨æ€è¡¨åæ˜ å°„ï¼Ÿ</p>
<p>åœ¨gormé»˜è®¤è§£æè¿‡ç¨‹ä¸­å¦‚æœ <span style="color: red;"> Statementå¯¹è±¡ä¸­Tableä¸ºç©º </span>ï¼Œåˆ™ä½¿ç”¨ä»ç»“æ„ä½“ä¸­è§£æå‡ºçš„è¡¨åï¼ˆé»˜è®¤ä¸ºç»“æ„ä½“å®ç°çš„TableNameæ–¹æ³•ï¼‰ï¼Œç”¨äºåç»­æ„å»ºSqlæ‰€éœ€ ã€‚åŒæ—¶ä¸ºäº†ç»“æ„ä½“è§£æè¿‡ç¨‹ä¸­å°½é‡ä¸æŸè€—æ€§èƒ½ï¼Œæ‰€ä»¥ä½¿ç”¨äº†å†…å­˜ç¼“å­˜ï¼Œå½“æŸç»“æ„ä½“å·²ç”ŸæˆSchemaå¯¹è±¡åï¼Œåˆ™é»˜è®¤ä½¿ç”¨ç¼“å­˜ä¸­çš„è¯¥å¯¹è±¡ã€‚æ‰€ä»¥ç»“æ„ä½“å®ç°çš„TableName() å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡ã€‚<br><img src="/../images/18.png" alt="18.png"></p>
<p>ä»è§£æçš„æºç ä¸­ä¸éš¾å‘ç°ï¼Œå¦‚æœå¯ä»¥æ‰‹åŠ¨è®¾ç½®Statementå¯¹è±¡çš„Tableå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒåŸºäºæ­¤gormåœ¨chaniable ä¸­æä¾›Tableå‡½æ•°ä¾›å¼€å‘äººå‘˜å¯è‡ªè¡Œè®¾ç½®Statementä¸­çš„Tableï¼Œè€Œä¸ä¾èµ–è§£æç»“æ„ä½“ã€‚</p>
<p><img src="/../images/19.png" alt="19.png"></p>
<h1 id="5ã€callbackåº”ç”¨-è‡ªå®šä¹‰callback"><a href="#5ã€callbackåº”ç”¨-è‡ªå®šä¹‰callback" class="headerlink" title="5ã€callbackåº”ç”¨&amp;è‡ªå®šä¹‰callback"></a>5ã€callbackåº”ç”¨&amp;è‡ªå®šä¹‰callback</h1><p>(1) BeforeUpdate æ˜¯gormé»˜è®¤æä¾›çš„ä¸€ç§åœºæ™¯ï¼Œæ— éœ€è‡ªå®šä¹‰æ³¨å†Œï¼Œåªéœ€ä¸šåŠ¡å¯¹è±¡ç»“æ„ä½“å®ç°è¯¥æ–¹æ³•å³å¯ã€‚</p>
<p>gorm æä¾›äº† <span style="color: red;"> Changed </span>æ–¹æ³•ï¼Œå¯ä»¥ç”¨åœ¨è¿™é‡Œï¼Œå®ƒä¼šè¿”å›æ£€æŸ¥å­—æ®µæ˜¯å¦æœ‰å˜æ›´ã€‚ä¸”ChangedÂ æ–¹æ³•åªä¸Â Updateã€UpdatesÂ æ–¹æ³•ä¸€èµ·ä½¿ç”¨ï¼Œåªæ£€æŸ¥ Model å¯¹è±¡å­—æ®µçš„å€¼ä¸å°†è¦æ›´æ–°çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœæœ‰å˜æ›´ï¼Œä¸”å­—æ®µæ²¡æœ‰è¢«å¿½ç•¥ï¼Œåˆ™è¿”å› trueï¼Œä¸šåŠ¡å¯ä¾æ­¤ç‰¹æ€§åº”ç”¨ã€‚<br><img src="/../images/20.png" alt="20.png"><br><img src="/../images/21.png" alt="21.png"></p>
<p>(2)Â gorm æä¾›åŸºäºé»˜è®¤Createã€Queryã€Updateã€Deleteã€Rowã€Raw è‡ªå®šä¹‰æ³¨å†Œcallbackï¼ŒåŒæ—¶å¯ä»¥æŒ‡å®šè‡ªå®šä¹‰callbackçš„é¡ºåºã€‚åœ¨è‡ªå®šä¹‰callbackä¸­å¯é€šè¿‡db.Statement è·å–å½“å‰å®ä½“ä¸æ•°æ®åº“æ˜ å°„çš„æ•°æ®ã€‚å¦‚ä¸‹ï¼š<br><img src="/../images/22.png" alt="22.png"></p>
<h1 id="6ã€è¿æ¥æ± "><a href="#6ã€è¿æ¥æ± " class="headerlink" title="6ã€è¿æ¥æ± "></a>6ã€è¿æ¥æ± </h1><p>(1) gormåœ¨è¿æ¥æ± ä¾æ—§æ˜¯åŸºäº database&#x2F;sql çš„å®ç°ï¼Œç®€å•æ¦‚è¿°ï¼š<br><img src="/../images/23.png" alt="23.png"></p>
<p>freeConnï¼šç©ºé—²è¿æ¥æ± Â  Â  connRequestsï¼šç­‰å¾…æ± </p>
<p>getConn(è·å–è¿æ¥)ï¼š</p>
<ul>
<li>é¦–å…ˆæ£€æŸ¥ç©ºé—²è¿æ¥æ± æ˜¯å¦æœ‰è¿æ¥ï¼Œè‹¥æœ‰ï¼Œåˆ™æ£€æŸ¥è¯¥è¿æ¥æ˜¯å¦è¶…æ—¶ï¼Œè‹¥æ²¡è¶…æ—¶ï¼Œåˆ™è¿”å›è¯¥è¿æ¥ã€‚</li>
<li>è‹¥ç©ºé—²è¿æ¥æ± æ— è¿æ¥ï¼Œæ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§è¿æ¥æ•°ï¼Œè‹¥è¶…è¿‡åˆ™æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦åˆ™æ–°å»ºè¿æ¥è¿”å›ã€‚</li>
</ul>
<p>putConn(é‡Šæ”¾è¿æ¥)ï¼š</p>
<ul>
<li>é¦–å…ˆæ£€æŸ¥connRequestsç­‰å¾…æ± ä¸­ï¼Œæ˜¯å¦æœ‰é˜»å¡çš„è¯·æ±‚</li>
<li>è‹¥æœ‰ï¼Œåˆ™å°†è¯¥connectionç»™å®ƒï¼Œå‘channelä¸­å‘æ•°æ®ï¼Œé˜»å¡çš„è¿æ¥è¯·æ±‚å°±å¯ä»¥æ‹¿åˆ°è¿æ¥</li>
<li>å¦åˆ™ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦åˆ°è¾¾æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼Œè‹¥æ— åˆ™å°†è¿æ¥æ”¾è‡³freeConnç©ºé—²è¿æ¥æ± ä¸­ï¼Œå¦åˆ™å°†è¿æ¥å…³é—­<br>åŒæ—¶åº•å±‚ä¼šå•ç‹¬åˆ›å»ºåç¨‹æ£€æŸ¥ç©ºé—´è¿æ¥æ± ä¸­çš„è¿æ¥æ˜¯å¦è¶…æ—¶ï¼Œè‹¥è¶…æ—¶åˆ™ä¼šå›æ”¶è¿™éƒ¨åˆ†è¿æ¥ã€‚</li>
</ul>
<p>(2) å¼‚å¸¸å¤„ç†ï¼šåœ¨æ—¥å¸¸ä¸šåŠ¡è¿è¡Œæ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°ä»¥ä¸‹å…³äºè¿æ¥æ± çš„å¼‚å¸¸</p>
<ul>
<li>TIME_WAIT</li>
</ul>
<p>å¯èƒ½åŸå› ï¼šmaxIdleConn &lt;&lt; maxOpenCountï¼Œåº”ç”¨ç¬æ—¶æ‰“å¼€è¾ƒå¤§çš„è¿æ¥æ•°ï¼Œè€Œæ— æ³•æ”¾å…¥ç©ºé—²æ± è¢«å…³é—­ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šä¸è¦é‡‡ç”¨é»˜è®¤è¿æ¥é…ç½®ï¼Œdefault maxIdleConn &#x3D; 2</p>
<p>maxIdleConn &lt; maxOpenCountï¼Œå¸¸é©»åŒæ•°æ®åº“äº¤äº’çš„goroutine çº¦ç­‰äº maxIdleConn</p>
<ul>
<li>invalid connection</li>
</ul>
<p>å¯èƒ½åŸå› ï¼šmysql wait_timeout &lt; maxLifeTimeï¼Œè¿æ¥æœ‰æ•ˆæ—¶é•¿å¤§äºæ•°æ®åº“æœ€å¤§ç­‰å¾…æ—¶é•¿</p>
<p>è§£å†³æ–¹æ¡ˆï¼šåˆç†é…ç½®æ•°æ®åº“çš„wait_timeoutæ—¶é—´ï¼Œæ•°æ®åº“é»˜è®¤wait_timeout &#x3D; 28800</p>
<p>maxLifeTime &lt; mysql wait_timeout</p>
<h1 id="7ã€æ€§èƒ½"><a href="#7ã€æ€§èƒ½" class="headerlink" title="7ã€æ€§èƒ½"></a>7ã€æ€§èƒ½</h1><p>æ€§èƒ½ä¸€ç›´æ˜¯ORMæ¡†æ¶é€ƒä¸å¼€çš„è¯é¢˜ï¼Œå„ç§ORMæ¡†æ¶éƒ½éœ€è¦å¤„ç†å¯¹è±¡ç»“æ„ä½“ä¸æ•°æ®åº“è¡¨å…³ç³»æ˜ å°„çš„åå°„è§£æã€Sqlçš„æ‹¼è£…ç­‰ç¯èŠ‚éƒ½å¯èƒ½é€ æˆä¸€äº›æ€§èƒ½çš„æŸè€—ã€‚åŸºäºæ­¤æœ¬äººç®€å•å¯¹æ¯”äº†ä¸€ä¸‹åŸç”Ÿsqlã€sqlxã€gormåœ¨æ™®é€šæŸ¥è¯¢æ—¶çš„æ€§èƒ½æ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p>
<p>(1) ç¡¬ä»¶ï¼šApple M1Â  16G</p>
<p>(2) è¿æ¥æ± é…ç½®ï¼šMaxOpenConnï¼š300Â  MaxIdleConnï¼š100</p>
<p>(3) æµ‹è¯•åœºæ™¯ï¼šåˆ†åˆ«æµ‹è¯• è¡¨æ•°æ®åœ¨ 20w å’Œ 50w æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢100ã€500ã€1000æ¡æ•°æ®ä¸‹çš„æ€§èƒ½å¯¹æ¯”ï¼ˆç®€å•sqlï¼‰</p>
<p>20W è¡¨æ•°æ®ï¼š<br><img src="/../images/24.png" alt="24.png"></p>
<p>50Wè¡¨æ•°æ®ï¼š<br><img src="/../images/25.png" alt="25.png"></p>
<p>é€šè¿‡å¯¹æ¯”å¯ä»¥åˆæ­¥å‘ç°ï¼Œåœ¨ç®€å•sqlæƒ…å†µä¸‹æŸ¥è¯¢å“åº”æ—¶é—´ä¸Šormæ¡†æ¶ä¼šæ¯”åŸå£°sqlè¡¨ç°å¥½ä¸€äº›ï¼Œä½†æ˜¯åœ¨å†…å­˜åˆ†é…ä¸Šæ¥è¯´ï¼Œé€‚ç”¨ormæ¡†æ¶ç”±äºå¤šäº†è®¸å¤šæ•°æ®å±‚çš„æ“ä½œï¼Œå‡æ˜¯ä½¿ç”¨åŸç”Ÿsqlçš„å¥½å‡ å€ï¼ŒåŒæ—¶gormä¼šæ¯”sqlxå ç”¨å†…å­˜æ›´é«˜ã€‚</p>
<p>psï¼šæ­¤å¤„æ€§èƒ½å¯¹æ¯”åœºæ™¯æ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸ä¸€å®šä»£è¡¨æ•´ä½“æ€§èƒ½ä¸ŠORMæ¡†æ¶ä¼šæ¯”åŸç”Ÿsqlæ›´ä¼˜ç§€ã€‚</p>
<h1 id="8ã€å…¶ä»–ç‰¹æ€§"><a href="#8ã€å…¶ä»–ç‰¹æ€§" class="headerlink" title="8ã€å…¶ä»–ç‰¹æ€§"></a>8ã€å…¶ä»–ç‰¹æ€§</h1><h2 id="8-1-Context-ä¸-Session"><a href="#8-1-Context-ä¸-Session" class="headerlink" title="8.1 Context ä¸ Session"></a>8.1 Context ä¸ Session</h2><p>(1) gormé€šè¿‡WithContextæ–¹æ³•æä¾›å¯¹context çš„æ”¯æŒï¼Œé€šè¿‡contextå¯å®ç°è¯¸å¤šä¸šåŠ¡åœºæ™¯ï¼Œä¾‹å¦‚ï¼šsqlçº§åˆ«çš„æ—¥å¿—ç›‘æ§ç­‰<br><img src="/../images/26.png" alt="26.png"></p>
<p>(2) gormä¸­Sessionæ–¹æ³•ï¼Œå…è®¸åˆ›å»ºå¸¦ä¸ªæ€§åŒ–é…ç½®çš„ä¼šè¯æ¨¡å¼ï¼Œå¦‚é€šè¿‡è®¾ç½®PrepareStmtè¿›è¡ŒSqlç¼“å­˜ã€‚<br><img src="/../images/27.png" alt="27.png"></p>
<h2 id="8-2-äº‹åŠ¡å¤„ç†"><a href="#8-2-äº‹åŠ¡å¤„ç†" class="headerlink" title="8.2 äº‹åŠ¡å¤„ç†"></a>8.2 äº‹åŠ¡å¤„ç†</h2><p>(1) gormæ”¯æŒåµŒå¥—äº‹åŠ¡ã€æ‰‹åŠ¨äº‹åŠ¡ã€SavePointä¸RollbackToç­‰åœºæ™¯ï¼ŒåŒæ—¶å¯é€šè¿‡SkipDefaultTransactioné…ç½®æ˜¯å¦å¼€å¯äº‹åŠ¡ã€‚<br><img src="/../images/28.png" alt="28.png"><br><img src="/../images/29.png" alt="29.png"></p>
<h2 id="8-3-sqlæ³¨å…¥"><a href="#8-3-sqlæ³¨å…¥" class="headerlink" title="8.3 sqlæ³¨å…¥"></a>8.3 sqlæ³¨å…¥</h2><p>gormä½¿ç”¨Â database&#x2F;sqlÂ çš„å‚æ•°å ä½ç¬¦æ¥æ„é€  SQL è¯­å¥ï¼Œè¿™å¯ä»¥è‡ªåŠ¨è½¬ä¹‰å‚æ•°ï¼Œé¿å… SQL æ³¨å…¥æ•°æ®ã€‚ä½†æ˜¯åœ¨æŸäº›ç‰¹æ®Šçš„é“¾å¼è°ƒç”¨å‡½æ•°ä¸­éœ€è¦è°¨æ…å¤„ç†ï¼Œå¦‚ä¸‹ï¼š<br><img src="/../images/30.png" alt="30.png"></p>
<h1 id="9ã€æ€»ç»“"><a href="#9ã€æ€»ç»“" class="headerlink" title="9ã€æ€»ç»“"></a>9ã€æ€»ç»“</h1><p>(1) ORMç†è®ºä¸‹æœŸæœ›èƒ½å¤Ÿæ‰¿æ¥ä¸€åˆ‡ä»ä¸šåŠ¡å±‚åˆ°æ•°æ®åº“å±‚çš„æ“ä½œï¼Œä»¥ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹å¼è·å–æ•°æ®ï¼Œå°±åƒæ“ä½œå…·ä½“å¯¹è±¡ä¸€æ ·<br><img src="/../images/31.png" alt="31.png"></p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>èŠ‚çœæ‰‹å·¥ä»å…ƒæ•°æ®æ˜ å°„åˆ°æ¨¡å‹çš„æˆæœ¬</li>
<li>æ”¯æŒåŠ è½½å…³è”å¯¹è±¡</li>
<li>ä¸ç”¨ç¼–å†™é‡å¤ä¸”åŸºç¡€çš„SQLã€ä¸ç”¨ç®¡ç†äº‹åŠ¡ã€æ•°æ®åº“è¿æ¥</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å…ƒæ•°æ®æ˜ å°„æ—¶ç±»å‹éš¾ä»¥åŒ¹é…ï¼Œæ¯”å¦‚æšä¸¾ï¼Œæ—¥æœŸç­‰ï¼Œå¤§é‡å­—æ®µæ˜ å°„æ—¶å¯èƒ½ä¼šé€ æˆæ€§èƒ½ç“¶é¢ˆ</li>
<li>è‡ªåŠ¨ç¼–å†™çš„SQLå¯èƒ½å­˜åœ¨æ€§èƒ½ç¼ºé™·ä¸”éš¾ä»¥ä¼˜åŒ–</li>
<li>å¤æ‚çš„è¿è¡¨æŸ¥è¯¢ï¼Œä½¿ç”¨æ¨¡å‹åŒ–çš„æŸ¥è¯¢æ— æ³•æ»¡è¶³ï¼Œå®¹æ˜“å¯¼è‡´æ…¢æŸ¥è¯¢</li>
</ul>
<p>å¾€å¾€åœ¨ä¸šåŠ¡å¼€å‘ä¸­ä½¿ç”¨ orm + sql æƒ…å†µæ¯”è¾ƒå¤šï¼Œç›®å‰å¤§å¤šæ•°ormåº“éƒ½æ”¯æŒåŸç”Ÿsqlçš„æ‰§è¡Œï¼Œç”¨äºæ»¡è¶³å¤æ‚sqlçš„åœºæ™¯ã€‚</p>
<p>(2)Â  ä¸ªäººè®¤ä¸ºç›®å‰å„å¼€å‘è¯­è¨€ä¸­çš„ormåº“é™¤äº†æ»¡è¶³å…¶åŸºç¡€çš„å¯¹è±¡å…³ç³»æ˜ å°„å’Œsqlå°è£…ä¹‹å¤–ï¼Œç»™å¼€å‘äººå‘˜æ›´å¤§çš„ä½œç”¨æ˜¯å°†æ•°æ®å¤„ç†å±‚ä¸ä¸šåŠ¡å¤„ç†å±‚è¿›è¡Œè§£è€¦ï¼Œ<span style="color: red;"> åˆ©ç”¨å„ç§ç‰¹æ€§ï¼ˆæ‹¦æˆªå™¨ã€callbackç­‰ï¼‰</span>å¼•å¯¼æˆ‘ä»¬å°†æ•°æ®å¤„ç†é€»è¾‘ç‹¬ç«‹å‡ºæ¥ã€‚</p>
<p>å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ä¸­çš„å¢ã€åˆ ã€æ”¹æ“ä½œå¯¹äºgormå¤„ç†èµ·æ¥æ¯”è¾ƒç®€å•ï¼ŒåŸºæœ¬ä¸ºå•å®ä½“çš„æ“ä½œï¼Œå¾€å¾€æŸ¥è¯¢é¢ä¸´å¤æ‚å¯¹è±¡çš„æ˜ å°„ä½¿ç”¨ormæ¡†æ¶å¤„ç†æ¯”è¾ƒå›°éš¾ã€‚æ‰€ä»¥ç›®å‰åœ¨æ¯”è¾ƒç«çƒ­çš„ <span style="color: red;"> DDDæ–¹æ³•è®ºä¸­æå‡ºÂ CQRSï¼ˆCommand Query Responsibility Segregationï¼‰ æ¨¡å¼</span>ï¼Œè¯¥æ¨¡å¼æå€¡å°†ç³»ç»Ÿä¸­çš„æ“ä½œåˆ†ä¸ºä¸¤ç±»ï¼Œå³å‘½ä»¤(Command) ä¸æŸ¥è¯¢(Query)ã€‚</p>
<ul>
<li>å‘½ä»¤åˆ™æ˜¯å¯¹ä¼šå¼•èµ·æ•°æ®å‘ç”Ÿå˜åŒ–æ“ä½œçš„æ€»ç§°ï¼Œå¯ä»¥ç†è§£ä¸ºgormçš„DMLç±»è¯­å¥ä¸­çš„æ–°å¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤è¿™äº›æ“ä½œï¼Œéƒ½æ˜¯å‘½ä»¤ã€‚</li>
<li>æŸ¥è¯¢åˆ™å’Œå­—é¢æ„æ€ä¸€æ ·ï¼Œå³ä¸ä¼šå¯¹æ•°æ®äº§ç”Ÿå˜åŒ–çš„æ“ä½œï¼Œåªæ˜¯æŒ‰ç…§æŸäº›æ¡ä»¶æŸ¥æ‰¾æ•°æ®ã€‚</li>
</ul>
<p>gormä½œä¸ºä¸€ä¸ªormå±‚æ¡†æ¶èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡å¼€å‘æ•ˆç‡ï¼Œä½†æ˜¯ä¸šåŠ¡ç³»ç»Ÿå¤æ‚å¤šå˜æŸä¸ªæ¡†æ¶æˆ–è€…æŸç§è®¾è®¡æ¨¡å¼å¾ˆéš¾åšåˆ°é¢é¢ä¿±åˆ°ï¼Œå¼€å‘äººå‘˜è¦åšçš„ä¾¿æ˜¯å–å…¶ç²¾åã€‚</p>
<p>è¡¥å……ï¼šä»¥ä¸Šæ˜¯ä¸ªäººåœ¨å­¦ä¹ gormè¿‡ç¨‹ä¸­ä¸€äº›æ€»ç»“ï¼Œæœ‰ç†è§£ä¸åˆ°åˆ°ä½çš„åœ°æ–¹æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œä¸€èµ·äº¤æµã€‚</p>
<h1 id="10ã€å‚è€ƒ"><a href="#10ã€å‚è€ƒ" class="headerlink" title="10ã€å‚è€ƒ"></a>10ã€å‚è€ƒ</h1><p><a target="_blank" rel="noopener" href="https://gorm.cn/zh_CN/docs/migration.html">https://gorm.cn/zh_CN/docs/migration.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/07/Es%E5%A4%9A%E5%B1%82%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caleb">
      <meta itemprop="description" content="golangã€javaã€âš½ï¸ã€ğŸ€">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="caleb`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/07/Es%E5%A4%9A%E5%B1%82%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">Eså¤šå±‚çº§æ•°æ®å»ºæ¨¡æ¡ˆä¾‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-07 19:26:01 / ä¿®æ”¹æ—¶é—´ï¼š19:58:59" itemprop="dateCreated datePublished" datetime="2024-03-07T19:26:01+08:00">2024-03-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1.èƒŒæ™¯"></a>1.èƒŒæ™¯</h1><p>è¿‘æœŸç»„é‡Œä¸Šçº¿æ–°ç‰ˆæœ¬ï¼Œå…¶ä¸­æ¶‰åŠåˆ°å¤šè¡¨æ•°æ®å…³è”æŸ¥è¯¢åœºæ™¯ã€‚ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¡¨SQLæ¯”è¾ƒå¤æ‚ï¼Œä¸”æŸ¥è¯¢åˆ—è¡¨ä¸­æ— æ›´æ–°æ•°æ®æ“ä½œï¼Œä»…ä¾›æŸ¥è¯¢ã€‚ä¸ºäº†é¿å…æ—¥åæ•°æ®å¢é•¿å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼ŒåŒæ—¶å¯å®¹å¿çŸ­æ—¶é—´å†…çš„æ•°æ®å»¶è¿Ÿï¼Œæ‰€ä»¥æ­¤å¤„æŸ¥è¯¢ä½¿ç”¨Eså®ç°ã€‚</p>
<p>æ•°æ®åº“è¡¨ç»“æ„ï¼ˆç®€å•è¯´æ˜ï¼‰ï¼š</p>
<p><img src="/../images/1.png" alt="4.png"></p>
<p>å®é™…åœºæ™¯ä¸­å¯èƒ½å­˜åœ¨ç±»ä¼¼ä¸Šè¿°å¤šå±‚çº§çš„ä¸€å¯¹å¤šçš„å…³è”å…³ç³»ï¼Œæœ¬æ–‡ä¸­ç®€å•æå– åˆ›ä½œè€…-è´¦å· çš„ä¸€å¯¹å¤šçš„å…³ç³»ä¸ºæ¡ˆä¾‹ã€‚</p>
<h1 id="2-Esæ•°æ®ç»“æ„"><a href="#2-Esæ•°æ®ç»“æ„" class="headerlink" title="2. Esæ•°æ®ç»“æ„"></a>2. Esæ•°æ®ç»“æ„</h1><p>Eså¹¶é <span style="color: red;">å…³ç³»å‹æ•°æ®åº“</span>ï¼ŒEsæ˜¯<span style="color: red;"> æ‰å¹³åŒ–çš„å­˜å‚¨ç»“æ„ </span>ã€‚ç´¢å¼•æ˜¯ç‹¬ç«‹æ–‡æ¡£çš„é›†åˆä½“ã€‚ä¸åŒçš„ç´¢å¼•ä¹‹é—´ä¸€èˆ¬æ˜¯æ²¡æœ‰å…³ç³»çš„ã€‚å¹¶ä¸æ“…é•¿å…³ç³»å‹æ•°æ®åº“ä¸­çš„joinæ“ä½œï¼Œæ­¤æ—¶<span style="color: red;"> å¦‚ä½•è§£å†³ä½œè€…æ€»æŸ¥è¯¢ä¸­çš„å¤šç»´åº¦æ¡ä»¶åµŒå¥—å¯¹è±¡çš„æ•°æ®æŸ¥è¯¢ï¼Ÿ</span></p>
<h2 id="2-1-æ™®é€šå¯¹è±¡"><a href="#2-1-æ™®é€šå¯¹è±¡" class="headerlink" title="2.1 æ™®é€šå¯¹è±¡"></a>2.1 æ™®é€šå¯¹è±¡</h2><p>(1) æ­¤ç§å¯¹è±¡å­˜å‚¨æ–¹å¼æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œé€šè¿‡åº”ç”¨å±‚ç»„è£…å¥½æ•°æ®å¯¹è±¡æœ€ç»ˆå­˜å‚¨åˆ°Eså¯¹åº”ç´¢å¼•ä¸­ã€‚æ‰€ä»¥å¦‚æœç”¨æ™®é€šçš„å†…éƒ¨å¯¹è±¡å­˜å‚¨åˆ›ä½œè€…ä¸è´¦å·çš„æ•°æ®ï¼ŒEsä¸­å¯ä»¥è¿™æ ·å­˜å‚¨ï¼š<br>åˆ›å»ºç´¢å¼•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                           </span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                         </span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ–°å¢æ•°æ®ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_index/_doc/<span class="number">12345678</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªåˆ›ä½œè€…&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(2) è¯¥å¯¹è±¡æŸ¥è¯¢æ—¶å¾ˆé«˜æ•ˆï¼Œå¯ç›´æ¥æŸ¥è¯¢åˆ›ä½œè€…ä¸»ä½“å’Œå…³è”çš„è´¦å·ä¿¡æ¯ï¼Œä½†æ˜¯å­˜åœ¨å¦ä¸€ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼Œå½“æŸ¥è¯¢æ¶‰åŠå…³è”è´¦å·æ¡ä»¶æ—¶ï¼Œä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æŒ‰ç…§æœ€åˆå­˜å‚¨çš„æ•°æ®å¯¹è±¡ï¼Œä»¥ä¸ŠæŸ¥è¯¢ä¸åº”è¯¥æŸ¥ç»“æœï¼Œå› ä¸ºè´¦å·Nameä¸ºPaulçš„å¯¹åº”platformIdåº”è¯¥æ˜¯ 2ï¼Œå®é™…ä¸Šå´èƒ½æŸ¥å‡ºç»“æœï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.6931472</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.6931472</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;userCommonId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªåˆ›ä½œè€…&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(3) ä¸Šè¿°é—®é¢˜çš„åŸå› åœ¨äºEsä¸­å­˜å‚¨åµŒå¥—æ•°æ®æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡æ‰å¹³åŒ–å¤„ç†ï¼Œæ­¤æ—¶ä¾¿å¤±å»äº†æœ€åˆå­˜å‚¨æ—¶çš„å…³è”å…³ç³»ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span><span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªåˆ›ä½œè€…&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;john&quot;</span><span class="punctuation">,</span><span class="string">&quot;paul&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;accounts.accountId&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;ks7897389832&quot;</span><span class="punctuation">,</span><span class="string">&quot;dy7897389832&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-2-åµŒå¥—å¯¹è±¡"><a href="#2-2-åµŒå¥—å¯¹è±¡" class="headerlink" title="2.2 åµŒå¥—å¯¹è±¡"></a>2.2 åµŒå¥—å¯¹è±¡</h2><p>å¾ˆæ˜æ˜¾ä¸Šé¢å¯¹è±¡æ•°ç»„çš„æ–¹æ¡ˆæ²¡æœ‰å¤„ç†å¥½å†…éƒ¨å¯¹è±¡çš„è¾¹ç•Œé—®é¢˜ï¼ŒJSONæ•°ç»„å¯¹è±¡è¢«ESå¼ºè¡Œå­˜å‚¨æˆæ‰å¹³åŒ–çš„é”®å€¼å¯¹åˆ—è¡¨ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒESæ¨å‡ºäº†ä¸€ç§åµŒå¥—å¯¹è±¡çš„æ–¹æ¡ˆæ¥é€‚é…å¤šå±‚çº§çš„æ•°æ®ç»“æ„ã€‚<br>(1) åˆ›å»ºåµŒå¥—ç´¢å¼•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_nested_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span>                               <span class="comment">//åµŒå¥—ç±»å‹æ ‡è¯†</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;platform_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;account_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºåµŒå¥—æ•°æ®å¯¹è±¡accountså±æ€§æ˜¯nestedï¼Œè¡¨ç¤ºæ˜¯ä¸ªå†…åµŒæ–‡æ¡£ã€‚</p>
<p>(2) æ–°å¢åµŒå¥—å¯¹è±¡æ•°æ®ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_nested_index/_doc/<span class="number">123456789</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;åˆ›ä½œè€…111&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;Wade&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;wb7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;James&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;xhs7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(3) ç±»ä¼¼ä½¿ç”¨æ™®é€šå†…éƒ¨å¯¹è±¡æŸ¥è¯¢nameä¸ºPaulä¸”platformIdä¸º1çš„æ•°æ®ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                                    <span class="comment">//åµŒå¥—æŸ¥è¯¢</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span>  <span class="number">1</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸ŠæŸ¥è¯¢ç»“æœå³ä¸ºç©ºï¼Œå¯¹äºnestedå¯¹è±¡ï¼Œesä¼šå°†å…¶æŠ½å–å‡ºæ¥ä½œä¸ºç‹¬ç«‹çš„æ–‡æ¡£ï¼Œå¹¶ä¿ç•™æ–‡æ¡£ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œåœ¨æŸ¥è¯¢æ—¶ï¼ŒæŠŠç›¸åº”æ–‡æ¡£å…³è”èµ·æ¥ã€‚ç»“åˆåˆ›ä½œè€…ä¸»ä½“ï¼ˆçˆ¶çº§ï¼‰ä¸åµŒå¥—è´¦å·ï¼ˆå­çº§ï¼‰æŸ¥è¯¢ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å‘½ä¸­ç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_nested_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;userCommonId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªåˆ›ä½œè€…&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span>                            <span class="comment">//å‘½ä¸­æ•°æ®</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(4) åµŒå¥—èšåˆï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;byplatform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts.platformId&quot;</span>                  <span class="comment">//åµŒå¥—æ•°æ®èšåˆï¼Œæ ¹æ®å­çº§accountçš„platformIdåˆ†ç»„èšåˆ</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;byuserId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;reverse_nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>                           <span class="comment">//å›åˆ°çˆ¶çº§authoræ–‡æ¡£è¿›è¡Œæ“ä½œ</span></span><br><span class="line">                  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;userCommonId&quot;</span>               <span class="comment">//æ ¹æ®çˆ¶çº§userCommonIdè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">                      <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                 <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                                    <span class="comment">//å­çº§èšåˆæ ‡è¯†</span></span><br><span class="line">      <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span>                                                <span class="comment">//å‘½ä¸­æ–‡æ¡£æ€»æ•°</span></span><br><span class="line">      <span class="attr">&quot;byplatform&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                 <span class="comment">//å­çº§platformIdçš„åˆ†ç»„ç»“æœ    </span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span>                                                <span class="comment">//platfromId = 3 çš„æ€»æ•°ä¸º 2</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                        <span class="comment">//çˆ¶çº§userCommonIdåˆ†ç»„ç»“æœ</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-3-çˆ¶å­æ–‡æ¡£"><a href="#2-3-çˆ¶å­æ–‡æ¡£" class="headerlink" title="2.3 çˆ¶å­æ–‡æ¡£"></a>2.3 çˆ¶å­æ–‡æ¡£</h2><p>Eså¹¶ä¸æ˜¯åªæœ‰ä¸Šè¿°åµŒå¥—æ–‡æ¡£æ¥æ”¯æŒä¸šåŠ¡åœºæ™¯ä¸­å¤šå±‚çº§çš„æ•°æ®ç»“æ„ï¼ŒåµŒå¥—æ–‡æ¡£åœ¨æŸ¥è¯¢æ€§èƒ½ä¸æ•°æ®æ›´æ–°ä¸Šæœ‰éƒ¨åˆ†ç¼ºç‚¹ï¼ˆåé¢è¯´æ˜ï¼‰ï¼Œå¦å¤–Esè¿˜æä¾›çˆ¶å­æ–‡æ¡£çš„æ•°æ®ç»“æ„æ¥æ”¯æŒåµŒå¥—æ•°æ®ç»“æ„ã€‚<br>(1)Â åˆ›å»ºçˆ¶å­æ–‡æ¡£ç´¢å¼•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_join_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;author_account_join&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;join&quot;</span><span class="punctuation">,</span>                                 <span class="comment">//å®šä¹‰çˆ¶å­æ–‡æ¡£ç±»å‹</span></span><br><span class="line">        <span class="attr">&quot;relations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå®šä¹‰çˆ¶å­æ–‡æ¡£çš„å…³è”å…³ç³»ï¼Œjoinå…³é”®å­—è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªçˆ¶å­æ–‡æ¡£å…³ç³»ï¼Œrelationsé‡Œé¢è¡¨ç¤ºauthoræ˜¯çˆ¶ï¼Œaccountæ˜¯å­ã€‚</p>
<p>(2) åˆ›å»ºçˆ¶æ–‡æ¡£æ•°æ®:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_join_index/_doc/<span class="number">123456789</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;user_common_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…222&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author_account_join&quot;</span><span class="punctuation">:</span> <span class="string">&quot;author&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>author_account_join å­—æ®µéœ€è¦æŒ‡å®šè¯¥æ•°æ®å¯¹è±¡å±äºçˆ¶</p>
<p>(3) åˆ›å»ºå­æ–‡æ¡£æ•°æ®:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_join_index/_doc/james44?routing=<span class="number">123456789</span>&amp;refresh</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;james44&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;james&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author_account_join&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="number">123456789</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆ <span style="color: red;"> routing </span>å…³é”®å­—æŒ‡æ˜äº†è·¯ç”±çš„idæ˜¯çˆ¶æ–‡æ¡£123456789ï¼Œ author_account_joinå­—æ®µæ ‡è¯†è¯¥æ•°æ®å¯¹è±¡å±äºè´¦å·ï¼ˆå­çº§ï¼‰ï¼ŒåŒæ—¶æŒ‡å®šçˆ¶æ–‡æ¡£çš„ID<br><span style="color: red;"> æ³¨æ„ï¼šç´¢å¼•å­æ–‡æ¡£çš„æ—¶å€™ï¼Œroutingæ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºè¦ç¡®ä¿å­æ–‡æ¡£å’Œçˆ¶æ–‡æ¡£åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸Šã€‚</span></p>
<p>(4) çˆ¶å­æ–‡æ¡£æ•°æ®ç‰‡æ®µï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;user_common_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…222&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"> ......</span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;wade33&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;wade33&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;wade&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">123456789</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>ä»æ•°æ®ç‰‡æ®µå¯ä»¥çœ‹å‡ºï¼Œçˆ¶ã€å­æ–‡æ¡£å…·å¤‡å„è‡ªå”¯ä¸€idï¼Œæ— è®ºæ˜¯çˆ¶æ–‡æ¡£è¿˜æ˜¯å­æ–‡æ¡£éƒ½æ˜¯ç‹¬ç«‹çš„æ•°æ®å¯¹è±¡ï¼Œè¿™ç‚¹ä¸è·ŸåµŒå¥—å¯¹è±¡nestedä¸ä¸€æ ·</p>
<p>(5) å­æ–‡æ¡£æ•°æ®æŸ¥è¯¢:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸ŠæŸ¥è¯¢ä¸ºç©ºï¼Œè‹¥å°†platformIdæŸ¥è¯¢å‚æ•°æ›¿æ¢ä¸º2ï¼Œåˆ™æŸ¥è¯¢å‡ºå¯¹åº”æ•°æ®ï¼Œä½†ç”±äºçˆ¶å­æ–‡æ¡£äº’ç›¸ç‹¬ç«‹ï¼Œæ‰€ä»¥æŸ¥è¯¢ç»“æœè¿”å›çš„æ˜¯å­æ–‡æ¡£å¯¹åº”æ•°æ®ï¼Œå¹¶ä¸”å±•ç¤ºè¯¥å­æ–‡æ¡£çš„çˆ¶æ–‡æ¡£æ ‡è¯†ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.7917595</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.7917595</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(6) Has Child æŸ¥è¯¢,è¿”å›ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„çˆ¶æ–‡æ¡£æ•°æ®ï¼Œé€šè¿‡inner_hitså¸¦å‡ºå­æ–‡æ¡£æ•°æ®:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;has_child&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                      <span class="comment">//çˆ¶æ–‡æ¡£æ•°æ®</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;user_common_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…111&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inner_hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.7917595</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                            <span class="comment">//å­æ–‡æ¡£æ•°æ®</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.7917595</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(7) Has Parent æŸ¥è¯¢ï¼Œè¿”å›ç¬¦åˆæ¡ä»¶çš„ç›¸å…³çš„å­æ–‡æ¡£:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;has_parent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;parent_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;author&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…111&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test11&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test11&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;æµ‹è¯•è´¦å·11&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(8) å­æ–‡æ¡£èšåˆï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nickname&quot;</span>               <span class="comment">//é€šè¿‡çˆ¶æ–‡æ¡£çš„nicknameå­—æ®µåˆ†ç»„            </span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                          </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;platformId&quot;</span>    <span class="comment">//ä»¥ä¸åŒçš„platformIdæ¥è¿›è¡Œèšåˆ        </span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                 <span class="comment">//nickname èšåˆç»“æœ</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…111&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                        <span class="comment">//çˆ¶æ–‡æ¡£ä¸‹ä¸åŒå­æ–‡æ¡£ platformId çš„èšåˆç»“æœ</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>                              </span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;åˆ›ä½œè€…222&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                      <span class="comment">//çˆ¶æ–‡æ¡£ä¸‹ä¸åŒå­æ–‡æ¡£ platformId çš„èšåˆç»“æœ</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><span style="color: red;">æ³¨æ„ï¼šåœ¨çˆ¶-å­æ–‡æ¡£ä¸­æ”¯æŒå­æ–‡æ¡£èšåˆï¼Œä¸åµŒå¥—å¯¹è±¡çš„èšåˆç±»ä¼¼ã€‚ä½†æ˜¯ï¼Œå¯¹äºçˆ¶æ–‡æ¡£çš„èšåˆæŸ¥è¯¢æ˜¯ä¸æ”¯æŒï¼ˆå¦‚ åµŒå¥—å¯¹è±¡ä¸­ reverse_nestedï¼‰</span></p>
<h2 id="2-4-å¯¹æ¯”"><a href="#2-4-å¯¹æ¯”" class="headerlink" title="2.4 å¯¹æ¯”"></a>2.4 å¯¹æ¯”</h2><p>æ­¤å¤„ä¸»è¦å¯¹æ¯”åµŒå¥—å¯¹è±¡å’Œçˆ¶å­æ–‡æ¡£ï¼Œæ™®é€šå¯¹è±¡ä¸åšè¿‡å¤šè¯´æ˜</p>
<h3 id="2-4-1-åµŒå¥—å¯¹è±¡"><a href="#2-4-1-åµŒå¥—å¯¹è±¡" class="headerlink" title="2.4.1 åµŒå¥—å¯¹è±¡"></a>2.4.1 åµŒå¥—å¯¹è±¡</h3><p>(1) å½“å¯¹åµŒå¥—æ–‡æ¡£åšå¢åŠ ã€ä¿®æ”¹æˆ–è€…åˆ é™¤æ—¶ï¼Œä¸èƒ½ä»…ä¿®æ”¹çˆ¶çº§æ•°æ®æˆ–å­çº§æ•°æ®ï¼Œæ•´ä¸ªæ–‡æ¡£éƒ½è¦é‡æ–°è¢«ç´¢å¼•ã€‚åµŒå¥—æ–‡æ¡£è¶Šå¤šï¼Œè¿™å¸¦æ¥çš„æˆæœ¬å°±è¶Šå¤§ã€‚</p>
<p>(2) åµŒå¥—æŸ¥è¯¢ç»“æœè¿”å›çš„æ˜¯æ•´ä¸ªæ–‡æ¡£ï¼Œè€Œä¸ä»…ä»…æ˜¯åŒ¹é…çš„åµŒå¥—æ–‡æ¡£ã€‚ç›®å‰è¿˜ä¸æ”¯æŒåªè¿”å›æ ¹æ–‡æ¡£ä¸­æœ€ä½³åŒ¹é…çš„åµŒå¥—æ–‡æ¡£ã€‚ä½†æ˜¯å¯ä»¥åˆ©ç”¨ <span style="color: red;"> inner_hits </span> è·å–å†…éƒ¨å‘½ä¸­æ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                                    </span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span>  <span class="number">2</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>                                             <span class="comment">// å†…éƒ¨å‘½ä¸­æ ‡è¯†</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>                                                <span class="comment">//ä¸»æ–‡æ¡£å‘½ä¸­æ•°é‡</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                   <span class="comment">//å‘½ä¸­æ•°æ®ï¼ŒåŒ…å«çˆ¶çº§æ•°æ®å’Œå­çº§æ•°æ®</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_nested_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;userCommonId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªåˆ›ä½œè€…&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inner_hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                        <span class="comment">//å†…éƒ¨å‘½ä¸­æ ‡è¯†</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_nested_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_nested&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>                               <span class="comment">//å†…éƒ¨å‘½ä¸­å­çº§æ•°æ®</span></span><br><span class="line">                    <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(3) æ–‡æ¡£æ•°é‡ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_count</span><br><span class="line">ç»“æœï¼š</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span>               <span class="comment">//ä¸»æ–‡æ¡£æ€»æ•°</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">GET _cat/indices/author_account_nested_index</span><br><span class="line">ç»“æœï¼š</span><br></pre></td></tr></table></figure>
<p><img src="/../images/2.png" alt="5.png"><br>å¯¹äºç¬¬ä¸€ç§æŸ¥è¯¢æ–¹å¼ç›´æ¥è·å–çš„æ˜¯Esè¿”å›çš„æ–‡æ¡£æ•°é‡ï¼Œç¬¬äºŒç§æŸ¥è¯¢æ–¹å¼è¿”å›çš„æ˜¯åº•å±‚luceneå­˜å‚¨çš„æ–‡æ¡£æ•°é‡ï¼Œè¿™å…¶ä¸­åŒ…å«äº†ä¸»æ–‡æ¡£å’Œéšè—æ–‡æ¡£ï¼ˆnested å¯¹è±¡æ–‡æ¡£ï¼‰ï¼Œå®é™…ä¸Šå¯¹äºåµŒå¥—æ–‡æ¡£æŸ¥è¯¢æ—¶ï¼ŒEså†…éƒ¨è¾…åŠ©åšäº†ç±»ä¼¼joinçš„å¤„ç†ã€‚</p>
<h3 id="2-4-2-çˆ¶å­æ–‡æ¡£"><a href="#2-4-2-çˆ¶å­æ–‡æ¡£" class="headerlink" title="2.4.2 çˆ¶å­æ–‡æ¡£"></a>2.4.2 çˆ¶å­æ–‡æ¡£</h3><p>(1) çˆ¶å­æ–‡æ¡£ä¸ºäº’ç›¸ç‹¬ç«‹çš„æ–‡æ¡£å­˜å‚¨ï¼Œå¯¹æ–‡æ¡£åšå¢åŠ ã€åˆ é™¤æˆ–è€…ä¿®æ”¹çš„æ—¶å€™äº’ä¸å½±å“ã€‚</p>
<p>(2) æŸ¥è¯¢è”åˆè¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®ã€‚åŒæ—¶æ¯ä¸€ä»£çš„çˆ¶æ–‡æ¡£éƒ½è¦å°†å…¶å­—ç¬¦ä¸²ç±»å‹çš„ _id å­—æ®µå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¼šå ç”¨å¤§é‡å†…å­˜ã€‚</p>
<p>(3) åˆ›å»ºå­æ–‡æ¡£æ•°æ®æ—¶ï¼Œéœ€è¦ç»“åˆroutingå’Œçˆ¶æ–‡æ¡£Idå°†çˆ¶å­æ–‡æ¡£å­˜å‚¨åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸Šï¼Œå­æ–‡æ¡£æ•°æ®ä¾æ—§å¯å†åŠ å¤šå±‚çº§ï¼Œåªæ˜¯æ­¤æ—¶routingå€¼ä¸ºæ ¹æ–‡æ¡£idã€‚</p>
<p><span style="color: red;"> æ³¨æ„ï¼šå¦‚æœéœ€è¦æ”¹å˜ä¸€ä¸ªå­æ–‡æ¡£æ‰€å±çˆ¶æ–‡æ¡£IDå€¼ï¼Œä»…æ›´æ–°è¿™ä¸ªå­æ–‡æ¡£çš„çˆ¶æ ‡è¯†æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºæ–°çš„çˆ¶æ–‡æ¡£æœ‰å¯èƒ½åœ¨å¦å¤–ä¸€ä¸ªåˆ†ç‰‡ä¸Šã€‚å› æ­¤å¿…é¡»è¦å…ˆæŠŠå­æ–‡æ¡£åˆ é™¤ï¼Œç„¶åå†é‡æ–°ç´¢å¼•è¿™ä¸ªå­æ–‡æ¡£ã€‚</span></p>
<h3 id="2-4-3-æ€»ç»“"><a href="#2-4-3-æ€»ç»“" class="headerlink" title="2.4.3 æ€»ç»“"></a>2.4.3 æ€»ç»“</h3><p>(1) åµŒå¥—å¯¹è±¡é€šè¿‡å†—ä½™æ•°æ®æ¥é€‚é…å¤šå±‚çº§æ•°æ®ç»“æ„ï¼Œä½†æ˜¯ç”±äºæ›´æ–°æœºåˆ¶æ›´é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚çˆ¶å­æ–‡æ¡£ç±»ä¼¼å…³ç³»å‹æ•°æ®åº“ä¸­çš„å…³è”å…³ç³»ï¼Œå‡å°‘äº†æ–‡æ¡£ä¿®æ”¹èŒƒå›´ï¼Œé€‚ç”¨äºå†™å¤šçš„åœºæ™¯ã€‚</p>
<p>(2) åµŒå¥—å¯¹è±¡åœ¨åªæœ‰ä¸€ä¸ªä¸»è¦å®ä½“æ—¶éå¸¸æœ‰ç”¨ï¼ˆå¦‚åšå®¢ä¸è¯„è®ºçš„å…³ç³»ï¼Œé€šè¿‡è¯„è®ºå†…å®¹æœç´¢åšå®¢æ–‡ç« ï¼‰ï¼Œä½†æ˜¯éœ€è¦ä¸»æ–‡æ¡£å’Œå…¶å…³è”å®ä½“ä¹‹é—´åšä¸€ä¸ªå®Œæ•´çš„éš”ç¦»æ—¶ï¼Œçˆ¶å­æ–‡æ¡£æ›´åŠ åˆé€‚ã€‚</p>
<p>(3) åœ¨åˆ†çº§å®¡æ ¸éœ€æ±‚çš„ä½œè€…æ€»æŸ¥è¯¢ä¸­ï¼Œç”±äºæŸ¥è¯¢æ¡ä»¶æ¶‰åŠåˆ›ä½œè€…ï¼ˆçˆ¶ï¼‰ã€è´¦å·ï¼ˆå­ï¼‰çš„æŸ¥è¯¢æ¡ä»¶ï¼ŒåŒæ—¶åˆ†é¡µç»´åº¦ä¸ºåˆ›ä½œè€…ç»´åº¦ï¼Œå¯¹æ¯”è€ƒè™‘åµŒå¥—å¯¹è±¡æ›´é€‚ç”¨ã€‚</p>
<h3 id="2-4-4-æ³¨æ„äº‹é¡¹ï¼š"><a href="#2-4-4-æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="2.4.4 æ³¨æ„äº‹é¡¹ï¼š"></a>2.4.4 æ³¨æ„äº‹é¡¹ï¼š</h3><p>(1) æ— è®ºæ˜¯åµŒå¥—å¯¹è±¡è¿˜æ˜¯çˆ¶å­æ–‡æ¡£ï¼Œå…¶åœ¨åº•å±‚å­˜å‚¨ä¸Šéƒ½æœ‰ä¸€å®šçº¦æŸï¼Œè™½ç„¶Esæ”¯æŒè¿™æ ·å¤šå±‚çº§çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯ä¸å»ºè®®ä¸šåŠ¡ä¸Šä½¿ç”¨æ—¶æ— é™é€’å¢å±‚çº§ï¼Œå°½é‡åœ¨å¯¹å­çº§å‘½ä¸­æœ‰è¦æ±‚ã€æ•°æ®å±‚çº§å¯æ§èŒƒå›´å†…ä½¿ç”¨ï¼Œ<br>å¦åˆ™å¯èƒ½ä¼šé€ æˆæ€§èƒ½é—®é¢˜å¾—ä¸å¿å¤±ã€‚åµŒå¥—å¯¹è±¡å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼Œè®¾ç½®åµŒå¥—çš„å±‚çº§çº¦æŸï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_settings</span><br><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;index.mapping.nested_fields.limit&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span>                  <span class="comment">// ä¸€ä¸ªç´¢å¼•ä¸­ä¸åŒçš„ Nested å­—æ®µç±»å‹ä¸ªæ•°             </span></span><br><span class="line">  <span class="attr">&quot;index.mapping.nested_objects.limit&quot;</span><span class="punctuation">:</span> <span class="number">100</span>                 <span class="comment">// ä¸€ä¸ª Nested å­—æ®µä¸­å¯¹è±¡æ•°ç›®  </span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(2) æ™®é€šæŸ¥è¯¢ä¸­åµŒå¥—æ–‡æ¡£è¿”å›çš„æ—¶åŒ¹é…çš„æ•´ä¸ªæ–‡æ¡£æ•°æ®ï¼Œçˆ¶å­æ–‡æ¡£æŸ¥è¯¢æ—¶Has Child å’Œ Has ParentæŸ¥è¯¢çš„æ˜¯å•ä¸ªçˆ¶æ–‡æ¡£æˆ–å­æ–‡æ¡£ï¼Œæ‰€ä»¥ä¸Šè¿°æ¡ˆä¾‹ä¸­ä½¿ç”¨ inner_hits è¾…åŠ©æŸ¥è¯¢ï¼Œä½†æ˜¯ inner_hits å…³é”®å­—æ…ç”¨ï¼Œå®¹æ˜“é€ æˆæ€§èƒ½é—®é¢˜ï¼Œ<br>æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯åµŒå¥—æ–‡æ¡£çš„æ•°æ®è¿‡æ»¤å’Œå…³è”æŸ¥è¯¢å¯æ”¾åœ¨åº”ç”¨å±‚åšã€‚</p>
<h1 id="3-Esæ•°æ®å­˜å‚¨"><a href="#3-Esæ•°æ®å­˜å‚¨" class="headerlink" title="3.Esæ•°æ®å­˜å‚¨"></a>3.Esæ•°æ®å­˜å‚¨</h1><p>åœ¨ä¸Šé¢æåˆ°çˆ¶å­æ–‡æ¡£åœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ä½¿ç”¨routingæ¥æ§åˆ¶æ•°æ®å­˜å‚¨çš„åˆ†ç‰‡ï¼Œç»§ç»­äº†è§£ä¸‹Esä¸­åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨çš„æ¦‚å¿µã€‚</p>
<h2 id="3-1-åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨"><a href="#3-1-åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨" class="headerlink" title="3.1 åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨"></a>3.1 åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨</h2><p>ä¸€ä¸ª Lucene ç´¢å¼• åœ¨ Elasticsearch ç§°ä½œåˆ†ç‰‡ã€‚ ä¸€ä¸ª Elasticsearch ç´¢å¼•æ˜¯åˆ†ç‰‡çš„é›†åˆã€‚</p>
<p>å½“ Elasticsearch åœ¨ç´¢å¼•ä¸­æœç´¢çš„æ—¶å€™ï¼Œ å‘é€æŸ¥è¯¢åˆ°æ¯ä¸€ä¸ªå±äºç´¢å¼•çš„åˆ†ç‰‡(Lucene ç´¢å¼•)ï¼Œç„¶ååˆå¹¶æ¯ä¸ªåˆ†ç‰‡çš„ç»“æœåˆ°ä¸€ä¸ªå…¨å±€çš„ç»“æœé›†ã€‚</p>
<p>(1) åˆ†ç‰‡ï¼š</p>
<ul>
<li>Elasticsearch ç´¢å¼•ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä¸»åˆ†ç‰‡ä»¥åŠé›¶ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬åˆ†ç‰‡ç»„æˆ</li>
<li>åˆ†ç‰‡å¯ä»¥æ‹†åˆ†å¹¶æ‰©å±•æ•°æ®ï¼Œåˆ†ç‰‡åŒ…å«ç´¢å¼•æ•°æ®çš„å­é›†ï¼Œå¹¶ä¸”æœ¬èº«å…·æœ‰å®Œæ•´çš„åŠŸèƒ½å’Œç‹¬ç«‹æ€§</li>
<li>æ“ä½œå¯ä»¥åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡å¹¶è¡Œæé«˜æ€§èƒ½</li>
</ul>
<p>(2) ä¸»åˆ†ç‰‡ã€å‰¯æœ¬åˆ†ç‰‡</p>
<ul>
<li>æ•°æ®å†™å…¥ã€æ¢å¤é˜¶æ®µå‡ä¼šåœ¨ä¸»åˆ†ç‰‡ä¸Šæ‰§è¡Œï¼ŒæˆåŠŸåå†åˆ°å‰¯æœ¬åˆ†ç‰‡ä¸Šæ‰§è¡Œ</li>
<li>å‰¯æœ¬åˆ†ç‰‡æ°¸è¿œä¸ä¼šä¸ä¸»åˆ†ç‰‡åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¸»è¦ä½œç”¨æ˜¯æå‡é›†ç¾¤çš„é«˜å¯ç”¨ä¸æŸ¥è¯¢æ€§èƒ½<br><img src="/../images/3.png" alt="6.png"></li>
</ul>
<p>(3) åˆ†ç‰‡å­˜å‚¨è§„åˆ™ï¼š<span style="color: red;"> shard &#x3D; hash(routing) % number_of_primary_shards </span><br>routingï¼šé»˜è®¤æ˜¯æ–‡æ¡£IDï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼ˆçˆ¶å­æ–‡æ¡£ä¸­é€šè¿‡å®šä¹‰è¯¥å€¼å¼ºåˆ¶ä½¿å­æ–‡æ¡£ä¸çˆ¶æ–‡æ¡£åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸Šï¼‰<br>number_of_primary_shardsï¼šä¸»åˆ†ç‰‡æ•°é‡<br>æ‰€æœ‰æ–‡æ¡£çš„APIï¼ˆgetã€indexã€deleteã€bulkã€updateç­‰ï¼‰éƒ½æ”¯æŒroutingçš„è·¯ç”±å‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ–‡æ¡£åˆ°åˆ†ç‰‡çš„æ˜ å°„ã€‚</p>
<p>(4) æ–°å»ºã€åˆ é™¤æŸä¸ªæ–‡æ¡£</p>
<p><img src="/../images/4.png" alt="7.png"></p>
<ol>
<li>ä¸»åè°ƒèŠ‚ç‚¹æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li>
<li>æ ¹æ®_idç¡®å®šæ–‡æ¡£å±äºåˆ†ç‰‡ 0 ã€‚è¯·æ±‚ä¼šè¢«è½¬å‘åˆ°Node 3ï¼Œå› ä¸ºåˆ†ç‰‡ 0 çš„ä¸»åˆ†ç‰‡è¢«åˆ†é…åœ¨Node 3ä¸Šã€‚</li>
<li>ä¸»åˆ†ç‰‡æ‰§è¡Œå®¢æˆ·ç«¯è¯·æ±‚ï¼Œè‹¥æ‰§è¡ŒæˆåŠŸåˆ™è½¬å‘è¯¥è¯·æ±‚åˆ°å‰¯æœ¬åˆ†ç‰‡æ‰€åœ¨èŠ‚ç‚¹ï¼Œå‡æ‰§è¡ŒæˆåŠŸåNode 3å‘ŠçŸ¥åè°ƒèŠ‚ç‚¹æˆåŠŸå¹¶è¿”å›å®¢æˆ·ç«¯ã€‚</li>
</ol>
<p>(5) è·å–æŸæ–‡æ¡£<br>ç”±äºåˆ†ç‰‡æœºåˆ¶ï¼Œå¯ä»¥ä»ä¸»åˆ†ç‰‡æˆ–è€…ä»å…¶å®ƒä»»æ„å‰¯æœ¬åˆ†ç‰‡æ£€ç´¢æ–‡æ¡£<br><img src="/../images/5.png" alt="8.png"></p>
<ol>
<li>ä¸»åè°ƒèŠ‚ç‚¹æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚</li>
<li>é€šè¿‡æ–‡æ¡£ _id è®¡ç®—å±äºåˆ†ç‰‡0ï¼Œæ­¤æ—¶åˆ†ç‰‡0çš„å‰¯æœ¬åˆ†ç‰‡å’Œä¸»åˆ†ç‰‡å­˜åœ¨ä¸æ‰€æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥<span style="color: red;"> é»˜è®¤è½®è¯¢æœºåˆ¶ </span>ä¸‹ï¼Œè¯·æ±‚è¢«è½¬å‘åˆ°Node 2</li>
<li>Node 2 å°†è·å–æ–‡æ¡£ç»“æœè¿”å›ç»™Node 1ï¼Œæœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯</li>
</ol>
<p>(6) ä¸€è‡´æ€§å¤„ç†ï¼š<br>ä¸ºäº†é¿å…å‘ç”Ÿç½‘ç»œåˆ†åŒºæ•…éšœæ—¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼ŒEsåœ¨è¿›è¡Œå†™æ“ä½œæ—¶å¯è®¾ç½® consistencyï¼ˆä¸€è‡´æ€§ï¼‰å‚æ•°ã€‚çº¦æŸè§„åˆ™å¦‚ä¸‹ï¼š</p>
<p>åœ¨è¿›è¡Œå†™æ“ä½œä¹‹å‰ï¼Œä¸»åˆ†ç‰‡è¦æ±‚å¿…é¡»æœ‰â€è§„å®šæ•°é‡â€œçš„åˆ†ç‰‡å‰¯æœ¬ï¼ˆåŒ…æ‹¬ä¸»åˆ†ç‰‡æˆ–å‰¯æœ¬åˆ†ç‰‡ï¼‰å¤„äºå¯ç”¨çŠ¶æ€æ—¶ï¼Œæ‰å¯æˆåŠŸæ‰§è¡Œæœ¬æ¬¡çš„å†™æ“ä½œã€‚</p>
<p><span style="color: red;"> quorumï¼ˆè§„å®šæ•°é‡ï¼‰</span> &#x3D; ï¼ˆprimary + number_of_replicasï¼‰&#x2F; 2 + 1</p>
<p>consistency å‚æ•°å€¼å¯ä¸ºï¼šoneï¼ˆåªè¦ä¸»åˆ†ç‰‡çŠ¶æ€OKå°±å…è®¸æ‰§è¡Œå†™æ“ä½œï¼‰ã€allï¼ˆå¿…é¡»è¦æ‰€æœ‰ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡çŠ¶æ€å¯ç”¨æ‰å…è®¸æ‰§è¡Œï¼‰ã€quorumï¼ˆé»˜è®¤å€¼ã€è§„å®šæ•°é‡çš„åˆ†ç‰‡çŠ¶æ€å¯ç”¨å³å¯ï¼‰</p>
<p>ä»¥ä¸Šæ˜¯ç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹ï¼ŒEsæ˜¯ä¸ªåŠŸèƒ½å¤æ‚çš„æœç´¢å¼•æ“ï¼Œä¸åŒçš„ä¸šåŠ¡åœºæ™¯æœ‰ä¸åŒçš„ä½¿ç”¨æ–¹å¼ï¼ŒåŒæ—¶éœ€è¦éšç€ä¸šåŠ¡çš„å‘å±•ä¸æ–­ä¼˜åŒ–ã€‚æ¬¢è¿çº é”™ã€‚</p>
<h1 id="4-å‚è€ƒ"><a href="#4-å‚è€ƒ" class="headerlink" title="4. å‚è€ƒ"></a>4. å‚è€ƒ</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/joining-queries.html">Elasticsearch Guide [7.17]-Joining queries</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/distributed-docs.html">Elasticsearch Guide [7.17]-Distributed Document Store</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/07/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caleb">
      <meta itemprop="description" content="golangã€javaã€âš½ï¸ã€ğŸ€">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="caleb`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/07/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-07 16:59:41" itemprop="dateCreated datePublished" datetime="2024-03-07T16:59:41+08:00">2024-03-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">caleb</p>
  <div class="site-description" itemprop="description">golangã€javaã€âš½ï¸ã€ğŸ€</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">caleb</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
