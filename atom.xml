<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>caleb`s blog</title>
  
  <subtitle>体育迷&amp;程序员综合体</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2024-03-09T13:46:32.492Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>caleb</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Gotests剖析与扩展</title>
    <link href="http://example.com/2024/03/09/Gotests%E5%89%96%E6%9E%90%E4%B8%8E%E6%89%A9%E5%B1%95/"/>
    <id>http://example.com/2024/03/09/Gotests%E5%89%96%E6%9E%90%E4%B8%8E%E6%89%A9%E5%B1%95/</id>
    <published>2024-03-09T13:00:39.000Z</published>
    <updated>2024-03-09T13:46:32.492Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>说到golang项目的单元测试，gotests是一个绕不开的开源框架，它可以为函数生成表驱动测试，在生成之后再添加测试数据即可完成测试代码的编写。本文就gotests框架的实现机制以及在单元测试中的扩展实践展开。</p></blockquote><h1 id="1、gotests使用"><a href="#1、gotests使用" class="headerlink" title="1、gotests使用"></a>1、gotests使用</h1><ul><li>安装：</li></ul><p>go install github.com&#x2F;cweill&#x2F;gotests&#x2F;gotests</p><ul><li>代码生成：</li></ul><p>现有如下简单工具代码 swap.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> swap</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Swap exchanges s[i] and s[j].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Swap</span><span class="params">(s []<span class="keyword">interface</span>&#123;&#125;, i, j <span class="type">int</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;slice can&#x27;t be nil&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= <span class="built_in">len</span>(s)) || (j &lt; <span class="number">0</span> || j &gt;= <span class="built_in">len</span>(s)) &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;illegal index&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">s[i], s[j] = s[j], s[i]</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用命令：gotests -all -w …&#x2F;go&#x2F;src&#x2F;swap&#x2F;swap.go 即可生成关于 swap.go 文件中所有函数的表驱动测试形式的单元测试，包含在与 swap.go 同目录下的 swap_test.go 文件中，在 TODO 中添加测试数据即可完成函数的单元测试。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> swap</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSwap</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">s []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">i <span class="type">int</span></span><br><span class="line">j <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">name    <span class="type">string</span></span><br><span class="line">args    args</span><br><span class="line">wantErr <span class="type">bool</span></span><br><span class="line">&#125;&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add test cases.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := Swap(tt.args.s, tt.args.i, tt.args.j); (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">t.Errorf(<span class="string">&quot;Swap() error = %v, wantErr %v&quot;</span>, err, tt.wantErr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上函数中的实现都是基于go原生的方法实现，但是在业务代码中充满了各种外部依赖（RPC接口、Redis、DB查询等），最基础的业务代码结构为：Controller -&gt; Service -&gt; Dao ，如某service代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> testdata</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">struct</span> &#123;</span><br><span class="line">PersonService *service.PersonService <span class="string">`wired:&quot;true&quot;`</span></span><br><span class="line">PersonDao     *dao.PersonDao         <span class="string">`wired:&quot;true&quot;`</span></span><br><span class="line">Calculator    *Calculator            <span class="string">`wired:&quot;true&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserService)</span></span> GetUserInfo(id <span class="type">int</span>, name <span class="type">string</span>) (*model.UserInfo, <span class="type">error</span>) &#123;</span><br><span class="line">userInfo := &amp;model.UserInfo&#123;</span><br><span class="line">Id:  id * <span class="number">100</span>,</span><br><span class="line">Age: id * <span class="number">10</span>,</span><br><span class="line">&#125;</span><br><span class="line">person, err := u.PersonService.GetPersonInfo(id)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">userInfo.Name = person.FirstName + <span class="string">&quot;-&quot;</span> + name</span><br><span class="line"><span class="keyword">switch</span> id &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">userInfo.Address = <span class="string">&quot;LAC&quot;</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">userInfo.Address = <span class="string">&quot;LAL&quot;</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">userInfo.Address = <span class="string">&quot;PHX&quot;</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">userInfo.Address = <span class="string">&quot;OKC&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">subInfo := u.getSubInfo(id)</span><br><span class="line">userInfo.Address = subInfo + <span class="string">&quot;-&quot;</span> + userInfo.Address</span><br><span class="line"><span class="keyword">return</span> userInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserService)</span></span> getSubInfo(id <span class="type">int</span>) <span class="type">string</span> &#123;</span><br><span class="line">info := u.PersonDao.GetInfoByCondition(id)</span><br><span class="line"><span class="keyword">return</span> info + <span class="string">&quot;_subInfo&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时使用gotests原生命令也可以生成出如下的单元测试函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserService_GetUserInfo</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> fields <span class="keyword">struct</span> &#123;</span><br><span class="line">PersonService *service.PersonService</span><br><span class="line">PersonDao     *dao.PersonDao</span><br><span class="line">Calculator    *Calculator</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">id   <span class="type">int</span></span><br><span class="line">name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">name    <span class="type">string</span></span><br><span class="line">fields  fields</span><br><span class="line">args    args</span><br><span class="line">want    *model.UserInfo</span><br><span class="line">wantErr <span class="type">bool</span></span><br><span class="line">&#125;&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add test cases.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">u := &amp;UserService&#123;</span><br><span class="line">PersonService: tt.fields.PersonService,</span><br><span class="line">PersonDao:     tt.fields.PersonDao,</span><br><span class="line">Calculator:    tt.fields.Calculator,</span><br><span class="line">&#125;</span><br><span class="line">got, err := u.GetUserInfo(tt.args.id, tt.args.name)</span><br><span class="line"><span class="keyword">if</span> (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">t.Errorf(<span class="string">&quot;GetUserInfo() error = %v, wantErr %v&quot;</span>, err, tt.wantErr)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !reflect.DeepEqual(got, tt.want) &#123;</span><br><span class="line">t.Errorf(<span class="string">&quot;GetUserInfo() got = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到gotests依然可以帮助我们把依赖的外部结构体生成出来，并且创建统一的引用。但是当我们在写类似如上的业务代码的函数单元测试用例时，对于外部依赖的Service、Dao函数一般会采用mock的方式处理（此处不讨论该选用哪种mock方式，因为不同方式对于项目代码的整体结构要求不同），此时在生成出来的单测的 TODO 中就不光是填充参数与返回值那么简单了，必须考虑到如何让在每个用例中植入mock。</p><p>这么看来，好像gotests帮助我们做了很多，但是又好像不是很够？带着这个问题先来看下gotests的实现机制，可能慢慢就有了思路。</p><h1 id="2、AST机制"><a href="#2、AST机制" class="headerlink" title="2、AST机制"></a>2、AST机制</h1><p>gotests的核心原理之一是基于 <span style="color: red;">AST（抽象语法树）</span>解析目标go文件，主要包含以下步骤：</p><ul><li>读取命令行与环境变量中的参数设置</li><li>根据指定的 目录&#x2F;文件 异步协程通过ast解析出原始 *ast.File</li><li>通过 *ast.File 解析出文件公共部分：注释、包路径、引用路径</li><li>通过 *ast.File 解析出文件中函数部分：函数名称、参数、返回值等</li><li>返回整体的Result结构供模版解析</li></ul><p>AST 中包含很多元素，在gotests中主要引用到了以下几个AST元素。</p><p>(1) TOKEN<br>编程语言中最小的具有独立含义的词法单元，不仅包含关键字，还包含用户自定义的标识符、运算符、分隔符和注释等<br><img src="/../images/32.png" alt="32.png"></p><p>(2) 基础表达式<br>是完全由数值型面值和标识符组成的表达式，主要是指由一元和二元运算符组成的表达式，运算的主题是各种面值或标识符，基础表达式语法如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Expression = UnaryExpr | Expression binary_op Expression .</span><br><span class="line">UnaryExpr  = Operand | unary_op UnaryExpr .</span><br><span class="line">Operand    = Literal | identifier | <span class="string">&quot;(&quot;</span> Expression <span class="string">&quot;)&quot;</span> .</span><br><span class="line"></span><br><span class="line">binary_op  = <span class="string">&quot;||&quot;</span> | <span class="string">&quot;&amp;&amp;&quot;</span> | rel_op | add_op | mul_op .</span><br><span class="line">rel_op     = <span class="string">&quot;==&quot;</span> | <span class="string">&quot;!=&quot;</span> | <span class="string">&quot;&lt;&quot;</span> | <span class="string">&quot;&lt;=&quot;</span> | <span class="string">&quot;&gt;&quot;</span> | <span class="string">&quot;&gt;=&quot;</span> .</span><br><span class="line">add_op     = <span class="string">&quot;+&quot;</span> | <span class="string">&quot;-&quot;</span> | <span class="string">&quot;|&quot;</span> | <span class="string">&quot;^&quot;</span> .</span><br><span class="line">mul_op     = <span class="string">&quot;*&quot;</span> | <span class="string">&quot;/&quot;</span> | <span class="string">&quot;%&quot;</span> | <span class="string">&quot;&lt;&lt;&quot;</span> | <span class="string">&quot;&gt;&gt;&quot;</span> | <span class="string">&quot;&amp;&quot;</span> | <span class="string">&quot;&amp;^&quot;</span> .</span><br><span class="line"></span><br><span class="line">unary_op   = <span class="string">&quot;+&quot;</span> | <span class="string">&quot;-&quot;</span> | <span class="string">&quot;!&quot;</span> | <span class="string">&quot;^&quot;</span> | <span class="string">&quot;*&quot;</span> | <span class="string">&quot;&amp;&quot;</span> | <span class="string">&quot;&lt;-&quot;</span> .</span><br></pre></td></tr></table></figure><p>通过分析 go&#x2F;ast 包的文档，可以发现很多类型以 Expr 为后缀名的结构体，这是ast中的表达式承载形式，如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BadExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> BinaryExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> CallExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> Expr <span class="keyword">interface</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> ExprStmt <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> IndexExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> KeyValueExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> ParenExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> SelectorExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> SliceExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> StarExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> TypeAssertExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="keyword">type</span> UnaryExpr <span class="keyword">struct</span>&#123; ... &#125;</span><br></pre></td></tr></table></figure><p>(3) 代码结构<br>一个go文件中，顶级的语法元素有：package、import、type、const、var和func这几种，对应的结构如下：<br><img src="/../images/33.png" alt="33.png"></p><p>(4) 函数声明<br>函数的声明对应 *ast.FuncDecl 类型，它的定义如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FuncDecl <span class="keyword">struct</span> &#123;</span><br><span class="line">Doc  *CommentGroup <span class="comment">// associated documentation; or nil</span></span><br><span class="line">Recv *FieldList    <span class="comment">// receiver (methods); or nil (functions)</span></span><br><span class="line">Name *Ident        <span class="comment">// function/method name</span></span><br><span class="line">Type *FuncType     <span class="comment">// function signature: parameters, results, and position of &quot;func&quot; keyword</span></span><br><span class="line">Body *BlockStmt    <span class="comment">// function body; or nil for external (non-Go) function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如现在有如下函数声明，对应ast解析的结构为：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *xType)</span></span> Hello(arg1, arg2 <span class="type">int</span>) (<span class="type">bool</span>, <span class="type">error</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure><p><img src="/../images/34.png" alt="34.png"></p><p>(5) 语句和语句块<br>语句块和语句时在函数体部分定义，函数体就是一个语句块（如上述函数声明中的 <span style="color: red;">ast.BlockStmt</span>）。主要包括：表达式语句、返回语句、声明语句、分支语句、类型断言等。语句块的语法规范如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FunctionBody  = Block .</span><br><span class="line"></span><br><span class="line">Block         = <span class="string">&quot;&#123;&quot;</span> StatementList <span class="string">&quot;&#125;&quot;</span> .</span><br><span class="line">StatementList = &#123; Statement <span class="string">&quot;;&quot;</span> &#125; .</span><br><span class="line"></span><br><span class="line">Statement     = Declaration | LabeledStmt | SimpleStmt</span><br><span class="line">              | GoStmt | ReturnStmt | BreakStmt | ContinueStmt | GotoStmt</span><br><span class="line">              | FallthroughStmt | Block | IfStmt | SwitchStmt | SelectStmt | ForStmt</span><br><span class="line">              | DeferStmt</span><br><span class="line">              .</span><br></pre></td></tr></table></figure><p>介绍完上面的抽象的概念之后，看一下如果将 1 中的 service 通过ast解析之后应该是包含哪些内容（文件内容过长，此处直接挂文件）：<br><img src="/../images/ast%E8%A7%A3%E6%9E%90%E6%96%87%E4%BB%B6.docx" alt="ast.docx"></p><p>与上述ast元素关联可以重点关注文档中红色标识部分或以下关键字部分：</p><p>结构体定义（*ast.GenDecl ）- 39行</p><p>函数定义（*ast.FuncDecl ）-156行</p><p>函数体语句块（Body: *ast.BlockStmt ）- 258行</p><p>依赖函数引用（*ast.CallExpr ）- 365行</p><p>私有函数引用（*ast.CallExpr ）-650行</p><p>返回语句块（*ast.ReturnStmt ）-723行</p><p>在gotests中便是通过ast解析出go文件的内容，并通过一系列的词法和语法分析将抽取出生成单元测试用例所需的各种元素。</p><h1 id="3、模版渲染"><a href="#3、模版渲染" class="headerlink" title="3、模版渲染"></a>3、模版渲染</h1><p>golang 的 text&#x2F;template 包是一个数据驱动的模版渲染工具。提供条件判断、数组或map遍历、参数赋值、函数或方法调用、自定义函数扩展、模版嵌套及重用等功能。基于该工具，可以轻松实现各种复杂场景的文本渲染和文件创建。</p><p>一般而言，模版使用流程分为三个步骤：定义模版、解析模版、数据渲染模版。简单来讲，主要有以下方法：</p><ul><li><p>template.New</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(name <span class="type">string</span>)</span></span> *Template</span><br></pre></td></tr></table></figure><p>创建名为：name的模版</p></li><li><p>template.Parse</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Template)</span></span> Parse(text <span class="type">string</span>) (*Template, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>将字符串test内容解析为模版，如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//模板变量</span></span><br><span class="line">    <span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">        Id   <span class="type">int</span></span><br><span class="line">        Name <span class="type">string</span></span><br><span class="line">    &#125;</span><br><span class="line">    user := User&#123;<span class="number">100</span>, <span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line">    <span class="comment">//创建模板</span></span><br><span class="line">    tplname := <span class="string">&quot;user&quot;</span></span><br><span class="line">    tmpl := template.New(tplname)</span><br><span class="line">    <span class="comment">//解析模板</span></span><br><span class="line">    text := <span class="string">&quot;id = &#123;&#123;.Id&#125;&#125; name = &#123;&#123;.Name&#125;&#125;&quot;</span></span><br><span class="line">    tpl, err := tmpl.Parse(text)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//渲染输出</span></span><br><span class="line">    err = tpl.Execute(os.Stdout, user)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">==========================================</span><br><span class="line">id = <span class="number">100</span> name = admin</span><br></pre></td></tr></table></figure></li><li><p>template.ParseFiles<br>接收一个字符串，字符串的内容是一个模版文件的路径，并解析该模版文件</p></li><li><p>template.Execute</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Template)</span></span> Execute(wr io.Writer, data <span class="keyword">interface</span>&#123;&#125;) (err <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>将解析好的模版应用到data，并将输出写入wr。模版可以安全的并发执行。<br>在gotests框架中便是先将已定义好的模版文件内容压缩（提升创建文件的效率），然后将通过ast解析后的结果，输出到已定义好的模版内容中，通过模版引擎创建出不同go文件对应的单元测试用例。<br><img src="/../images/35.png" alt="35.png"><br>核心的模版文件function.tmpl 文件内容如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;define <span class="string">&quot;function&quot;</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- $f := .&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span></span> &#123;&#123;.TestName&#125;&#125;(t *testing.T) &#123;</span><br><span class="line">&#123;&#123;- with .Receiver&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .IsStruct&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Fields&#125;&#125;</span><br><span class="line"><span class="keyword">type</span> fields <span class="keyword">struct</span> &#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> .Fields&#125;&#125;</span><br><span class="line">&#123;&#123;Field .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .TestParameters&#125;&#125;</span><br><span class="line"><span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> .TestParameters&#125;&#125;</span><br><span class="line">&#123;&#123;Param .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">tests := &#123;&#123; <span class="keyword">if</span> .Named&#125;&#125;<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">struct</span>&#123;&#123;<span class="keyword">else</span>&#125;&#125;[]<span class="keyword">struct</span>&#123;&#123;end&#125;&#125; &#123;</span><br><span class="line">&#123;&#123; <span class="keyword">if</span> (not .Named)&#125;&#125;name <span class="type">string</span>&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;- with .Receiver&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> and .IsStruct .Fields&#125;&#125;</span><br><span class="line">fields fields</span><br><span class="line">&#123;&#123;- <span class="keyword">else</span>&#125;&#125;</span><br><span class="line">&#123;&#123;Receiver .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .TestParameters&#125;&#125;</span><br><span class="line">args args</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> .TestResults&#125;&#125;</span><br><span class="line">&#123;&#123;Want .&#125;&#125; &#123;&#123;.Type&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .ReturnsError&#125;&#125;</span><br><span class="line">wantErr <span class="type">bool</span></span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#125;&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Add test cases.  base</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> &#123;&#123;<span class="keyword">if</span> (or .Subtests (not .IsNaked))&#125;&#125; &#123;&#123;<span class="keyword">if</span> .Named&#125;&#125;name&#123;&#123;<span class="keyword">else</span>&#125;&#125;_&#123;&#123;end&#125;&#125;, tt := &#123;&#123;end&#125;&#125; <span class="keyword">range</span> tests &#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Subtests&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Parallel&#125;&#125;tt := tt;&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> and .Parallel .Named&#125;&#125;name := name;&#123;&#123; end &#125;&#125;</span><br><span class="line">t.Run(&#123;&#123;<span class="keyword">if</span> .Named&#125;&#125;name&#123;&#123;<span class="keyword">else</span>&#125;&#125;tt.name&#123;&#123;end&#125;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Parallel&#125;&#125;t.Parallel()&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- with .Receiver&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .IsStruct&#125;&#125;</span><br><span class="line">&#123;&#123;Receiver .&#125;&#125; := &#123;&#123;<span class="keyword">if</span> .Type.IsStar&#125;&#125;&amp;&#123;&#123;end&#125;&#125;&#123;&#123;.Type.Value&#125;&#125;&#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> .Fields&#125;&#125;</span><br><span class="line">&#123;&#123;.Name&#125;&#125;: tt.fields.&#123;&#123;Field .&#125;&#125;,</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> .Parameters&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .IsWriter&#125;&#125;</span><br><span class="line">&#123;&#123;Param .&#125;&#125; := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> and (not .OnlyReturnsError) (not .OnlyReturnsOneValue) &#125;&#125;</span><br><span class="line">&#123;&#123;template <span class="string">&quot;results&quot;</span> $f&#125;&#125; &#123;&#123;template <span class="string">&quot;call&quot;</span> $f&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .ReturnsError&#125;&#125;</span><br><span class="line"><span class="keyword">if</span> &#123;&#123;<span class="keyword">if</span> .OnlyReturnsError&#125;&#125; err := &#123;&#123;template <span class="string">&quot;call&quot;</span> $f&#125;&#125;; &#123;&#123;end&#125;&#125; (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">t.Errorf(<span class="string">&quot;&#123;&#123;template &quot;</span>message<span class="string">&quot; $f&#125;&#125; error = %v, wantErr %v&quot;</span>, &#123;&#123;template <span class="string">&quot;inputs&quot;</span> $f&#125;&#125; err, tt.wantErr)</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .TestResults&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="keyword">if</span> .Subtests &#125;&#125;<span class="keyword">return</span>&#123;&#123;<span class="keyword">else</span>&#125;&#125;<span class="keyword">continue</span>&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> .TestResults&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .IsWriter&#125;&#125;</span><br><span class="line"><span class="keyword">if</span> &#123;&#123;Got .&#125;&#125; := &#123;&#123;Param .&#125;&#125;.String(); &#123;&#123;Got .&#125;&#125; != tt.&#123;&#123;Want .&#125;&#125; &#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">else</span> <span class="keyword">if</span> .IsBasicType&#125;&#125;</span><br><span class="line"><span class="keyword">if</span> &#123;&#123;<span class="keyword">if</span> $f.OnlyReturnsOneValue&#125;&#125;&#123;&#123;Got .&#125;&#125; := &#123;&#123;template <span class="string">&quot;inline&quot;</span> $f&#125;&#125;; &#123;&#123;end&#125;&#125; &#123;&#123;Got .&#125;&#125; != tt.&#123;&#123;Want .&#125;&#125; &#123;</span><br><span class="line">&#123;&#123;- <span class="keyword">else</span>&#125;&#125;</span><br><span class="line"><span class="keyword">if</span> &#123;&#123;<span class="keyword">if</span> $f.OnlyReturnsOneValue&#125;&#125;&#123;&#123;Got .&#125;&#125; := &#123;&#123;template <span class="string">&quot;inline&quot;</span> $f&#125;&#125;; &#123;&#123;end&#125;&#125; !reflect.DeepEqual(&#123;&#123;Got .&#125;&#125;, tt.&#123;&#123;Want .&#125;&#125;) &#123;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">t.Errorf(<span class="string">&quot;&#123;&#123;template &quot;</span>message<span class="string">&quot; $f&#125;&#125; &#123;&#123;if $f.ReturnsMultiple&#125;&#125;&#123;&#123;Got .&#125;&#125; &#123;&#123;end&#125;&#125;= %v, want %v&quot;</span>, &#123;&#123;template <span class="string">&quot;inputs&quot;</span> $f&#125;&#125; &#123;&#123;Got .&#125;&#125;, tt.&#123;&#123;Want .&#125;&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;- end&#125;&#125;</span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> .Subtests &#125;&#125; &#125;) &#123;&#123;- end -&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure><p>了解完gotests中以上两个核心内容之后可以简单概括出，该框架的整体的工作流程大致如下：<br><img src="/../images/36.png" alt="36.png"><br>接下来回到上面抛出的问题，在这个流程之中其实我们可以简单扩展一下。</p></li></ul><h1 id="4、扩展"><a href="#4、扩展" class="headerlink" title="4、扩展"></a>4、扩展</h1><p>gotests本身其实可扩展性还是挺高的，它自身提供很多初始化命令可以给我们不同场景下的单测提供解决方案，同时源码中也扩展了基于testify的单测模版，只需要通过初始化命令 template 指定即可。如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">-all                  generate tests <span class="keyword">for</span> all functions and methods</span><br><span class="line"></span><br><span class="line">-excl                 regexp. generate tests <span class="keyword">for</span> functions and methods that don<span class="string">&#x27;t</span></span><br><span class="line"><span class="string">                       match. Takes precedence over -only, -exported, and -all</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-exported             generate tests for exported functions and methods. Takes</span></span><br><span class="line"><span class="string">                       precedence over -only and -all</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-i                    print test inputs in error messages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-only                 regexp. generate tests for functions and methods that match only.</span></span><br><span class="line"><span class="string">                       Takes precedence over -all</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-nosubtests           disable subtest generation when &gt;= Go 1.7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-parallel             enable parallel subtest generation when &gt;= Go 1.7.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-w                    write output to (test) files instead of stdout</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template_dir         Path to a directory containing custom test code templates. Takes</span></span><br><span class="line"><span class="string">                       precedence over -template. This can also be set via environment</span></span><br><span class="line"><span class="string">                       variable GOTESTS_TEMPLATE_DIR</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template             Specify custom test code templates, e.g. testify. This can also</span></span><br><span class="line"><span class="string">                       be set via environment variable GOTESTS_TEMPLATE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template_params_file read external parameters to template by json with file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-template_params      read external parameters to template by json with stdin</span></span><br></pre></td></tr></table></figure><p>其中 template_dir 便是可以自定义指定模版的路径，template_params 可以向模版文件中输入自定义的内容。这么一看是不是渐渐有思路了，我们可以根据原始的模版文件做一些修改，满足不同项目中的代码特性来生成单元测试文件。</p><ul><li>函数体解析<br>通过对gotests框架的了解发现，它并没有对函数体内部的内容进行解析，这便是上述问题说的当业务代码遇到的外部依赖的函数调用时如何进行mock。要知道如何mock肯定需要首先知道哪些部分需要进行mock，并且mock的内容是什么样的。</li></ul><p>上述流程说到gotests有一部分函数解析的步骤，在这个环节中可以加入对函数体的解析，分析出外部调用。在 go&#x2F;ast 中提供 Inspect 函数可对指定类型中的内容按照深度优先检索方法（depth-first order）遍历语法树，此时我们需要判断该节点是否为外部调用即可，如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inspect traverses an AST in depth-first order: It starts by calling</span></span><br><span class="line"><span class="comment">// f(node); node must not be nil. If f returns true, Inspect invokes f</span></span><br><span class="line"><span class="comment">// recursively for each of the non-nil children of node, followed by a</span></span><br><span class="line"><span class="comment">// call of f(nil).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Inspect</span><span class="params">(node Node, f <span class="keyword">func</span>(Node)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">Walk(inspector(f), node)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过对ast中的元素定义了解到，*ast.CallExpr 为函数调用的节点元素，所以解析函数体的主体逻辑可以如下：<br><img src="/../images/37.png" alt="37.png"><br>代码块如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 深度遍历解析</span></span><br><span class="line">ast.Inspect(funcDecl.Body, <span class="function"><span class="keyword">func</span><span class="params">(n ast.Node)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="comment">// Find assign Statements</span></span><br><span class="line">retAssign, okAssign := n.(*ast.AssignStmt)</span><br><span class="line"><span class="keyword">if</span> okAssign &#123;</span><br><span class="line"><span class="comment">// Find CallExpr Statement</span></span><br><span class="line">ast.Inspect(retAssign, <span class="function"><span class="keyword">func</span><span class="params">(a ast.Node)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">retCall, okCall := a.(*ast.CallExpr)</span><br><span class="line"><span class="keyword">if</span> okCall &#123;</span><br><span class="line">resultCount := <span class="built_in">len</span>(retAssign.Lhs)</span><br><span class="line"><span class="comment">// 判断是否为业务函数调用</span></span><br><span class="line">subFunctions = parseFuncCallExpr(retCall, resultCount, functionList, subFunctions, relFunctionMap,</span><br><span class="line">functionDecls)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li><p>公共gomonkey单测文件 <br>通过以上逻辑便可以解析出函数体内的外部函数调用的信息，接下来只需要考虑如何基于这些信息构建业务所需的mock调用即可。在目前团队业务中底层采用的是 gomonkey 的mock模式，并将通用的断言判断、mock目标函数写到同目录下的公共文件base_test.go 中，尽量减少重复代码，如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Hook <span class="keyword">struct</span> &#123;</span><br><span class="line">target   <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">returns  []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">function <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HookList</span><span class="params">(f ...Hook)</span></span> []Hook &#123;</span><br><span class="line"><span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HookReturn</span><span class="params">(target <span class="keyword">interface</span>&#123;&#125;, returns ...<span class="keyword">interface</span>&#123;&#125;)</span></span> Hook &#123;</span><br><span class="line"><span class="keyword">return</span> Hook&#123;target: target, returns: returns&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HookFunc</span><span class="params">(target <span class="keyword">interface</span>&#123;&#125;, function <span class="keyword">interface</span>&#123;&#125;)</span></span> Hook &#123;</span><br><span class="line"><span class="keyword">return</span> Hook&#123;target: target, function: function&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hook</span><span class="params">(h Hook)</span></span> &#123;</span><br><span class="line">val := reflect.ValueOf(h.target)</span><br><span class="line"><span class="keyword">if</span> h.function != <span class="literal">nil</span> &#123;</span><br><span class="line">gomonkey.NewPatches().ApplyCore(val, reflect.ValueOf(h.function))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">gomonkey.NewPatches().ApplyCore(val, reflect.MakeFunc(val.Type(), <span class="function"><span class="keyword">func</span><span class="params">(args []reflect.Value)</span></span> (results []reflect.Value) &#123;</span><br><span class="line"><span class="keyword">var</span> res []reflect.Value</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> h.returns &#123;</span><br><span class="line"><span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">res = <span class="built_in">append</span>(res, reflect.Zero(val.Type().Out(k)))</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">res = <span class="built_in">append</span>(res, reflect.ValueOf(v))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunTest</span><span class="params">(f <span class="keyword">interface</span>&#123;&#125;, tt <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">args := reflect.ValueOf(tt).FieldByName(<span class="string">&quot;Args&quot;</span>)</span><br><span class="line">hooks := reflect.ValueOf(tt).FieldByName(<span class="string">&quot;Hook&quot;</span>)</span><br><span class="line">want := reflect.ValueOf(tt).FieldByName(<span class="string">&quot;Want&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; hooks.Len(); i++ &#123;</span><br><span class="line">hook(hooks.Index(i).Interface().(Hook))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> param []reflect.Value</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; args.NumField(); i++ &#123;</span><br><span class="line">param = <span class="built_in">append</span>(param, args.Field(i))</span><br><span class="line">&#125;</span><br><span class="line">ret := reflect.ValueOf(f).Call(param)</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> ret &#123;</span><br><span class="line"><span class="keyword">if</span> !reflect.DeepEqual(v.Interface(), want.Field(k).Interface()) &#123;</span><br><span class="line">t.Errorf(<span class="string">&quot;get = %v, want = %v&quot;</span>, v.Interface(), want.Field(k).Interface())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>自定义模版</p></li></ul><p>通过以上分析可以看出，解析出函数体中的外部调用、创建公共mock文件之后，接下来只需要基于原生的gotests模版做修改即可。修改的重点在：</p><p>(1) tests 结构体对象构建：包含Hook对象、参数对象、返回值对象<br>(2) 在原生的 TODO 中填充进外部函数的mock调用内容<br>(3) 单元测试的最终执行（调用base_test.go 中断言判断）</p><p><img src="/../images/38.png" alt="38.png"></p><p>经过以上三个步骤的扩展，gotests的工作流程现如下：</p><p><img src="/../images/39.png" alt="39.png"></p><p>注：是否屏蔽私有函数的设计有待商榷，在以上的流程中会以公有函数为单元测试用例的入口，遇到私有函数调用时会接着解析该私有函数中的外部依赖函数并统一生成mock调用信息。</p><p>扩展之后，使用gotests原生命令并指定自定义的template（需压缩所有模版并集成到gotests源码中）创建的单测用例如下：</p><p>gotests -all -w -template itea user_service.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserService_GetUserInfo</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">                <span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">                        Id   <span class="type">int</span></span><br><span class="line">                        Name <span class="type">string</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">type</span> ret <span class="keyword">struct</span> &#123;</span><br><span class="line">                        Want *model.UserInfo</span><br><span class="line">                        Err  <span class="type">error</span></span><br><span class="line">                &#125;</span><br><span class="line">                tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">                        Name <span class="type">string</span></span><br><span class="line">                        Hook []Hook</span><br><span class="line">                        Args args</span><br><span class="line">                        Want ret</span><br><span class="line">                &#125;&#123;</span><br><span class="line">                        &#123;<span class="string">&quot;test1&quot;</span>, HookList(</span><br><span class="line">                              HookReturn((*service.PersonService).GetPersonInfo, <span class="literal">nil</span>, <span class="literal">nil</span>),</span><br><span class="line">                              HookReturn((*dao.PersonDao).GetInfoByCondition, <span class="literal">nil</span>),</span><br><span class="line">                        ), args&#123;&#125;, ret&#123;&#125;&#125;,</span><br><span class="line">                &#125;</span><br><span class="line">                U := &amp;UserService&#123;</span><br><span class="line">                        PersonService: &amp;service.PersonService&#123;&#125;,</span><br><span class="line">                        PersonDao: &amp;dao.PersonDao&#123;&#125;,</span><br><span class="line">                        Calculator: &amp;Calculator&#123;&#125;,</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">                        t.Run(tt.Name, RunTest(U.GetUserInfo, tt))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>此时需要完善用例内容需要：<span style="color: red;">补充mock函数的返回值、单测目标函数的参数与返回值</span>即可</p><h1 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h1><p>(1) 以上基于gotests源码的扩展依然有待完善的地方：对于外部依赖的mock调用，暂时还未能解析出对应的返回值类型，需要手动去填充。因为ast解析的逻辑关注的当前文件，对于import的内容只是做展示，后续的解决思路可以根据import的内容，解析项目路径中的结构体类型并获取到mock函数的返回值类型用作构建完整的mock调用</p><p>(2) 如何平衡人工写单测带来的人力损耗和自动化的单元测试的优劣一直是开发人员争论不断的话题，严格来说越是省时省力的自动化生成式的单测，同样也损失了很多其他的收益，如：开发人员对代码结构的设计思考、重构是否友好等。总而言之，个人认为单元测试一定是一个有价值的事情，不同业务特性不同、历史包袱不一样，对于单测落地的方式也不同。但是也不能只为了单测而去写单测用例，更多的可能是为了整体的代码结构设计、边界情况考虑、维护性考虑等。</p><p><span style="color: red;">补充：以上是本人基于使用gotests的一点思考与扩展，如有理解不到位的情况，欢迎批评指正或一起讨论关于单元测试落地的更多可行方案。</span></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;说到golang项目的单元测试，gotests是一个绕不开的开源框架，它可以为函数生成表驱动测试，在生成之后再添加测试数据即可完成测试代码的编写。本文就gotests框架的实现机制以及在单元测试中的扩展实践展开。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
      
    
    
    
    
    <category term="gotests、单元测试、mock" scheme="http://example.com/tags/gotests%E3%80%81%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%81mock/"/>
    
  </entry>
  
  <entry>
    <title>gorm剖析与实践</title>
    <link href="http://example.com/2024/03/07/gorm%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <id>http://example.com/2024/03/07/gorm%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E8%B7%B5/</id>
    <published>2024-03-07T12:02:14.000Z</published>
    <updated>2024-03-08T10:07:40.414Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>作为golang中代表性的orm框架，它是如何实现的？有哪些特点？如何利用它提升开发效率？</p></blockquote><h1 id="1、GORM概述"><a href="#1、GORM概述" class="headerlink" title="1、GORM概述"></a>1、GORM概述</h1><p>之前工作经历中使用java比较多，在ORM方面主要使用Mybatis，并做过一些扩展，如：基于拦截器实现动态数据权限。这里简单记录下学习gorm原理的过程。</p><p>什么是ORM？</p><p>ORM：对象关系映射（Object Relational Mapping）是通过使用描述对象和数据库之间映射的元数据，将面向对象语言程序中的对象自动持久化到关系数据库中。对应关系如下：<br><img src="/../images/6.png" alt="6.png"></p><p>ORM 框架相当于对象和数据库中间的一个桥梁，借助 ORM 可以避免写重复而繁琐的 SQL 语句，仅仅通过操作某个具体的对象，就能够完成对关系型数据库的基础性操作。</p><p>什么是gorm？</p><p>GORM：The fantastic ORM library for Golang aims to be developer friendly.</p><p>在gorm官网中这样描述该框架：一款出色且对开发人员友好的golang orm库。同时具备如下特性：</p><ul><li>全功能 ORM</li><li>关联 (Has One，Has Many，Belongs To，Many To Many)</li><li>Create，Save，Update，Delete，Find 中钩子方法</li><li>支持 Preload、Joins 的预加载</li><li>事务，嵌套事务，Save Point，Rollback To Saved Point</li><li>Context，预编译模式，DryRun 模式</li><li>批量插入，FindInBatches，Find&#x2F;Create with Map，使用 SQL 表达式、Context Valuer 进行 CRUD</li><li>SQL 构建器，Upsert，数据库锁，Optimizer&#x2F;Index&#x2F;Comment Hint，命名参数，子查询</li><li>复合主键，索引，约束</li><li>灵活的可扩展插件 API：Database Resolver（多数据库，读写分离）、Prometheus…</li><li>开发者友好</li></ul><p>基于此我们来看看gorm的一些基础使用和实现原理，同时如何利用该框架的特性提升应用开发效率。</p><h1 id="2、核心对象"><a href="#2、核心对象" class="headerlink" title="2、核心对象"></a>2、核心对象</h1><p>通过生成gorm的类图关系不难看出，首先有如下几个核心对象支撑gorm再dao层与数据库之间的代码运行。<br><img src="/../images/7.png" alt="7.png"></p><p>DB：gorm全局对象</p><p>Config：全局配置，如：事务开关、自定义命名策略、预编译开关、健康检查等配置</p><p>Statement：SQL描述对象</p><h1 id="3、一次简单的查询发生了什么"><a href="#3、一次简单的查询发生了什么" class="headerlink" title="3、一次简单的查询发生了什么"></a>3、一次简单的查询发生了什么</h1><p><img src="/../images/8.png" alt="8.png"></p><p>在业务开发过程中首先应当定义与数据表相映射的业务对象，如上图的User对象，关于对象的定义与规则不做过多阐述，主要描述gorm在完成数据库DML过程中的细节。</p><h2 id="3-1-初始化"><a href="#3-1-初始化" class="headerlink" title="3.1 初始化"></a>3.1 初始化</h2><p>此过程即完成以上核心对象的初始化动作，gorm通过对外暴露的open方法进行DB和Statement对象初始化，同时在该方法中可通过参数设置Config中的公开特性。<br><img src="/../images/9.png" alt="9.png"></p><p>在Open方法中有两个操作比较重要：</p><p>(1) <span style="color: red;">初始化DB对象</span>：有clone属性的定义，在后续链式操作中起到比较重要的作用。clone:初始创建的DB为1，分裂创建Session之后Session是1 ，如果会话为DEBUG模式则为2。</p><p>(2) <span style="color: red;">初始化callback </span>：callback为gorm的核心，后续所有的crud操作都是基于callback实现，默认初始化：create、query、update、delete、row、raw基础实现。</p><h2 id="3-2-链式调用"><a href="#3-2-链式调用" class="headerlink" title="3.2 链式调用"></a>3.2 链式调用</h2><p>在gorm中通过builder设计模式（适用多个简单对象分步骤构建一个复杂的对象）完成核心对象中Statement属性生成。主要基于如下两个api：</p><p>(1) <span style="color: red;">chainable_api.go</span> ：通过适配数据库关键字的函数生成sql元数据，如：select、where、join、group等sql子句关键字<br><img src="/../images/10.png" alt="10.png"><br>例如在上述Select的函数中可设置查询列值，不调用Select则默认查询表所有列</p><p>(2) <span style="color: red;">finisher_api.go</span>：通过执行最终组装好的Sql处理响应结果，如：Find、Update、Save等类似DML语句的关键字<br><img src="/../images/11.png" alt="11.png"><br>在Find函数中处理查询结果映射的结构体数据。</p><p>在学习源码过程中会发现，无论是chainable 还是 finisher 中几乎所有函数都会包含这样一行代码：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tx = db.getInstance()</span><br></pre></td></tr></table></figure><p>来看看里面的实现细节：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> getInstance() *DB &#123;</span><br><span class="line"><span class="keyword">if</span> db.clone &gt; <span class="number">0</span> &#123;</span><br><span class="line">tx := &amp;DB&#123;Config: db.Config, Error: db.Error&#125;</span><br><span class="line"><span class="keyword">if</span> db.clone == <span class="number">1</span> &#123;</span><br><span class="line"><span class="comment">// clone with new statement</span></span><br><span class="line">tx.Statement = &amp;Statement&#123;</span><br><span class="line">DB:       tx,</span><br><span class="line">ConnPool: db.Statement.ConnPool,</span><br><span class="line">Context:  db.Statement.Context,</span><br><span class="line">Clauses:  <span class="keyword">map</span>[<span class="type">string</span>]clause.Clause&#123;&#125;,</span><br><span class="line">Vars:     <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="number">8</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// with clone statement</span></span><br><span class="line">tx.Statement = db.Statement.clone()</span><br><span class="line">tx.Statement.DB = tx</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以发现在该函数中便利用到了初始化时设置的clone属性，简单来说该函数是为了在链式调用过程中获取当前的gorm实例对象从而保证在链式操作中的一致性。</p><h2 id="3-3-数据解析"><a href="#3-3-数据解析" class="headerlink" title="3.3 数据解析"></a>3.3 数据解析</h2><p>通过链式调用生成sql元数据后，如何将数据库的执行结果映射到结构体中？</p><p>回到刚刚 finisher 中的 Find 函数最后的Execute的调用会包含以下步骤：<br><img src="/../images/12.png" alt="12.png"></p><p>gorm在通过反射方法解析结构体（User对象）过程中主要生成的是 Schema 对象，该对象中主要包含结构体与数据库表的映射关系，以及如：关联约束、自定义表名、回调开关等。<br><img src="/../images/13.png" alt="13.png"></p><h2 id="3-4-callback执行"><a href="#3-4-callback执行" class="headerlink" title="3.4 callback执行"></a>3.4 callback执行</h2><p>(1) 在 Execute 中可以发现完成结构体解析后，会有如下一段看上去非常简单的代码：<br><img src="/../images/14.png" alt="14.png"></p><p>此处其实是与初始化callback中联系起来，会将前置所生成的Statement对象中的sql元数据提供给具体的callback生成最终数据库认可的sql语句，完成执行并扫描响应结果。</p><p>之所以是for循环执行是因为在业务开发中我们可自行扩展例如：<span style="color: red;">BeforeCreate、BeforeDelete、AfterCreate </span>等自定义的callback，gorm会将当前DML类型中的callback排好顺序依次进行调用。</p><p>(2) callback结构：<br><img src="/../images/15.png" alt="15.png"></p><p><span style="color: red;">db.callbacks</span>：gorm全局对象db的callback的map集合，包含CRUD基础场景和自定义的callback。</p><p><span style="color: red;">processor.callbacks</span>：只包含某一场景的多个callback实现，例如：Query场景包含：query、preload、after_query</p><p>(3) 在默认注册Callbacks函数中，除查询外的Create、Update、Delete相关的操作均会默认注册事务相关callback。所以当业务中默认实现了如：BeforeCreate、BeforeDelete、AfterCreate等callback时，默认是存在同一事务当中。也可通过Config中的 <span style="color: red;">SkipDefaultTransaction&#x3D;false</span>  关闭<br><img src="/../images/16.png" alt="16.png"></p><h2 id="3-4-结果映射"><a href="#3-4-结果映射" class="headerlink" title="3.4 结果映射"></a>3.4 结果映射</h2><p>query.go 中是具体查询的实现，包括</p><p>(1) 根据Statemnt和目标结构体解析的Schema对象构建Sql</p><p>(2) 执行Sql</p><p>(3) 根据Schema的映射关系将sql结果Scan到目标对象中。<br><img src="/../images/17.png" alt="17.png"><br>至此通过gorm完成了一次简单的查询，其中如果有更加复杂的sql也可以使用chaniable 中提供的函数实现进行sql的组装。</p><h1 id="4、如何实现动态表名"><a href="#4、如何实现动态表名" class="headerlink" title="4、如何实现动态表名"></a>4、如何实现动态表名</h1><p>在自己写一些简单案例同时具有分表的场景中，可能存在多个数据表映射同一个数据对象，如何做到动态表名映射？</p><p>在gorm默认解析过程中如果 <span style="color: red;"> Statement对象中Table为空 </span>，则使用从结构体中解析出的表名（默认为结构体实现的TableName方法），用于后续构建Sql所需 。同时为了结构体解析过程中尽量不损耗性能，所以使用了内存缓存，当某结构体已生成Schema对象后，则默认使用缓存中的该对象。所以结构体实现的TableName() 函数只会调用一次。<br><img src="/../images/18.png" alt="18.png"></p><p>从解析的源码中不难发现，如果可以手动设置Statement对象的Table就可以解决这个问题，基于此gorm在chaniable 中提供Table函数供开发人员可自行设置Statement中的Table，而不依赖解析结构体。</p><p><img src="/../images/19.png" alt="19.png"></p><h1 id="5、callback应用-自定义callback"><a href="#5、callback应用-自定义callback" class="headerlink" title="5、callback应用&amp;自定义callback"></a>5、callback应用&amp;自定义callback</h1><p>(1) BeforeUpdate 是gorm默认提供的一种场景，无需自定义注册，只需业务对象结构体实现该方法即可。</p><p>gorm 提供了 <span style="color: red;"> Changed </span>方法，可以用在这里，它会返回检查字段是否有变更。且Changed 方法只与 Update、Updates 方法一起使用，只检查 Model 对象字段的值与将要更新的值是否相等，如果有变更，且字段没有被忽略，则返回 true，业务可依此特性应用。<br><img src="/../images/20.png" alt="20.png"><br><img src="/../images/21.png" alt="21.png"></p><p>(2) gorm 提供基于默认Create、Query、Update、Delete、Row、Raw 自定义注册callback，同时可以指定自定义callback的顺序。在自定义callback中可通过db.Statement 获取当前实体与数据库映射的数据。如下：<br><img src="/../images/22.png" alt="22.png"></p><h1 id="6、连接池"><a href="#6、连接池" class="headerlink" title="6、连接池"></a>6、连接池</h1><p>(1) gorm在连接池依旧是基于 database&#x2F;sql 的实现，简单概述：<br><img src="/../images/23.png" alt="23.png"></p><p>freeConn：空闲连接池    connRequests：等待池</p><p>getConn(获取连接)：</p><ul><li>首先检查空闲连接池是否有连接，若有，则检查该连接是否超时，若没超时，则返回该连接。</li><li>若空闲连接池无连接，检查是否超过最大连接数，若超过则放入等待队列，否则新建连接返回。</li></ul><p>putConn(释放连接)：</p><ul><li>首先检查connRequests等待池中，是否有阻塞的请求</li><li>若有，则将该connection给它，向channel中发数据，阻塞的连接请求就可以拿到连接</li><li>否则，则判断是否到达最大空闲连接数，若无则将连接放至freeConn空闲连接池中，否则将连接关闭<br>同时底层会单独创建协程检查空间连接池中的连接是否超时，若超时则会回收这部分连接。</li></ul><p>(2) 异常处理：在日常业务运行时，经常会遇到以下关于连接池的异常</p><ul><li>TIME_WAIT</li></ul><p>可能原因：maxIdleConn &lt;&lt; maxOpenCount，应用瞬时打开较大的连接数，而无法放入空闲池被关闭。</p><p>解决方案：不要采用默认连接配置，default maxIdleConn &#x3D; 2</p><p>maxIdleConn &lt; maxOpenCount，常驻同数据库交互的goroutine 约等于 maxIdleConn</p><ul><li>invalid connection</li></ul><p>可能原因：mysql wait_timeout &lt; maxLifeTime，连接有效时长大于数据库最大等待时长</p><p>解决方案：合理配置数据库的wait_timeout时间，数据库默认wait_timeout &#x3D; 28800</p><p>maxLifeTime &lt; mysql wait_timeout</p><h1 id="7、性能"><a href="#7、性能" class="headerlink" title="7、性能"></a>7、性能</h1><p>性能一直是ORM框架逃不开的话题，各种ORM框架都需要处理对象结构体与数据库表关系映射的反射解析、Sql的拼装等环节都可能造成一些性能的损耗。基于此本人简单对比了一下原生sql、sqlx、gorm在普通查询时的性能数据，如下：</p><p>(1) 硬件：Apple M1  16G</p><p>(2) 连接池配置：MaxOpenConn：300  MaxIdleConn：100</p><p>(3) 测试场景：分别测试 表数据在 20w 和 50w 情况下，查询100、500、1000条数据下的性能对比（简单sql）</p><p>20W 表数据：<br><img src="/../images/24.png" alt="24.png"></p><p>50W表数据：<br><img src="/../images/25.png" alt="25.png"></p><p>通过对比可以初步发现，在简单sql情况下查询响应时间上orm框架会比原声sql表现好一些，但是在内存分配上来说，适用orm框架由于多了许多数据层的操作，均是使用原生sql的好几倍，同时gorm会比sqlx占用内存更高。</p><p>ps：此处性能对比场景比较简单，并不一定代表整体性能上ORM框架会比原生sql更优秀。</p><h1 id="8、其他特性"><a href="#8、其他特性" class="headerlink" title="8、其他特性"></a>8、其他特性</h1><h2 id="8-1-Context-与-Session"><a href="#8-1-Context-与-Session" class="headerlink" title="8.1 Context 与 Session"></a>8.1 Context 与 Session</h2><p>(1) gorm通过WithContext方法提供对context 的支持，通过context可实现诸多业务场景，例如：sql级别的日志监控等<br><img src="/../images/26.png" alt="26.png"></p><p>(2) gorm中Session方法，允许创建带个性化配置的会话模式，如通过设置PrepareStmt进行Sql缓存。<br><img src="/../images/27.png" alt="27.png"></p><h2 id="8-2-事务处理"><a href="#8-2-事务处理" class="headerlink" title="8.2 事务处理"></a>8.2 事务处理</h2><p>(1) gorm支持嵌套事务、手动事务、SavePoint与RollbackTo等场景，同时可通过SkipDefaultTransaction配置是否开启事务。<br><img src="/../images/28.png" alt="28.png"><br><img src="/../images/29.png" alt="29.png"></p><h2 id="8-3-sql注入"><a href="#8-3-sql注入" class="headerlink" title="8.3 sql注入"></a>8.3 sql注入</h2><p>gorm使用 database&#x2F;sql 的参数占位符来构造 SQL 语句，这可以自动转义参数，避免 SQL 注入数据。但是在某些特殊的链式调用函数中需要谨慎处理，如下：<br><img src="/../images/30.png" alt="30.png"></p><h1 id="9、总结"><a href="#9、总结" class="headerlink" title="9、总结"></a>9、总结</h1><p>(1) ORM理论下期望能够承接一切从业务层到数据库层的操作，以一种标准化的方式获取数据，就像操作具体对象一样<br><img src="/../images/31.png" alt="31.png"></p><p>优点：</p><ul><li>节省手工从元数据映射到模型的成本</li><li>支持加载关联对象</li><li>不用编写重复且基础的SQL、不用管理事务、数据库连接</li></ul><p>缺点：</p><ul><li>元数据映射时类型难以匹配，比如枚举，日期等，大量字段映射时可能会造成性能瓶颈</li><li>自动编写的SQL可能存在性能缺陷且难以优化</li><li>复杂的连表查询，使用模型化的查询无法满足，容易导致慢查询</li></ul><p>往往在业务开发中使用 orm + sql 情况比较多，目前大多数orm库都支持原生sql的执行，用于满足复杂sql的场景。</p><p>(2)  个人认为目前各开发语言中的orm库除了满足其基础的对象关系映射和sql封装之外，给开发人员更大的作用是将数据处理层与业务处理层进行解耦，<span style="color: red;"> 利用各种特性（拦截器、callback等）</span>引导我们将数据处理逻辑独立出来。</p><p>大多数业务场景中的增、删、改操作对于gorm处理起来比较简单，基本为单实体的操作，往往查询面临复杂对象的映射使用orm框架处理比较困难。所以目前在比较火热的 <span style="color: red;"> DDD方法论中提出 CQRS（Command Query Responsibility Segregation） 模式</span>，该模式提倡将系统中的操作分为两类，即命令(Command) 与查询(Query)。</p><ul><li>命令则是对会引起数据发生变化操作的总称，可以理解为gorm的DML类语句中的新增，更新，删除这些操作，都是命令。</li><li>查询则和字面意思一样，即不会对数据产生变化的操作，只是按照某些条件查找数据。</li></ul><p>gorm作为一个orm层框架能在一定程度上提升开发效率，但是业务系统复杂多变某个框架或者某种设计模式很难做到面面俱到，开发人员要做的便是取其精华。</p><p>补充：以上是个人在学习gorm过程中一些总结，有理解不到到位的地方欢迎批评指正，一起交流。</p><h1 id="10、参考"><a href="#10、参考" class="headerlink" title="10、参考"></a>10、参考</h1><p><a href="https://gorm.cn/zh_CN/docs/migration.html">https://gorm.cn/zh_CN/docs/migration.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;作为golang中代表性的orm框架，它是如何实现的？有哪些特点？如何利用它提升开发效率？&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;1、GORM概述&quot;&gt;&lt;a href=&quot;#1、GORM概述&quot; class=&quot;headerlink&quot; tit</summary>
      
    
    
    
    
    <category term="golang、gorm、mysql、链式编程" scheme="http://example.com/tags/golang%E3%80%81gorm%E3%80%81mysql%E3%80%81%E9%93%BE%E5%BC%8F%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Es多层级数据建模案例</title>
    <link href="http://example.com/2024/03/07/Es%E5%A4%9A%E5%B1%82%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%A1%88%E4%BE%8B/"/>
    <id>http://example.com/2024/03/07/Es%E5%A4%9A%E5%B1%82%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%A1%88%E4%BE%8B/</id>
    <published>2024-03-07T11:26:01.000Z</published>
    <updated>2024-03-07T11:58:59.859Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h1><p>近期组里上线新版本，其中涉及到多表数据关联查询场景。直接查询数据库表SQL比较复杂，且查询列表中无更新数据操作，仅供查询。为了避免日后数据增长带来的性能问题，同时可容忍短时间内的数据延迟，所以此处查询使用Es实现。</p><p>数据库表结构（简单说明）：</p><p><img src="/../images/1.png" alt="4.png"></p><p>实际场景中可能存在类似上述多层级的一对多的关联关系，本文中简单提取 创作者-账号 的一对多的关系为案例。</p><h1 id="2-Es数据结构"><a href="#2-Es数据结构" class="headerlink" title="2. Es数据结构"></a>2. Es数据结构</h1><p>Es并非 <span style="color: red;">关系型数据库</span>，Es是<span style="color: red;"> 扁平化的存储结构 </span>。索引是独立文档的集合体。不同的索引之间一般是没有关系的。并不擅长关系型数据库中的join操作，此时<span style="color: red;"> 如何解决作者总查询中的多维度条件嵌套对象的数据查询？</span></p><h2 id="2-1-普通对象"><a href="#2-1-普通对象" class="headerlink" title="2.1 普通对象"></a>2.1 普通对象</h2><p>(1) 此种对象存储方式是最常用的方法，通过应用层组装好数据对象最终存储到Es对应索引中。所以如果用普通的内部对象存储创作者与账号的数据，Es中可以这样存储：<br>创建索引：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                           </span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                         </span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>新增数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_index/_doc/<span class="number">12345678</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;这是一个创作者&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(2) 该对象查询时很高效，可直接查询创作者主体和关联的账号信息，但是存在另一个致命的缺点，当查询涉及关联账号条件时，会出现如下情况：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>按照最初存储的数据对象，以上查询不应该查结果，因为账号Name为Paul的对应platformId应该是 2，实际上却能查出结果，如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.6931472</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.6931472</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;userCommonId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;这是一个创作者&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(3) 上述问题的原因在于Es中存储嵌套数据时，会将该对象扁平化处理，此时便失去了最初存储时的关联关系结构，如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span><span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span><span class="string">&quot;这是一个创作者&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;john&quot;</span><span class="punctuation">,</span><span class="string">&quot;paul&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;accounts.accountId&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;ks7897389832&quot;</span><span class="punctuation">,</span><span class="string">&quot;dy7897389832&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="2-2-嵌套对象"><a href="#2-2-嵌套对象" class="headerlink" title="2.2 嵌套对象"></a>2.2 嵌套对象</h2><p>很明显上面对象数组的方案没有处理好内部对象的边界问题，JSON数组对象被ES强行存储成扁平化的键值对列表。为了解决这个问题，ES推出了一种嵌套对象的方案来适配多层级的数据结构。<br>(1) 创建嵌套索引：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_nested_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span>                               <span class="comment">//嵌套类型标识</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;platform_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;account_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>创建嵌套数据对象accounts属性是nested，表示是个内嵌文档。</p><p>(2) 新增嵌套对象数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_nested_index/_doc/<span class="number">123456789</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;userCommonId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;创作者111&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;Wade&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;wb7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;James&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span>     <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;xhs7897389832&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(3) 类似使用普通内部对象查询name为Paul且platformId为1的数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                                    <span class="comment">//嵌套查询</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span>  <span class="number">1</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>以上查询结果即为空，对于nested对象，es会将其抽取出来作为独立的文档，并保留文档之间的关联关系，在查询时，把相应文档关联起来。结合创作者主体（父级）与嵌套账号（子级）查询：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;创作者&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>命中结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_nested_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;userCommonId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;这是一个创作者&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span>                            <span class="comment">//命中数据</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(4) 嵌套聚合：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;byplatform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts.platformId&quot;</span>                  <span class="comment">//嵌套数据聚合，根据子级account的platformId分组聚合</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;byuserId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;reverse_nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>                           <span class="comment">//回到父级author文档进行操作</span></span><br><span class="line">                  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;userCommonId&quot;</span>               <span class="comment">//根据父级userCommonId进行分组</span></span><br><span class="line">                      <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                 <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                                    <span class="comment">//子级聚合标识</span></span><br><span class="line">      <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span>                                                <span class="comment">//命中文档总数</span></span><br><span class="line">      <span class="attr">&quot;byplatform&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                 <span class="comment">//子级platformId的分组结果    </span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span>                                                <span class="comment">//platfromId = 3 的总数为 2</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                        <span class="comment">//父级userCommonId分组结果</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;byuserId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;userId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="2-3-父子文档"><a href="#2-3-父子文档" class="headerlink" title="2.3 父子文档"></a>2.3 父子文档</h2><p>Es并不是只有上述嵌套文档来支持业务场景中多层级的数据结构，嵌套文档在查询性能与数据更新上有部分缺点（后面说明），另外Es还提供父子文档的数据结构来支持嵌套数据结构。<br>(1) 创建父子文档索引：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_join_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;author_account_join&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;join&quot;</span><span class="punctuation">,</span>                                 <span class="comment">//定义父子文档类型</span></span><br><span class="line">        <span class="attr">&quot;relations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>首先定义父子文档的关联关系，join关键字表示这是一个父子文档关系，relations里面表示author是父，account是子。</p><p>(2) 创建父文档数据:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_join_index/_doc/<span class="number">123456789</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;user_common_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;创作者222&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author_account_join&quot;</span><span class="punctuation">:</span> <span class="string">&quot;author&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>author_account_join 字段需要指定该数据对象属于父</p><p>(3) 创建子文档数据:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /author_account_join_index/_doc/james44?routing=<span class="number">123456789</span>&amp;refresh</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;accountId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;james44&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;james&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author_account_join&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="number">123456789</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>首先 <span style="color: red;"> routing </span>关键字指明了路由的id是父文档123456789， author_account_join字段标识该数据对象属于账号（子级），同时指定父文档的ID<br><span style="color: red;"> 注意：索引子文档的时候，routing是必须的，因为要确保子文档和父文档在同一个分片上。</span></p><p>(4) 父子文档数据片段：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;user_common_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;创作者222&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"> ......</span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;wade33&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123456789&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;wade33&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;wade&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">123456789</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure><p>从数据片段可以看出，父、子文档具备各自唯一id，无论是父文档还是子文档都是独立的数据对象，这点与跟嵌套对象nested不一样</p><p>(5) 子文档数据查询:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>以上查询为空，若将platformId查询参数替换为2，则查询出对应数据，但由于父子文档互相独立，所以查询结果返回的是子文档对应数据，并且展示该子文档的父文档标识，如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.7917595</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.7917595</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(6) Has Child 查询,返回符合查询条件的父文档数据，通过inner_hits带出子文档数据:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;has_child&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                      <span class="comment">//父文档数据</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;user_common_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;创作者111&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inner_hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.7917595</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                            <span class="comment">//子文档数据</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.7917595</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(7) Has Parent 查询，返回符合条件的相关的子文档:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;has_parent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;parent_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;author&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;创作者111&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test11&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test11&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;测试账号11&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_join_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_routing&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul22&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;author_account_join&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span> <span class="punctuation">:</span> <span class="number">12345678</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(8) 子文档聚合：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_join_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nickname&quot;</span>               <span class="comment">//通过父文档的nickname字段分组            </span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                          </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;platformId&quot;</span>    <span class="comment">//以不同的platformId来进行聚合        </span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                 <span class="comment">//nickname 聚合结果</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;创作者111&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                        <span class="comment">//父文档下不同子文档 platformId 的聚合结果</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>                              </span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;创作者222&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                      <span class="comment">//父文档下不同子文档 platformId 的聚合结果</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><span style="color: red;">注意：在父-子文档中支持子文档聚合，与嵌套对象的聚合类似。但是，对于父文档的聚合查询是不支持（如 嵌套对象中 reverse_nested）</span></p><h2 id="2-4-对比"><a href="#2-4-对比" class="headerlink" title="2.4 对比"></a>2.4 对比</h2><p>此处主要对比嵌套对象和父子文档，普通对象不做过多说明</p><h3 id="2-4-1-嵌套对象"><a href="#2-4-1-嵌套对象" class="headerlink" title="2.4.1 嵌套对象"></a>2.4.1 嵌套对象</h3><p>(1) 当对嵌套文档做增加、修改或者删除时，不能仅修改父级数据或子级数据，整个文档都要重新被索引。嵌套文档越多，这带来的成本就越大。</p><p>(2) 嵌套查询结果返回的是整个文档，而不仅仅是匹配的嵌套文档。目前还不支持只返回根文档中最佳匹配的嵌套文档。但是可以利用 <span style="color: red;"> inner_hits </span> 获取内部命中数据，如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                                    </span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;accounts.platformId&quot;</span><span class="punctuation">:</span>  <span class="number">2</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inner_hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>                                             <span class="comment">// 内部命中标识</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>                                                <span class="comment">//主文档命中数量</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>                                                   <span class="comment">//命中数据，包含父级数据和子级数据</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_nested_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;userCommonId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;nickname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;这是一个创作者&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ks7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inner_hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>                                        <span class="comment">//内部命中标识</span></span><br><span class="line">          <span class="attr">&quot;accounts&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;author_account_nested_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;12345678&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_nested&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.3862944</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>                               <span class="comment">//内部命中子级数据</span></span><br><span class="line">                    <span class="attr">&quot;accountId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dy7897389832&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Paul&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;platformId&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(3) 文档数量：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_count</span><br><span class="line">结果：</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span>               <span class="comment">//主文档总数</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">GET _cat/indices/author_account_nested_index</span><br><span class="line">结果：</span><br></pre></td></tr></table></figure><p><img src="/../images/2.png" alt="5.png"><br>对于第一种查询方式直接获取的是Es返回的文档数量，第二种查询方式返回的是底层lucene存储的文档数量，这其中包含了主文档和隐藏文档（nested 对象文档），实际上对于嵌套文档查询时，Es内部辅助做了类似join的处理。</p><h3 id="2-4-2-父子文档"><a href="#2-4-2-父子文档" class="headerlink" title="2.4.2 父子文档"></a>2.4.2 父子文档</h3><p>(1) 父子文档为互相独立的文档存储，对文档做增加、删除或者修改的时候互不影响。</p><p>(2) 查询联合越多，性能越差。同时每一代的父文档都要将其字符串类型的 _id 字段存储在内存中，这会占用大量内存。</p><p>(3) 创建子文档数据时，需要结合routing和父文档Id将父子文档存储在同一个分片上，子文档数据依旧可再加多层级，只是此时routing值为根文档id。</p><p><span style="color: red;"> 注意：如果需要改变一个子文档所属父文档ID值，仅更新这个子文档的父标识是不够的，因为新的父文档有可能在另外一个分片上。因此必须要先把子文档删除，然后再重新索引这个子文档。</span></p><h3 id="2-4-3-总结"><a href="#2-4-3-总结" class="headerlink" title="2.4.3 总结"></a>2.4.3 总结</h3><p>(1) 嵌套对象通过冗余数据来适配多层级数据结构，但是由于更新机制更适用于读多写少的场景。父子文档类似关系型数据库中的关联关系，减少了文档修改范围，适用于写多的场景。</p><p>(2) 嵌套对象在只有一个主要实体时非常有用（如博客与评论的关系，通过评论内容搜索博客文章），但是需要主文档和其关联实体之间做一个完整的隔离时，父子文档更加合适。</p><p>(3) 在分级审核需求的作者总查询中，由于查询条件涉及创作者（父）、账号（子）的查询条件，同时分页维度为创作者维度，对比考虑嵌套对象更适用。</p><h3 id="2-4-4-注意事项："><a href="#2-4-4-注意事项：" class="headerlink" title="2.4.4 注意事项："></a>2.4.4 注意事项：</h3><p>(1) 无论是嵌套对象还是父子文档，其在底层存储上都有一定约束，虽然Es支持这样多层级的数据结构，但是不建议业务上使用时无限递增层级，尽量在对子级命中有要求、数据层级可控范围内使用，<br>否则可能会造成性能问题得不偿失。嵌套对象可通过以下方式，设置嵌套的层级约束：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /author_account_nested_index/_settings</span><br><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;index.mapping.nested_fields.limit&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span>                  <span class="comment">// 一个索引中不同的 Nested 字段类型个数             </span></span><br><span class="line">  <span class="attr">&quot;index.mapping.nested_objects.limit&quot;</span><span class="punctuation">:</span> <span class="number">100</span>                 <span class="comment">// 一个 Nested 字段中对象数目  </span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>(2) 普通查询中嵌套文档返回的时匹配的整个文档数据，父子文档查询时Has Child 和 Has Parent查询的是单个父文档或子文档，所以上述案例中使用 inner_hits 辅助查询，但是 inner_hits 关键字慎用，容易造成性能问题，<br>根据不同业务场景嵌套文档的数据过滤和关联查询可放在应用层做。</p><h1 id="3-Es数据存储"><a href="#3-Es数据存储" class="headerlink" title="3.Es数据存储"></a>3.Es数据存储</h1><p>在上面提到父子文档在使用时需要注意使用routing来控制数据存储的分片，继续了解下Es中分布式文档存储的概念。</p><h2 id="3-1-分布式文档存储"><a href="#3-1-分布式文档存储" class="headerlink" title="3.1 分布式文档存储"></a>3.1 分布式文档存储</h2><p>一个 Lucene 索引 在 Elasticsearch 称作分片。 一个 Elasticsearch 索引是分片的集合。</p><p>当 Elasticsearch 在索引中搜索的时候， 发送查询到每一个属于索引的分片(Lucene 索引)，然后合并每个分片的结果到一个全局的结果集。</p><p>(1) 分片：</p><ul><li>Elasticsearch 索引由一个或多个主分片以及零个或者多个副本分片组成</li><li>分片可以拆分并扩展数据，分片包含索引数据的子集，并且本身具有完整的功能和独立性</li><li>操作可以分布在多个节点上，通过并行提高性能</li></ul><p>(2) 主分片、副本分片</p><ul><li>数据写入、恢复阶段均会在主分片上执行，成功后再到副本分片上执行</li><li>副本分片永远不会与主分片在同一个节点上，主要作用是提升集群的高可用与查询性能<br><img src="/../images/3.png" alt="6.png"></li></ul><p>(3) 分片存储规则：<span style="color: red;"> shard &#x3D; hash(routing) % number_of_primary_shards </span><br>routing：默认是文档ID，也可以自定义（父子文档中通过定义该值强制使子文档与父文档在同一个分片上）<br>number_of_primary_shards：主分片数量<br>所有文档的API（get、index、delete、bulk、update等）都支持routing的路由参数，通过这个参数我们可以自定义文档到分片的映射。</p><p>(4) 新建、删除某个文档</p><p><img src="/../images/4.png" alt="7.png"></p><ol><li>主协调节点接收客户端请求。</li><li>根据_id确定文档属于分片 0 。请求会被转发到Node 3，因为分片 0 的主分片被分配在Node 3上。</li><li>主分片执行客户端请求，若执行成功则转发该请求到副本分片所在节点，均执行成功后Node 3告知协调节点成功并返回客户端。</li></ol><p>(5) 获取某文档<br>由于分片机制，可以从主分片或者从其它任意副本分片检索文档<br><img src="/../images/5.png" alt="8.png"></p><ol><li>主协调节点接收客户端请求</li><li>通过文档 _id 计算属于分片0，此时分片0的副本分片和主分片存在与所有三个节点上，所以<span style="color: red;"> 默认轮询机制 </span>下，请求被转发到Node 2</li><li>Node 2 将获取文档结果返回给Node 1，最终返回给客户端</li></ol><p>(6) 一致性处理：<br>为了避免发生网络分区故障时进行写操作时，导致数据不一致，Es在进行写操作时可设置 consistency（一致性）参数。约束规则如下：</p><p>在进行写操作之前，主分片要求必须有”规定数量“的分片副本（包括主分片或副本分片）处于可用状态时，才可成功执行本次的写操作。</p><p><span style="color: red;"> quorum（规定数量）</span> &#x3D; （primary + number_of_replicas）&#x2F; 2 + 1</p><p>consistency 参数值可为：one（只要主分片状态OK就允许执行写操作）、all（必须要所有主分片和副本分片状态可用才允许执行）、quorum（默认值、规定数量的分片状态可用即可）</p><p>以上是简单的使用案例，Es是个功能复杂的搜索引擎，不同的业务场景有不同的使用方式，同时需要随着业务的发展不断优化。欢迎纠错。</p><h1 id="4-参考"><a href="#4-参考" class="headerlink" title="4. 参考"></a>4. 参考</h1><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/joining-queries.html">Elasticsearch Guide [7.17]-Joining queries</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/distributed-docs.html">Elasticsearch Guide [7.17]-Distributed Document Store</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-背景&quot;&gt;&lt;a href=&quot;#1-背景&quot; class=&quot;headerlink&quot; title=&quot;1.背景&quot;&gt;&lt;/a&gt;1.背景&lt;/h1&gt;&lt;p&gt;近期组里上线新版本，其中涉及到多表数据关联查询场景。直接查询数据库表SQL比较复杂，且查询列表中无更新数据操作，仅供查询。为</summary>
      
    
    
    
    
    <category term="elasticsearch、数据建模" scheme="http://example.com/tags/elasticsearch%E3%80%81%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://example.com/2024/03/07/hello-world/"/>
    <id>http://example.com/2024/03/07/hello-world/</id>
    <published>2024-03-07T08:59:41.163Z</published>
    <updated>2024-03-07T08:59:41.163Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for</summary>
      
    
    
    
    
  </entry>
  
</feed>
